<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temporary Works Risk & Safety Assessment Tool</title>
    <!-- PDF.js Library for PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        /* --- Modern CSS Variables --- */
        :root {
            --primary: #2563eb; /* Vivid Blue */
            --primary-hover: #1d4ed8;
            --primary-light: #eff6ff;
            --secondary: #64748b;
            --accent: #f59e0b; /* Amber for Favorites */
            
            --bg-body: #f1f5f9;
            --bg-surface: #ffffff;
            
            --text-main: #0f172a;
            --text-sub: #475569;
            
            --border-color: #e2e8f0;
            --border-hover: #cbd5e1;
            
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;

            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        /* --- Base Reset & Typography --- */
        * { box-sizing: border-box; }
        body { 
          font-family: 'Inter', system-ui, -apple-system, sans-serif; 
          background: radial-gradient(circle at top left, #f8fafc 0%, #eef2f7 35%, #e2e8f0 100%);
          min-height: 100vh;
          color: var(--text-main); 
          margin: 0; 
          padding: 20px; 
          line-height: 1.65; 
          -webkit-font-smoothing: antialiased;
          text-rendering: optimizeLegibility;
        }
        body::before {
          content: '';
          position: fixed;
          inset: 0;
          background-image: radial-gradient(circle at 1px 1px, rgba(15, 23, 42, 0.08) 1px, transparent 0);
          background-size: 140px 140px;
          opacity: 0.35;
          pointer-events: none;
          z-index: 0;
        }

        h1, h2, h3, h4, h5, h6 { margin: 0 0 1rem 0; font-weight: 800; color: #1e293b; letter-spacing: -0.025em; }
        p { margin: 0 0 1rem 0; color: var(--text-sub); }

        /* --- Layout --- */
        .container { 
            max-width: 1280px; 
            margin: 0 auto; 
            background: linear-gradient(180deg, #ffffff 0%, #fbfdff 100%); 
          display: flex;
          flex-direction: column;
          min-height: calc(100vh - 40px);
            padding: 40px 48px; 
            box-shadow: var(--shadow-xl); 
            border-radius: var(--radius-lg); 
            position: relative;
          z-index: 1;
            border: 1px solid rgba(255,255,255,0.7);
        }

        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 40px; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 24px; 
        }
        .header h1 { 
            font-size: 1.75rem; 
            color: var(--primary); 
            letter-spacing: -0.025em; 
            margin-bottom: 0.5rem;
        }
        .header p { font-size: 1.05rem; }

        /* --- Components: Buttons --- */
        .btn { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            padding: 12px 24px; 
            font-weight: 600; 
            text-align: center; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            border: 1px solid transparent; 
            font-size: 0.95rem; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            background: var(--primary); 
            color: white; 
            box-shadow: var(--shadow-sm); 
            text-decoration: none;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn:hover { 
            background: var(--primary-hover); 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-md); 
        }
        .btn:active { 
            transform: translateY(0); 
            box-shadow: var(--shadow-sm);
        }
        
        .btn-outline { 
            background: white; 
            border: 1px solid var(--border-color); 
            color: var(--text-main); 
            box-shadow: var(--shadow-xs);
        }
        .btn-outline:hover { 
            background: #f1f5f9; 
            border-color: #cbd5e1; 
            color: #0f172a;
        }

        .btn-link { 
            display: inline-flex; 
            align-items: center; 
            gap: 6px; 
            color: var(--primary); 
            font-weight: 600; 
            background: transparent; 
            padding: 8px 12px; 
            border-radius: var(--radius-sm);
            box-shadow: none;
            border: none;
        }
        .btn-link:hover { background: var(--primary-light); text-decoration: none; }
        
        .btn-auto { width: auto; min-width: 120px; }

        /* --- Components: Forms --- */
        .form-group { margin-bottom: 16px; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            font-size: 0.9rem; 
            color: #334155;
        }
        .form-group input, .form-group select { 
          width: 100%; 
          padding: 10px 12px; 
          border: 1px solid var(--border-color); 
          border-radius: var(--radius-sm); 
          font-size: 0.95rem; 
          background: #fff;
          transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s;
        }
        .form-group input:focus, .form-group select:focus { 
          outline: none; 
          border-color: var(--primary); 
          box-shadow: 0 0 0 3px rgba(15, 82, 186, 0.15); 
          transform: translateY(-1px);
        }
        .input-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 20px; 
            margin-bottom: 24px; 
        }
        .readonly { background: #f8fafc; color: var(--text-sub); pointer-events: none; border-color: #e2e8f0; }

        /* --- Components: Cards & Panels --- */
        .panel { 
          background: white; 
          border: 1px solid var(--border-color); 
          padding: 24px; 
          border-radius: var(--radius-md); 
          box-shadow: var(--shadow-sm);
          transition: box-shadow 0.2s ease, transform 0.2s ease;
        }
        .panel:hover { box-shadow: var(--shadow-md); transform: translateY(-1px); }
        .filter-panel { 
            background: #f8fafc; 
            border: 1px solid var(--border-color);
            padding: 24px; 
            border-radius: var(--radius-md); 
            margin-bottom: 32px; 
        }
        .filter-note { font-size: 0.85rem; color: var(--text-sub); margin-top: 12px; display: block; }

        /* --- Stage Progress Indicator --- */
        .stage-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            padding: 16px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            border: 1px solid #cbd5e1;
        }
        .stage-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-weight: 700;
            font-size: 0.9rem;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3);
        }
        .stage-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #0f172a;
        }

        .made-by-badge {
          position: fixed;
          top: 20px;
          right: 20px;
          background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
          color: white;
          padding: 8px 16px;
          border-radius: 20px;
          font-size: 0.85rem;
          font-weight: 600;
          box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
          display: flex;
          align-items: center;
          gap: 8px;
          z-index: 1000;
          transition: all 0.3s ease, opacity 1s ease;
          border: 1px solid rgba(255, 255, 255, 0.2);
          opacity: 1;
        }
        .made-by-badge.hidden {
          opacity: 0;
          pointer-events: none;
        }
        .made-by-badge:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
        }
        .made-by-badge .author-icon {
          font-size: 1.1rem;
        }
        .made-by-badge .author-name {
          letter-spacing: 0.02em;
        }
        @media print {
          .made-by-badge {
            display: none;
          }
        }

        .app-footer {
          margin-top: auto;
          padding-top: 16px;
          padding-bottom: 4px;
          padding-top: 16px;
          border-top: 1px solid var(--border-color);
          text-align: center;
          color: #94a3b8;
          font-size: 0.95rem;
          letter-spacing: 0.01em;
        }

        /* --- Filter Buttons --- */
        .filter-group { margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border-color); }
        .filter-group-title { font-size: 0.9rem; font-weight: 700; color: #334155; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
        .filter-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .filter-btn { 
            padding: 8px 14px; 
            border: 1px solid var(--border-color); 
            background: white; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            cursor: pointer; 
            transition: all 0.2s;
            color: #334155;
            font-weight: 500;
        }
        .filter-btn:hover { 
            border-color: var(--primary); 
            background: var(--primary-light); 
            color: var(--primary);
        }
        .filter-btn.active { 
            background: var(--primary); 
            color: white; 
            border-color: var(--primary); 
        }
        
        /* --- Barrier Grid & Card Improvements --- */
        .barrier-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 28px; 
            margin-top: 32px;
        }
        .barrier-card { 
            background: white; 
            border: 1px solid var(--border-color); 
            border-radius: var(--radius-md); 
            padding: 24px; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .barrier-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 4px;
            background: transparent;
            transition: background 0.3s;
        }
        .barrier-card:hover { 
            border-color: var(--primary); 
            transform: translateY(-6px); 
            box-shadow: var(--shadow-lg); 
        }
        .barrier-card:hover::before { background: var(--primary); }
        
        .barrier-card.selected { 
            border: 2px solid var(--primary); 
            background-color: #f8fafc;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }
        
        .barrier-title { 
            font-weight: 800; 
            font-size: 1.25rem; 
            line-height: 1.3;
            margin-bottom: 6px; 
            color: var(--text-main); 
        }
        .barrier-supplier { font-size: 0.9rem; color: var(--text-sub); margin-bottom: 20px; font-weight: 500; }
        
        .stat-group {
            background: #f8fafc;
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-top: auto;
            border: 1px solid var(--border-color);
        }
        .stat-box { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 4px; align-items: center; }
        .stat-box:last-child { margin-bottom: 0; }
        .stat-label { color: var(--text-sub); font-weight: 500; }
        .stat-val { font-weight: 700; color: #334155; }

        /* Actions Overlay on Card */
        .card-actions {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .fav-btn {
            cursor: pointer; 
            font-size: 1.4rem; 
            line-height: 1; 
            color: #cbd5e1; 
            transition: all 0.2s;
            padding: 4px;
            border-radius: 50%;
        }
        .fav-btn:hover { background: #fff7ed; color: #fcc419; }
        .fav-btn.active { color: #f59e0b; text-shadow: 0 2px 4px rgba(245, 158, 11, 0.3); }

        .compare-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-sub);
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 20px;
            background: #f1f5f9;
            transition: all 0.2s;
        }
        .compare-checkbox:hover { background: #e2e8f0; }
        .compare-checkbox input { accent-color: var(--primary); width: 16px; height: 16px; cursor: pointer; }

        /* Quick picks */
        .quick-picks { background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:10px 12px; margin-bottom:12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
        .quick-heading { font-weight:700; color:#0f172a; font-size:0.9rem; margin-right:6px; }
        .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #cbd5e1; background:white; cursor:pointer; font-size:0.9rem; color:#0f172a; }
        .chip:hover { border-color:#94a3b8; background:#e2e8f0; }
        .chip-fav { border-color:#f59e0b; color:#b45309; }
        .chip-recent { border-color:#0ea5e9; color:#0c4a6e; }
        .delta-good { background:#dcfce7; color:#166534; font-weight:600; border-radius:6px; padding:2px 6px; font-size:0.85rem; }
        .delta-bad { background:#fee2e2; color:#b91c1c; font-weight:600; border-radius:6px; padding:2px 6px; font-size:0.85rem; }

        /* Filter inputs */
        .filter-mini { display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end; }
        .filter-mini .form-group { flex:1; min-width:140px; }

        /* --- Badges --- */
        .badge { 
            display: inline-flex; 
            align-items: center;
            padding: 4px 12px; 
            border-radius: 999px; 
            font-size: 0.75rem; 
            font-weight: 800; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .badge-tl2 { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
        .badge-tl3 { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
        .badge-tl4 { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
        .badge-tl5 { background: #f3e8ff; color: #7e22ce; border: 1px solid #e9d5ff; }

        /* --- Tabs --- */
        .stage1-tabs, .tab-nav { display: flex; gap: 4px; margin-bottom: 24px; border-bottom: 1px solid var(--border-color); }
        .tab-btn { 
            background: transparent; 
            border: none; 
            padding: 12px 20px; 
            font-weight: 600; 
            color: var(--text-sub); 
            cursor: pointer; 
            border-bottom: 2px solid transparent; 
            font-size: 0.95rem;
            transition: color 0.2s;
        }
        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* --- Calculation Panel --- */
        .calc-container { display: none; grid-template-columns: 360px 1fr; gap: 32px; align-items: start; }
        .calc-container.active { display: grid; }
        
        .section-title { 
            font-weight: 700; 
            color: #334155; 
            margin: 24px 0 16px 0; 
            font-size: 0.8rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            border-bottom: 1px solid #e2e8f0; 
            padding-bottom: 8px; 
        }

        /* --- Results Card --- */
        .results-card { 
            background: linear-gradient(145deg, #1e293b, #0f172a); 
            color: white; 
            padding: 32px; 
            border-radius: var(--radius-md); 
            margin-bottom: 32px; 
            box-shadow: var(--shadow-xl, 0 20px 25px -5px rgba(0, 0, 0, 0.1)); 
            border: 1px solid #334155;
        }
        .results-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 24px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            padding-bottom: 16px; 
        }
        .results-header h4 { margin: 0; color: #e2e8f0; font-weight: 600; font-size: 1.25rem; }
        
        .res-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px; font-size: 1.1rem; }
        .res-label { color: #cbd5e1; font-size: 0.95rem; font-weight: 500; }
        .res-val { font-weight: 700; font-family: 'SF Mono', 'Roboto Mono', monospace; font-size: 1.3rem; color: #ffffff; }
        .res-sub { font-size: 0.8rem; color: #64748b; text-align: right; font-style: italic; }

        .design-speed-input { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 8px 12px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 6px; 
            border: 1px solid rgba(255,255,255,0.2); 
        }
        .design-speed-input input { 
            width: 80px; 
            padding: 6px; 
            border-radius: 4px; 
            border: none; 
            background: #fff; 
            color: #0f172a; 
            text-align: center; 
            font-weight: 700; 
        }
        .design-speed-input label { color: #e2e8f0; font-size: 0.9rem; font-weight: 500; }

        /* --- Matrix Tables --- */
        .matrix-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.9rem; margin-bottom: 24px; border: 1px solid var(--border-color); border-radius: var(--radius-sm); overflow: hidden; }
        .matrix-table th { 
            text-align: left; 
            padding: 12px; 
            background: #f1f5f9; 
            border-bottom: 1px solid var(--border-color); 
            color: #475569; 
            font-weight: 600; 
        }
        .matrix-table td { 
            padding: 10px 12px; 
            border-bottom: 1px solid var(--border-color); 
            color: #334155;
        }
        .matrix-table tr:last-child td { border-bottom: none; }
        .row-highlight { background-color: #eff6ff !important; font-weight: 700; color: #1e40af !important; box-shadow: inset 3px 0 0 var(--primary); }
        .val-pass { color: var(--success-color); }
        .val-fail { color: var(--danger-color); font-weight: 700; }
        .row-fail { background: #fff1f2; }
        
        .angle-block { margin-bottom: 32px; background: white; border-radius: var(--radius-md); }
        .angle-header { 
            background: #e2e8f0; 
            padding: 10px 16px; 
            font-weight: 700; 
            border-radius: var(--radius-sm) var(--radius-sm) 0 0; 
            color: #334155;
            font-size: 0.95rem;
        }

        /* --- Login Overlay --- */
        #loginContainer {
          display: flex;
          align-items: stretch;
          justify-content: center;
          min-height: 100vh;
          background: #f1f5f9;
          background: radial-gradient(circle at center, #f8fafc 0%, #e2e8f0 100%);
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          z-index: 9999;
          padding: 32px;
          box-sizing: border-box;
          animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .login-shell {
          display: grid;
          grid-template-columns: minmax(0, 1fr) 420px;
          gap: 32px;
          align-items: center;
          width: min(1200px, 100%);
          margin: auto;
          animation: slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .login-info {
          background: rgba(255,255,255,0.75);
          border: 1px solid rgba(255,255,255,0.9);
          border-radius: 18px;
          padding: 28px;
          box-shadow: 0 10px 30px rgba(15,23,42,0.08);
          backdrop-filter: blur(2px);
          transition: all 0.3s ease;
        }
        .login-info:hover {
          box-shadow: 0 20px 40px rgba(15,23,42,0.12);
          transform: translateY(-2px);
        }
        .login-info h1 {
          margin: 0 0 12px 0;
          font-size: 1.8rem;
          color: #0f172a;
        }
        .login-info p { margin: 0 0 12px 0; font-size: 1rem; color: #334155; }
        .login-info .pill-row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .login-info .pill { 
            background: #0ea5e9; 
            color: #fff; 
            padding: 8px 12px; 
            border-radius: 999px; 
            font-weight: 700; 
            font-size: 0.9rem; 
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        .login-info .pill:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .login-info ul { margin: 12px 0 0 18px; color:#334155; }
        .login-info li { margin-bottom:8px; }

        .login-box {
          background: white;
          padding: 40px;
          border-radius: var(--radius-lg);
          box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
          width: 100%;
          max-width: 440px;
          text-align: center;
        }
        .login-title {
          font-size: 2rem;
          font-weight: 800;
          color: #0f172a;
          margin-bottom: 30px;
          letter-spacing: -0.025em;
        }
        .login-btn-group { display: flex; flex-direction: column; gap: 16px; }
        .login-input {
          width: 100%;
          padding: 14px;
          border: 1px solid #cbd5e1;
          border-radius: var(--radius-sm);
          font-size: 1.1rem;
          margin-bottom: 20px;
          transition: all 0.3s ease;
          background: #f8fafc;
        }
        .login-input:focus {
          outline: none;
          border-color: #2563eb;
          box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
          background: white;
          transform: translateY(-1px);
        }

        /* --- Misc / Utilities --- */
        .image-preview { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 24px; 
            background: #f8fafc; 
            border: 2px dashed #cbd5e1; 
            border-radius: var(--radius-md); 
            text-decoration: none; 
            color: inherit; 
            margin-bottom: 24px; 
            transition: all 0.2s; 
        }
        .image-preview:hover { border-color: var(--primary); background: #eff6ff; }
        .image-icon { font-size: 32px; margin-bottom: 8px; }
        .thumb-placeholder {
          width: 72px;
          height: 72px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          border-radius: 6px;
          background: linear-gradient(135deg, #e2e8f0, #f8fafc);
          color: #64748b;
          font-weight: 700;
          font-size: 0.75rem;
          border: 1px dashed #cbd5e1;
          text-transform: uppercase;
          letter-spacing: 0.05em;
          flex-shrink: 0;
        }
        .info-banner {
          background: #f8fafc;
          border: 1px solid #e2e8f0;
          border-radius: 12px;
          padding: 12px 14px;
          margin: 8px 0 16px 0;
          display: flex;
          flex-direction: column;
          gap: 8px;
        }
        .legend-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .status-pill {
          display: inline-flex;
          align-items: center;
          gap: 6px;
          padding: 6px 10px;
          border-radius: 999px;
          font-size: 0.85rem;
          border: 1px solid #cbd5e1;
          background: white;
          color: #0f172a;
          font-weight: 600;
        }
        .status-pill.ok { border-color: #bbf7d0; background: #ecfdf3; color: #166534; }
        .status-pill.warn { border-color: #fecdd3; background: #fff1f2; color: #b91c1c; }
        .status-pill.note { border-color: #e2e8f0; background: #f8fafc; color: #334155; }
        .status-pill.highlight { border-color: #bfdbfe; background: #eff6ff; color: #1d4ed8; }
        .link-health { margin-top: 8px; color: #b91c1c; font-size: 0.9rem; display:none; }
        .link-health.ok { color: #0f766e; }

        /* Width visualizer */
        .width-visual { margin-top:20px; padding:14px; border:1px solid #e2e8f0; border-radius:12px; background:#f8fafc; box-shadow:var(--shadow-xs); }
        .width-row { display:flex; align-items:center; gap:12px; margin-bottom:10px; flex-wrap:wrap; }
        .width-label { min-width:150px; font-weight:700; color:#0f172a; }
        .width-bar-shell { flex:1; min-width:180px; height:16px; background:#e2e8f0; border-radius:999px; overflow:hidden; position:relative; }
        .width-bar { height:100%; border-radius:999px; background: linear-gradient(90deg, #2563eb, #60a5fa); }
        .width-val { font-weight:700; color:#334155; min-width:80px; text-align:right; }
        .width-legend { display:flex; gap:10px; flex-wrap:wrap; font-size:0.9rem; color:#475569; margin-top:8px; }
        .width-pill { padding:6px 10px; border-radius:999px; border:1px solid #cbd5e1; background:white; font-weight:600; }
        .width-pill.ok { border-color:#bbf7d0; background:#ecfdf3; color:#166534; }
        .width-pill.warn { border-color:#fecdd3; background:#fff1f2; color:#b91c1c; }
        .width-dim-row { display:flex; align-items:center; gap:12px; margin-bottom:14px; flex-wrap:wrap; }
        .width-dim-track { position:relative; flex:1; min-width:220px; height:32px; }
        .width-dim-base { position:absolute; left:0; right:0; top:50%; height:6px; background:#e2e8f0; border-radius:999px; transform:translateY(-50%); }
        .width-dim-bar { position:absolute; left:0; top:50%; height:20px; transform:translateY(-50%); border-radius:999px; display:flex; align-items:center; justify-content:center; color:#0f172a; font-weight:700; font-size:0.85rem; padding:0 10px; overflow:hidden; box-shadow:0 2px 6px rgba(15,23,42,0.08); min-width:56px; }
        .width-dim-placeholder { background:#e2e8f0 !important; color:#94a3b8; border:1px dashed #cbd5e1; opacity:0.85; }
        .width-dim-mark { position:absolute; width:2px; height:18px; background:rgba(15,23,42,0.65); top:50%; transform:translateY(-50%); }
        .width-dim-mark.left { left:6px; }
        .width-dim-mark.right { right:6px; }
        .width-dim-text { position:relative; z-index:1; color:#0b1220; text-shadow:0 1px 2px rgba(255,255,255,0.7); white-space:nowrap; }
        .width-dim-text.muted { color:#94a3b8; text-shadow:none; }
        .width-dim-arrow { position:absolute; top:50%; width:0; height:0; border-top:8px solid transparent; border-bottom:8px solid transparent; transform:translateY(-50%); }
        .width-dim-arrow.start { left:-4px; border-right:10px solid #94a3b8; }
        .width-dim-arrow.end { right:-4px; border-left:10px solid #94a3b8; }
        .width-sketch { margin-top:16px; padding:14px; border:1px solid #e2e8f0; border-radius:12px; background:#fff; box-shadow:var(--shadow-xs); }
        .width-sketch-header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:8px; }
        .width-sketch-title { font-weight:700; color:#0f172a; }
        .width-sketch svg { width:100%; height:auto; display:block; }
        .width-sketch-note { color:#475569; font-size:0.9rem; margin-top:6px; }

        /* Tech sheet preview */
        .tech-preview { border:1px solid var(--border-color); border-radius:12px; background:#fff; box-shadow:var(--shadow-sm); margin-bottom:20px; overflow:hidden; }
        .tech-preview-header { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 14px; background:#f8fafc; border-bottom:1px solid var(--border-color); }
        .tech-preview-title { font-weight:700; color:#0f172a; }
        .tech-preview-note { font-size:0.9rem; color:#475569; margin:0; }
        .tech-preview-frame { width:100%; height:360px; border:0; background:#0f172a10; }
        .tech-preview-empty { padding:14px; color:#475569; font-size:0.95rem; }
        
        .scenario-toolbar { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding: 16px; background: #f1f5f9; border-radius: var(--radius-md); }
        .scenario-card { background: white; border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow-sm); }
        
        /* --- Signatures --- */
        .signature-section { border-top: 1px solid var(--border-color); padding-top: 32px; margin-top: 32px; }
        .sig-row { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 24px; }
        .sig-label { display: block; font-weight: 600; color: #64748b; font-size: 0.85rem; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
        .sig-input { font-family: 'Mrs Saint Delafield', cursive, sans-serif; font-size: 1.5rem; border-bottom: 1px solid #94a3b8; padding: 4px 0; color: #000; min-height: 40px; }

        /* --- Page Navigation --- */
        .page-nav {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 10px;
          margin: 18px 0 22px 0;
          padding: 12px;
          border: 1px solid var(--border-color);
          border-radius: var(--radius-md);
          background: #f8fafc;
        }
        .page-nav.bottom {
          margin-top: 28px;
          margin-bottom: 10px;
        }
        .page-nav-title {
          font-size: 0.95rem;
          font-weight: 700;
          color: #334155;
          text-align: center;
          flex: 1;
          min-width: 180px;
        }
        .page-nav-btn {
          padding: 10px 14px;
          font-size: 0.9rem;
          font-weight: 700;
          border-radius: 10px;
          border: 1px solid #cbd5e1;
          background: white;
          color: #0f172a;
          cursor: pointer;
        }
        .page-nav-btn:disabled {
          opacity: 0.45;
          cursor: not-allowed;
        }

        .role-mode-banner {
          display: none;
          margin: 10px 0 16px 0;
          padding: 10px 14px;
          border-radius: 10px;
          border: 1px solid #bae6fd;
          background: #f0f9ff;
          color: #0c4a6e;
          font-weight: 700;
          font-size: 0.95rem;
        }

        .legacy-nav { display: none !important; }

        /* --- Admin --- */
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: block !important; }
        body.is-admin .admin-only.btn { display: inline-flex !important; }
        
        /* --- Planner User --- */
        body.is-planner .admin-only { display: none !important; }
        body.is-planner .planner-no-print { display: none !important; }
        
        /* --- External User (view only) --- */
        .internal-only { display: inline-block; }
        body.is-external .internal-only { display: none !important; }
        body.is-external #stage1,
        body.is-external #stage3,
        body.is-external #stage4,
        body.is-external #stage5,
        body.is-external #stage7 { display: none !important; }
        
        /* --- Print Styles --- */
        .print-only { display: none; }
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; padding: 0; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
            .container { box-shadow: none; border: none; width: 100%; max-width: none; padding: 0; margin: 0; }
            .no-print, .header button, .filter-panel, .tab-nav, .scenario-toolbar { display: none !important; }
            
            .print-page { 
                padding: 15mm; 
                width: 210mm; 
                min-height: 297mm; 
                position: relative; 
                display: flex; 
                flex-direction: column; 
            }
            .page-break { page-break-before: always; }
            
            #printReportOutput { display: block !important; }
            #mainApp { display: none !important; }
            
            .results-card { 
                background: #ffffff !important; 
                color: #000000 !important; 
                border: 2px solid #000; 
                box-shadow: none; 
                break-inside: avoid; 
            }
            .results-card h4, 
            .results-card .res-label, 
            .results-card .res-val, 
            .results-card .res-sub,
            .results-card label {
                color: #000000 !important;
            }
            
            .res-label { font-weight: 600 !important; }
            .design-speed-input { background: transparent !important; border: 1px solid #000 !important; }
            .design-speed-input input { border: none !important; color: #000 !important; }
            
            a[href]:after { content: " (" attr(href) ")"; font-size: 0.8em; color: #555; }
        }
        
        /* --- Loading Spinner --- */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Stage Transitions --- */
        #stage1, #stage2, #stage3, #stage4, #stage5, #stage7 {
            animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Responsiveness --- */
        @media (max-width: 768px) {
            .container { padding: 20px; }
            .calc-container { grid-template-columns: 1fr; }
            .header { flex-direction: column; }
            .header h1 { font-size: 1.5rem; }
          .login-shell { grid-template-columns: 1fr; }
          .login-info { order: 2; }
          .login-box { padding: 30px; max-width: 100%; }
            .sig-row { grid-template-columns: 1fr; gap: 20px; }
        }
    </style>
    <script>
      const ADMIN_PASSWORD = 'Admin123';
      const PLANNER_PASSWORD = 'Crompton4551';
      let currentUserRole = '';

      const STAGE_IDS = ['stage1', 'stage2', 'stage3', 'stage4', 'stage5', 'stage7'];

      function canUserAccessStage(stageId) {
        if (currentUserRole === 'external') {
          return stageId === 'stage2';
        }
        return true;
      }

      function showOnlyStage(stageId) {
        STAGE_IDS.forEach(id => {
          const stageEl = document.getElementById(id);
          if (!stageEl) return;
          const isVisible = id === stageId;
          if (!isVisible) {
            stageEl.style.display = 'none';
            if (id === 'stage3') stageEl.classList.remove('active');
            return;
          }

          if (id === 'stage3') {
            stageEl.style.display = 'grid';
            stageEl.classList.add('active');
          } else if (id === 'stage4' || id === 'stage5' || id === 'stage7') {
            stageEl.style.display = 'grid';
          } else {
            stageEl.style.display = 'block';
          }
        });
        updatePageNav();
      }

      function getVisibleStageId() {
        for (const id of STAGE_IDS) {
          const el = document.getElementById(id);
          if (!el) continue;
          if (window.getComputedStyle(el).display !== 'none') return id;
        }
        return 'stage1';
      }

      function getStageLabel(stageId) {
        const labels = {
          stage1: 'Risk Assessment',
          stage2: 'Barriers & End Treatments',
          stage3: 'Calculations',
          stage4: 'End Treatment Selection',
          stage5: 'End Treatment Details',
          stage7: 'Sign Off'
        };
        return labels[stageId] || stageId;
      }

      function updatePageNav() {
        const stageId = getVisibleStageId();
        const prevBtns = [document.getElementById('prevPageBtnTop'), document.getElementById('prevPageBtnBottom')];
        const nextBtns = [document.getElementById('nextPageBtnTop'), document.getElementById('nextPageBtnBottom')];
        const labels = [document.getElementById('pageNavTitleTop'), document.getElementById('pageNavTitleBottom')];

        labels.forEach(label => {
          if (label) label.textContent = `Current: ${getStageLabel(stageId)}`;
        });

        const canGoPrev = currentUserRole !== 'external' && stageId !== 'stage1';
        let canGoNext = false;
        let nextText = 'Next →';

        if (currentUserRole === 'external') {
          canGoNext = false;
          nextText = 'Next →';
        } else {
          if (stageId === 'stage1') {
            canGoNext = true;
            nextText = 'Next: Barriers →';
          } else if (stageId === 'stage2') {
            canGoNext = false;
            nextText = 'Select barrier card →';
          } else if (stageId === 'stage3') {
            canGoNext = true;
            nextText = 'Next: End Treatments →';
          } else if (stageId === 'stage4') {
            canGoNext = true;
            nextText = 'Next: Details →';
          } else if (stageId === 'stage5') {
            canGoNext = true;
            nextText = 'Next: Sign Off →';
          } else if (stageId === 'stage7') {
            canGoNext = false;
            nextText = 'Next →';
          }
        }

        prevBtns.forEach(btn => {
          if (!btn) return;
          btn.disabled = !canGoPrev;
        });
        nextBtns.forEach(btn => {
          if (!btn) return;
          btn.disabled = !canGoNext;
          btn.textContent = nextText;
        });
      }

      function goToPreviousPage() {
        const stageId = getVisibleStageId();
        if (currentUserRole === 'external') {
          alert('External users can only view barrier and end-treatment lists.');
          return;
        }

        if (stageId === 'stage2') {
          backToStage1();
          return;
        }
        if (stageId === 'stage3') {
          backToSelection();
          return;
        }
        if (stageId === 'stage4') {
          backToStage2();
          return;
        }
        if (stageId === 'stage5') {
          backToStage3();
          return;
        }
        if (stageId === 'stage7') {
          backToStage4();
        }
      }

      function goToNextPage() {
        const stageId = getVisibleStageId();

        if (currentUserRole === 'external') {
          alert('External users can only view barrier and end-treatment lists.');
          return;
        }

        if (stageId === 'stage1') {
          proceedToBarrierSelection();
          return;
        }
        if (stageId === 'stage2') {
          alert('Please select a barrier card to continue to calculations.');
          return;
        }
        if (stageId === 'stage3') {
          goToStage3();
          return;
        }
        if (stageId === 'stage4') {
          goToStage4();
          return;
        }
        if (stageId === 'stage5') {
          goToStage7();
        }
      }

      function updateRoleModeBanner() {
        const banner = document.getElementById('roleModeBanner');
        if (!banner) return;

        if (currentUserRole === 'external') {
          banner.textContent = 'External user mode: view-only access to barriers and end treatments.';
          banner.style.display = 'block';
        } else {
          banner.style.display = 'none';
          banner.textContent = '';
        }
      }

      function hideLegacyNavigation() {
        const selectors = [
          "button[onclick=\"proceedToBarrierSelection()\"]",
          "button[onclick=\"backToStage1()\"]",
          "button[onclick=\"backToSelection()\"]",
          "button[onclick=\"goToStage4()\"]",
          "button[onclick=\"backToStage2()\"]",
          "button[onclick=\"backToStage3()\"]",
          "button[onclick=\"goToStage7()\"]",
          "button[onclick=\"backToStage4()\"]",
          "#toStage3Btn",
          "#toStage4Btn"
        ];
        selectors.forEach(sel => {
          document.querySelectorAll(sel).forEach(el => el.classList.add('legacy-nav'));
        });
      }
        
        function loginAs(role) {
            const app = document.getElementById('mainApp');
            const login = document.getElementById('loginContainer');
            const body = document.body;
        currentUserRole = role;
            
            // Clear all role classes
        body.classList.remove('is-admin', 'is-external', 'is-planner');
            
            if (role === 'external') {
                body.classList.add('is-external');
            } else if (role === 'admin') {
                body.classList.add('is-admin');
        } else if (role === 'planner') {
          body.classList.add('is-planner');
            }
            
            login.style.display = 'none';
            app.style.display = 'block';
        hideLegacyNavigation();
            
            // Show logout button for all logged-in users
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.style.display = 'inline-flex';
            }

            updateRoleModeBanner();

        if (role === 'external') {
          showOnlyStage('stage2');
        } else {
          showOnlyStage('stage1');
        }
        }
    
      function showPlannerLogin() {
            document.querySelector('.login-btn-group').style.display = 'none';
        document.getElementById('plannerForm').style.display = 'block';
        document.getElementById('plannerPass').focus();
        }
        
        function showAdminLogin() {
            document.querySelector('.login-btn-group').style.display = 'none';
            document.getElementById('adminForm').style.display = 'block';
            document.getElementById('adminPass').focus();
        }
    
      function hidePlannerLogin() {
        document.getElementById('plannerForm').style.display = 'none';
            document.querySelector('.login-btn-group').style.display = 'flex';
        document.getElementById('plannerLoginError').style.display = 'none';
        document.getElementById('plannerPass').value = '';
        }
        
        function hideAdminLogin() {
            document.getElementById('adminForm').style.display = 'none';
            document.querySelector('.login-btn-group').style.display = 'flex';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('adminPass').value = '';
            document.getElementById('adminPass').blur();
        }
    
        function checkPlanner() {
          const p = document.getElementById('plannerPass').value;
          const rememberMe = document.getElementById('plannerRememberMeCheckbox').checked;

          if (p === PLANNER_PASSWORD) {
            if (rememberMe) {
              localStorage.setItem('plannerRemembered', 'true');
            }
            loginAs('planner');
            } else {
            document.getElementById('plannerLoginError').style.display = 'block';
            }
        }
        
        function checkAdmin() {
            const p = document.getElementById('adminPass').value;
            const rememberMe = document.getElementById('rememberMeCheckbox').checked;
            if (p === ADMIN_PASSWORD) {
                if (rememberMe) {
                    localStorage.setItem('adminRemembered', 'true');
                }
                loginAs('admin');
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }
        
        function logoutAdmin() {
            localStorage.removeItem('adminRemembered');
          localStorage.removeItem('plannerRemembered');
          currentUserRole = '';
          document.body.classList.remove('is-admin', 'is-planner', 'is-external');
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminForm').style.display = 'none';
          document.getElementById('plannerForm').style.display = 'none';
            document.querySelector('.login-btn-group').style.display = 'flex';
          showOnlyStage('stage1');
            
            // Hide logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.style.display = 'none';
            }

            updateRoleModeBanner();
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-hide the "Made by" badge after 10 seconds
            setTimeout(function() {
                const badge = document.querySelector('.made-by-badge');
                if (badge) {
                    badge.classList.add('hidden');
                }
            }, 10000);
            
            // Check if admin was remembered
            if (localStorage.getItem('adminRemembered') === 'true') {
                loginAs('admin');
            } 
            // Check if planner was remembered
            else if (localStorage.getItem('plannerRemembered') === 'true') {
              loginAs('planner');
            }
            
            // Add keypress handlers
            const passInput = document.getElementById('adminPass');
            if(passInput) {
                passInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') checkAdmin();
                });
            }
            
            const plannerPassInput = document.getElementById('plannerPass');
            if(plannerPassInput) {
              plannerPassInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') checkPlanner();
                });
            }
            
            // Hidden admin login trigger (triple-click on login title area)
            const adminTrigger = document.getElementById('adminTrigger');
            if(adminTrigger) {
                let clickCount = 0;
                let clickTimer = null;
                adminTrigger.addEventListener('click', function() {
                    clickCount++;
                    if (clickCount === 1) {
                        clickTimer = setTimeout(function() {
                            clickCount = 0;
                        }, 800);
                    } else if (clickCount === 3) {
                        clearTimeout(clickTimer);
                        clickCount = 0;
                        showAdminLogin();
                    }
                });
            }
            
            // Keyboard shortcut for admin login: Ctrl+Shift+A
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                    e.preventDefault();
                    const loginContainer = document.getElementById('loginContainer');
                    if (loginContainer && loginContainer.style.display !== 'none') {
                        showAdminLogin();
                    }
                }
            });

                hideLegacyNavigation();
                updatePageNav();
        });
    </script>
</head>
<body id="bd">

<!-- LOGIN OVERLAY -->
<div id="loginContainer">
  <div class="login-shell">
    <div class="login-info">
      <h1>Temporary Barrier Analysis</h1>
      <p>Review barrier performance, compare systems, and calculate site-specific deflection with transparent assumptions.</p>
      <div class="pill-row">
        <span class="pill">Compare MASH TL2–TL5</span>
        <span class="pill">Tech sheets linked</span>
        <span class="pill">Width/deflection matrices</span>
      </div>
      <ul>
        <li>Filter by speed, available width, material, category, and special features.</li>
        <li>See deflection/working-width calculations and printable reports with signatures.</li>
        <li>Access terminal/end-treatment data alongside barriers for complete layouts.</li>
      </ul>
    </div>

    <div class="login-box">
        <div class="login-title" id="adminTrigger" style="cursor:pointer; user-select:none; min-height:40px; margin-bottom:10px; border-radius:8px; transition: background 0.2s;" onmouseover="this.style.background='rgba(37, 99, 235, 0.03)'" onmouseout="this.style.background='transparent'"></div>
        <div class="login-btn-group">
        <button class="btn btn-outline" style="width:100%" onclick="showAdminLogin()">Admin</button>
        <button class="btn btn-outline" style="width:100%" onclick="showPlannerLogin()">Planners</button>
            <button class="btn" style="width:100%" onclick="loginAs('external')">External User</button>
        </div>
        
      <div id="plannerForm" style="display:none; margin-top:20px; border-top:1px solid #e2e8f0; padding-top:20px;">
        <input type="password" id="plannerPass" class="login-input" placeholder="Enter Planner Password" autocomplete="current-password">
            <div style="display:flex; align-items:center; margin:15px 0; gap:8px;">
          <input type="checkbox" id="plannerRememberMeCheckbox" style="width:18px; height:18px; cursor:pointer;">
          <label for="plannerRememberMeCheckbox" style="cursor:pointer; color:#475569; font-size:0.95rem; margin:0;">Remember me on this computer</label>
            </div>
        <div id="plannerLoginError" class="login-error" style="display:none;">Incorrect planner password</div>
        <button class="btn" style="width:100%" onclick="checkPlanner()">Login as Planner</button>
        <button class="btn btn-link" style="margin-top:10px;" onclick="hidePlannerLogin()">Cancel</button>
        </div>
        
        <div id="adminForm" style="display:none; margin-top:20px; border-top:1px solid #e2e8f0; padding-top:20px;">
            <input type="password" id="adminPass" class="login-input" placeholder="Enter Admin Password">
            <div style="display:flex; align-items:center; margin:15px 0; gap:8px;">
                <input type="checkbox" id="rememberMeCheckbox" style="width:18px; height:18px; cursor:pointer;">
                <label for="rememberMeCheckbox" style="cursor:pointer; color:#475569; font-size:0.95rem; margin:0;">Remember me on this computer</label>
            </div>
            <div id="loginError" class="login-error">Incorrect Password</div>
            <button class="btn" style="width:100%" onclick="checkAdmin()">Login as Admin</button>
            <button class="btn btn-link" style="margin-top:10px;" onclick="hideAdminLogin()">Cancel</button>
        </div>
    </div>
  </div>
</div>

<div class="made-by-badge no-print">
  <span class="author-icon">👨‍💻</span>
  <span class="author-name">Made by Sanju Bhandari</span>
</div>

<div id="mainApp" style="display:none;">
<div class="container">
    <div class="header">
        <div>
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                <span style="background:var(--primary); color:white; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:8px; font-weight:900; font-size:1.2rem;">C</span>
                <div style="font-weight:700; color:var(--secondary); font-size:0.9rem; text-transform:uppercase; letter-spacing:0.1em;">Crompton Concepts</div>
            </div>
            <h1 style="margin-bottom:8px; font-size:2rem; background: -webkit-linear-gradient(0deg, #1e293b, #334155); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">Temporary Works Risk & Safety Assessment Tool</h1>
          <p style="font-size:1.1rem; max-width:600px;">Review temporary barrier performance, compare systems, and calculate site-specific deflection requirements.</p>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
             <a href="https://drive.google.com/file/d/1CS9_LMbzimHk5tiEhArxSBEKRgGFubXh/view?usp=sharing" target="_blank" class="btn btn-outline no-print" style="display:inline-flex; align-items:center; gap:5px; text-decoration:none;">
                📋 TMR 
            </a>
             <button id="showGlossaryBtn" class="btn btn-outline no-print" onclick="openGlossary()" style="display:inline-flex; align-items:center; gap:5px;">
                <span style="font-weight:bold; border:1px solid currentColor; border-radius:50%; width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center; font-size:0.8rem;">?</span>
                Definitions
            </button>
            <button id="resetBtn" class="btn btn-outline no-print logout-allowed" style="display:none;" onclick="resetTool()">Start Over</button>
            <button id="logoutBtn" class="btn btn-outline no-print logout-allowed" style="display:none;" onclick="logoutAdmin()">Logout</button>
        </div>
    </div>

    <div id="roleModeBanner" class="role-mode-banner no-print" aria-live="polite"></div>

    <div class="page-nav no-print" id="pageNavTop">
      <button type="button" id="prevPageBtnTop" class="page-nav-btn" onclick="goToPreviousPage()">← Previous</button>
      <div id="pageNavTitleTop" class="page-nav-title">Current: Risk Assessment</div>
      <button type="button" id="nextPageBtnTop" class="page-nav-btn" onclick="goToNextPage()">Next →</button>
    </div>

    <!-- STAGE 1: Risk Assessment -->
    <div id="stage1" style="display:block;">
        <div style="margin-bottom:24px;">
            <h2 style="margin-bottom:12px; font-size:1.5rem;">Stage 1: Risk Assessment</h2>
            <p style="color:var(--text-sub); margin-bottom:24px;">Selection of barrier always depends upon risk assessment. Complete the risk assessment below to determine the appropriate barrier requirements.</p>
        </div>

        <!-- Design Type Selection -->
        <div class="card" style="margin-bottom:24px; background:linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border:2px solid var(--primary);">
            <h3 style="margin-bottom:16px; color:var(--primary);">🎯 Design Type Selection</h3>
            <p style="color:var(--text-sub); margin-bottom:16px; font-size:0.95rem;">Select the type of design this risk assessment is for. Common risks will be pre-populated based on your selection.</p>
            <div class="input-grid" style="grid-template-columns: 1fr 1fr; gap:16px;">
                <div class="form-group">
                    <label style="font-weight:700;">Design Type <span style="color:#ef4444;">*</span></label>
                    <select id="designType" style="width:100%; padding:12px; border:2px solid var(--primary); border-radius:8px; font-size:1rem; font-weight:600;" onchange="handleDesignTypeChange()">
                        <option value="">-- Select Design Type --</option>
                        <option value="swept-paths">Swept Paths Design</option>
                        <option value="barrier">Barrier Design</option>
                        <option value="other">Other Design (Specify)</option>
                    </select>
                </div>
                <div class="form-group" id="otherDesignTypeContainer" style="display:none;">
                    <label style="font-weight:700;">Specify Other Design Type</label>
                    <input type="text" id="otherDesignType" placeholder="e.g., Road widening, Intersection upgrade, etc." style="width:100%; padding:12px; border:2px solid var(--border-color); border-radius:8px; font-size:1rem;">
                </div>
            </div>
            <div id="designTypeInfo" style="margin-top:16px; padding:12px; background:#ffffff; border-left:4px solid var(--primary); border-radius:4px; display:none;">
                <p style="margin:0; font-size:0.9rem; color:var(--text-sub);"></p>
            </div>
        </div>

        <div class="card" style="margin-bottom:24px;">
            <h3 style="margin-bottom:16px;">Site Information</h3>
            <div class="input-grid">
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="riskProjectName" placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label>Site Location</label>
                    <input type="text" id="riskLocation" placeholder="Enter site location">
                </div>
                <div class="form-group">
                    <label>Assessment Date</label>
                    <input type="date" id="riskDate">
                </div>
                <div class="form-group">
                    <label>Doc Ref</label>
                    <input type="text" id="riskDocRef" placeholder="Enter document reference">
                </div>
                <div class="form-group">
                    <label>Reference Drawings</label>
                    <input type="text" id="riskRefDrawings" placeholder="Enter reference drawings">
                </div>
            </div>
        </div>

        <div class="card" style="margin-bottom:24px;">
            <h3 style="margin-bottom:16px;">Risk Assessment Table</h3>
            <p style="color:var(--text-sub); margin-bottom:16px; font-size:0.95rem;">Evaluate each risk factor and assign a severity level (Low, Medium, High, Critical).</p>
            
            <!-- PDF Upload Section -->
            <div style="margin-bottom:20px; padding:16px; background:var(--primary-light); border-radius:8px; border:1px solid var(--primary);">
                <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:250px;">
                        <h4 style="margin:0 0 4px 0; color:var(--primary); font-size:1rem;">📄 Import Risk Assessment from PDF</h4>
                        <p style="margin:0 0 8px 0; font-size:0.85rem; color:var(--text-sub);">Upload your risk assessment PDF or a previously generated report HTML to automatically populate the table below.</p>
                        <details style="font-size:0.8rem; color:var(--text-sub); margin-top:4px;">
                            <summary style="cursor:pointer; color:var(--primary); font-weight:600;">ℹ️ Formatting Requirements</summary>
                            <ul style="margin:8px 0 0 20px; padding:0; line-height:1.6;">
                                <li>PDF must contain a structured risk assessment table</li>
                                <li>Columns: Hazard, Impact, Likelihood, Consequence, Controls, Risk Owner</li>
                                <li>Use text-based PDFs (not scanned images without OCR)</li>
                                <li>Likelihood/Consequence: Use numbers (1-5) or text (Rare, Likely, etc.)</li>
                                <li><strong>Best formats:</strong> PDF, Word (.docx), or Text (.txt) - <em>PDF recommended</em></li>
                            </ul>
                        </details>
                    </div>
                    <div>
                        <input type="file" id="pdfUploadInput" accept=".pdf,.docx,.txt" style="display:none;" onchange="handlePDFUpload(event)">
                        <input type="file" id="reportUploadInput" accept=".html,.htm" style="display:none;" onchange="handleReportUpload(event)">
                        <input type="file" id="riskJsonUploadInput" accept=".json" style="display:none;" onchange="handleRiskJsonUpload(event)">
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                          <button class="btn" onclick="document.getElementById('pdfUploadInput').click()" style="white-space:nowrap;">
                            📤 Upload File
                          </button>
                          <button class="btn btn-outline" onclick="document.getElementById('reportUploadInput').click()" style="white-space:nowrap;">
                            📥 Load Report (HTML)
                          </button>
                          <button class="btn btn-outline" onclick="document.getElementById('riskJsonUploadInput').click()" style="white-space:nowrap;">
                            📥 Load Risk JSON
                          </button>
                          <button class="btn btn-outline" onclick="exportRiskRegisterJson()" style="white-space:nowrap;">
                            💾 Export Risk JSON
                          </button>
                        </div>
                    </div>
                </div>
                <div id="pdfUploadStatus" style="margin-top:12px; display:none;">
                    <!-- Status messages will appear here -->
                </div>
            </div>
            
            <!-- Rating Scales Reference & Risk Matrix -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:20px;">
                <!-- Rating Scales Reference -->
                <div style="background:var(--bg-body); padding:16px; border-radius:8px; border:1px solid var(--border-color);">
                    <h4 style="margin:0 0 12px 0; color:var(--primary); font-size:0.95rem;">📊 Rating Scales Reference</h4>
                    
                    <div style="margin-bottom:12px;">
                        <div style="font-weight:700; font-size:0.85rem; margin-bottom:6px; color:var(--text-main);">Likelihood (Probability)</div>
                        <div style="font-size:0.8rem; line-height:1.5; color:var(--text-sub);">
                            <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px; margin-bottom:3px;">
                                <span style="font-weight:700;">1</span> <span>Rare - May occur in exceptional circumstances</span>
                            </div>
                            <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px; margin-bottom:3px;">
                                <span style="font-weight:700;">2</span> <span>Unlikely - Could occur at some time</span>
                            </div>
                            <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px; margin-bottom:3px;">
                                <span style="font-weight:700;">3</span> <span>Possible - Might occur at some time</span>
                            </div>
                            <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px; margin-bottom:3px;">
                                <span style="font-weight:700;">4</span> <span>Likely - Will probably occur</span>
                            </div>
                            <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px;">
                                <span style="font-weight:700;">5</span> <span>Almost Certain - Expected to occur</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <div style="font-weight:700; font-size:0.85rem; margin-bottom:6px; color:var(--text-main);">Consequence (Severity)</div>
                        <div style="font-size:0.8rem; line-height:1.5; color:var(--text-sub);">
                            <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px; margin-bottom:3px;">
                                <span style="font-weight:700;">1</span> <span>Insignificant - No injuries, low loss</span>
                            </div>
                            <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px; margin-bottom:3px;">
                                <span style="font-weight:700;">2</span> <span>Minor - First aid, medium loss</span>
                            </div>
                            <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px; margin-bottom:3px;">
                                <span style="font-weight:700;">3</span> <span>Moderate - Medical treatment, high loss</span>
                            </div>
                            <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px; margin-bottom:3px;">
                                <span style="font-weight:700;">4</span> <span>Major - Extensive injuries, major loss</span>
                            </div>
                            <div style="display:grid; grid-template-columns: 30px 1fr; gap:8px;">
                                <span style="font-weight:700;">5</span> <span>Catastrophic - Death, huge loss</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top:12px; padding:10px; background:#eff6ff; border-left:3px solid var(--primary); font-size:0.8rem; border-radius:4px;">
                        <strong>Risk Rating = Likelihood × Consequence</strong>
                    </div>
                </div>
                
                <!-- Risk Matrix Visualization -->
                <div style="background:var(--bg-body); padding:16px; border-radius:8px; border:1px solid var(--border-color);">
                    <h4 style="margin:0 0 12px 0; color:var(--primary); font-size:0.95rem;">🎯 Risk Matrix</h4>
                    <div id="riskMatrixViz" style="font-size:0.75rem;">
                        <table style="width:100%; border-collapse:collapse; text-align:center; margin-bottom:10px;">
                            <tr>
                                <td style="border:none; font-weight:700; font-size:0.7rem; padding:4px; vertical-align:middle; text-align:right; color:#1e293b; width:15%;">Likelihood →<br>Consequence ↓</td>
                                <td style="border:1px solid #cbd5e1; background:#f1f5f9; font-weight:700; padding:6px; font-size:0.7rem; color:#1e293b;">1<br>Rare</td>
                                <td style="border:1px solid #cbd5e1; background:#f1f5f9; font-weight:700; padding:6px; font-size:0.7rem; color:#1e293b;">2<br>Unlikely</td>
                                <td style="border:1px solid #cbd5e1; background:#f1f5f9; font-weight:700; padding:6px; font-size:0.7rem; color:#1e293b;">3<br>Possible</td>
                                <td style="border:1px solid #cbd5e1; background:#f1f5f9; font-weight:700; padding:6px; font-size:0.7rem; color:#1e293b;">4<br>Likely</td>
                                <td style="border:1px solid #cbd5e1; background:#f1f5f9; font-weight:700; padding:6px; font-size:0.7rem; color:#1e293b;">5<br>Almost<br>Certain</td>
                            </tr>
                            <tr>
                                <td style="border:1px solid #cbd5e1; background:#f1f5f9; font-weight:700; padding:6px; text-align:center; font-size:0.7rem; color:#1e293b;">5 Catastrophic</td>
                                <td style="border:1px solid #cbd5e1; background:#ffe699; padding:8px; font-weight:700;">5</td>
                                <td style="border:1px solid #cbd5e1; background:#f4b183; padding:8px; font-weight:700;">10</td>
                                <td style="border:1px solid #cbd5e1; background:#f4b183; padding:8px; font-weight:700;">15</td>
                                <td style="border:1px solid #cbd5e1; background:#c00000; padding:8px; font-weight:700; color:#ffffff;">20</td>
                                <td style="border:1px solid #cbd5e1; background:#c00000; padding:8px; font-weight:700; color:#ffffff;">25</td>
                            </tr>
                            <tr>
                                <td style="border:1px solid #cbd5e1; background:#f1f5f9; font-weight:700; padding:6px; text-align:center; font-size:0.7rem; color:#1e293b;">4 Major</td>
                                <td style="border:1px solid #cbd5e1; background:#00b050; padding:8px; font-weight:700; color:#ffffff;">4</td>
                                <td style="border:1px solid #cbd5e1; background:#ffe699; padding:8px; font-weight:700;">8</td>
                                <td style="border:1px solid #cbd5e1; background:#f4b183; padding:8px; font-weight:700;">12</td>
                                <td style="border:1px solid #cbd5e1; background:#c00000; padding:8px; font-weight:700; color:#ffffff;">16</td>
                                <td style="border:1px solid #cbd5e1; background:#c00000; padding:8px; font-weight:700; color:#ffffff;">20</td>
                            </tr>
                            <tr>
                                <td style="border:1px solid #cbd5e1; background:#f1f5f9; font-weight:700; padding:6px; text-align:center; font-size:0.7rem; color:#1e293b;">3 Moderate</td>
                                <td style="border:1px solid #cbd5e1; background:#00b050; padding:8px; font-weight:700; color:#ffffff;">3</td>
                                <td style="border:1px solid #cbd5e1; background:#ffe699; padding:8px; font-weight:700;">6</td>
                                <td style="border:1px solid #cbd5e1; background:#ffe699; padding:8px; font-weight:700;">9</td>
                                <td style="border:1px solid #cbd5e1; background:#f4b183; padding:8px; font-weight:700;">12</td>
                                <td style="border:1px solid #cbd5e1; background:#f4b183; padding:8px; font-weight:700;">15</td>
                            </tr>
                            <tr>
                                <td style="border:1px solid #cbd5e1; background:#f1f5f9; font-weight:700; padding:6px; text-align:center; font-size:0.7rem; color:#1e293b;">2 Minor</td>
                                <td style="border:1px solid #cbd5e1; background:#00b050; padding:8px; font-weight:700; color:#ffffff;">2</td>
                                <td style="border:1px solid #cbd5e1; background:#00b050; padding:8px; font-weight:700; color:#ffffff;">4</td>
                                <td style="border:1px solid #cbd5e1; background:#ffe699; padding:8px; font-weight:700;">6</td>
                                <td style="border:1px solid #cbd5e1; background:#ffe699; padding:8px; font-weight:700;">8</td>
                                <td style="border:1px solid #cbd5e1; background:#f4b183; padding:8px; font-weight:700;">10</td>
                            </tr>
                            <tr>
                                <td style="border:1px solid #cbd5e1; background:#f1f5f9; font-weight:700; padding:6px; text-align:center; font-size:0.7rem; color:#1e293b;">1 Insignificant</td>
                                <td style="border:1px solid #cbd5e1; background:#00b050; padding:8px; font-weight:700; color:#ffffff;">1</td>
                                <td style="border:1px solid #cbd5e1; background:#00b050; padding:8px; font-weight:700; color:#ffffff;">2</td>
                                <td style="border:1px solid #cbd5e1; background:#00b050; padding:8px; font-weight:700; color:#ffffff;">3</td>
                                <td style="border:1px solid #cbd5e1; background:#00b050; padding:8px; font-weight:700; color:#ffffff;">4</td>
                                <td style="border:1px solid #cbd5e1; background:#ffe699; padding:8px; font-weight:700;">5</td>
                            </tr>
                        </table>
                        <div style="display:flex; gap:12px; justify-content:center; font-size:0.75rem; flex-wrap:wrap;">
                            <div style="display:flex; align-items:center; gap:4px;">
                                <div style="width:16px; height:16px; background:#00b050; border:1px solid #cbd5e1;"></div>
                                <span>Low (1-4)</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:4px;">
                                <div style="width:16px; height:16px; background:#ffe699; border:1px solid #cbd5e1;"></div>
                                <span>Medium (5-9)</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:4px;">
                                <div style="width:16px; height:16px; background:#f4b183; border:1px solid #cbd5e1;"></div>
                                <span>High (10-15)</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:4px;">
                                <div style="width:16px; height:16px; background:#c00000; border:1px solid #cbd5e1;"></div>
                                <span>Critical (16-25)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="overflow-x:auto;">
                <table id="riskTable" style="width:100%; border-collapse:collapse; margin-bottom:16px; min-width: 1500px;">
                    <thead>
                        <tr style="background:var(--primary-light); border-bottom:2px solid var(--primary);">
                            <th style="padding:12px; text-align:center; font-weight:700; width:3%;">S.N.</th>
                            <th style="padding:12px; text-align:left; font-weight:700; width:11%;">Hazard / Risk</th>
                            <th style="padding:12px; text-align:left; font-weight:700; width:11%;">Impact / Consequence</th>
                            <th style="padding:12px; text-align:center; font-weight:700; width:6%;">Likelihood</th>
                            <th style="padding:12px; text-align:center; font-weight:700; width:6%;">Consequence</th>
                            <th style="padding:12px; text-align:center; font-weight:700; width:7%;">Initial Risk</th>
                            <th style="padding:12px; text-align:left; font-weight:700; width:22%;">Risk Controls</th>
                            <th style="padding:12px; text-align:center; font-weight:700; width:6%;">Likelihood</th>
                            <th style="padding:12px; text-align:center; font-weight:700; width:6%;">Consequence</th>
                            <th style="padding:12px; text-align:center; font-weight:700; width:7%;">Residual Risk</th>
                            <th style="padding:12px; text-align:left; font-weight:700; width:10%;">Risk Owner</th>
                            <th style="padding:12px; text-align:center; font-weight:700; width:3%;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="riskTableBody">
                    </tbody>
                </table>
            </div>
            
            <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
                <button class="btn btn-outline btn-sm" onclick="addRiskRow()">
                    + Add Custom Risk Factor
                </button>
                <button class="btn btn-outline btn-sm" onclick="clearRiskTable()" style="background:#fee2e2; border-color:#ef4444; color:#991b1b;">
                    🗑️ Clear All Rows
                </button>
            </div>
        </div>

        <!-- Risk Assessment Notes Section -->
        <div class="card" style="margin-bottom:24px;">
            <h3 style="margin-bottom:16px;">Risk Assessment Notes</h3>
            <p style="color:var(--text-sub); margin-bottom:16px; font-size:0.95rem;">Add additional notes or observations related to this risk assessment.</p>
            
            <div id="riskNotesContainer" style="margin-bottom:16px;">
                <!-- Notes will be added here dynamically -->
            </div>
            
            <div style="display:flex; gap:8px; margin-top:12px;">
                <button class="btn btn-outline" onclick="addRiskNote()" style="display:inline-flex; align-items:center; gap:6px;">
                    <span style="font-size:1.2rem;">+</span> Add Note
                </button>
            </div>
        </div>

        <div class="card" style="margin-bottom:24px;">
            <h3 style="margin-bottom:16px;">Risk Summary</h3>
            <div id="riskSummary" style="padding:16px; background:var(--bg-body); border-radius:8px; border:1px solid var(--border-color);">
                <p style="color:var(--text-sub); margin:0;">Complete the risk assessment above to view summary.</p>
            </div>
        </div>

        <div class="card admin-only" style="margin-bottom:24px;">
            <h3 style="margin-bottom:16px;">Sign-off</h3>
            <div style="background:var(--bg-body); padding:20px; border-radius:8px; border:1px solid var(--border-color);">
                <div class="input-grid" style="margin-bottom:16px;">
                    <div class="form-group">
                        <label>Prepared by</label>
                        <input type="text" id="preparedBy" placeholder="Enter name">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="preparedDate">
                    </div>
                </div>
                <div class="input-grid" style="margin-bottom:16px;">
                    <div class="form-group">
                        <label>Reviewed by</label>
                        <input type="text" id="reviewedBy" placeholder="Enter name">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="reviewedDate">
                    </div>
                </div>
                <div class="input-grid">
                    <div class="form-group">
                        <label>Approved by</label>
                        <input type="text" id="approvedBy" placeholder="Enter name">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="approvedDate">
                    </div>
                </div>
            </div>
        </div>

        <div style="display:flex; gap:12px; justify-content:flex-end; flex-wrap:wrap;">
            <button class="btn btn-outline internal-only" onclick="generateRiskReport()">
                📄 Generate Risk Assessment Report
            </button>
            <button class="btn navigation-allowed" onclick="proceedToBarrierSelection()">
                Continue to Barrier Selection →
            </button>
        </div>
    </div>

    <!-- STAGE 2: Barrier Selection -->
    <div id="stage2" style="display:none;">
        <div class="filter-panel">
            <div style="margin-bottom:15px;">
                <button class="btn btn-outline no-print navigation-allowed" onclick="backToStage1()">← Back to Risk Assessment</button>
            </div>
            
            <div class="stage1-tabs">
                <button id="tabBarriers" class="tab-btn active" onclick="switchStage1Tab('barrier')">Longitudinal Barriers</button>
                <button id="tabTerminals" class="tab-btn" onclick="switchStage1Tab('terminal')">End Treatments</button>
            </div>
            
            <div style="margin-bottom:20px;">
                <button id="btnShowFavs" class="btn btn-outline btn-sm" onclick="toggleFavFilter()" style="border-radius:20px; font-size:0.9rem;">
                    <span>★</span> Show Favorites Only
                </button>
            </div>

            <h3 style="margin-top:0;" id="filterTitle">1. Site Constraints</h3>
            <div class="input-grid">
                <div class="form-group">
                    <label>Avail Width (m)</label>
                    <input type="number" id="siteWidth" placeholder="e.g. 3.5" step="0.1">
                </div>
            </div>
            <input type="hidden" id="siteSpeed" value="">
            <div style="margin-top: 12px;">
              <button class="btn btn-auto" type="button" onclick="filterBarriers()">Search</button>
              <button class="btn btn-outline btn-auto" type="button" onclick="clearAllFilters()" style="margin-left: 8px;">Clear All</button>
            </div>
              <div id="autoTLNote" class="filter-note">All items shown. Enter available width, then choose "Search" to refine the list.</div>

            <!-- Additional Filters (Compact) -->
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0;">More filter options </h3>
                    </div>
            <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:15px; background:#f8fafc; padding:15px; border-radius:8px; align-items:flex-end;">
                <div style="flex:1; min-width:140px;">
                    <label style="display:block; font-size:0.8rem; font-weight:600; color:#64748b; margin-bottom:5px;">MASH Test Level</label>
                    <select id="mashFilters" class="filter-select" onchange="updateFilterFromSelect('mash', this)" style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:4px;">
                        <option value="">All Levels</option>
                    </select>
                </div>
                <div style="flex:1; min-width:140px;">
                    <label style="display:block; font-size:0.8rem; font-weight:600; color:#64748b; margin-bottom:5px;">Material Type</label>
                    <select id="materialFilters" class="filter-select" onchange="updateFilterFromSelect('material', this)" style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:4px;">
                        <option value="">All Materials</option>
                    </select>
                </div>
                <div style="flex:1; min-width:140px;">
                    <label style="display:block; font-size:0.8rem; font-weight:600; color:#64748b; margin-bottom:5px;">Barrier Category</label>
                    <select id="categoryFilters" class="filter-select" onchange="updateFilterFromSelect('category', this)" style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:4px;">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div style="flex:1; min-width:140px;">
                    <label style="display:block; font-size:0.8rem; font-weight:600; color:#64748b; margin-bottom:5px;">Special Features</label>
                    <select id="featureFilters" class="filter-select" onchange="updateFilterFromSelect('features', this)" style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:4px;">
                        <option value="">All Features</option>
                    </select>
                </div>
              <div style="flex:1; min-width:140px;">
                <label style="display:block; font-size:0.8rem; font-weight:600; color:#64748b; margin-bottom:5px;">Supplier</label>
                <select id="supplierFilters" class="filter-select" onchange="updateFilterFromSelect('supplier', this)" style="width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:4px;">
                  <option value="">All Suppliers</option>
                </select>
              </div>
            </div>

            <div class="filter-mini" style="margin-top:10px; background:#f8fafc; padding:12px; border-radius:8px; border:1px solid #e2e8f0;">
              <div class="form-group">
                <label>Max Deflection (m)</label>
                <input type="number" id="deflMaxFilter" step="0.01" placeholder="e.g. 1.5" oninput="updateNumericFilter('deflMax', this.value)">
              </div>
              <div class="form-group">
                <label>Max Working Width (m)</label>
                <input type="number" id="wwMaxFilter" step="0.01" placeholder="e.g. 2.0" oninput="updateNumericFilter('wwMax', this.value)">
              </div>
            </div>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0;">Available Items (<span id="countDisplay">0</span>)</h3>
            <button class="btn btn-outline btn-auto" onclick="showAllBarriers()">Show All Items</button>
        </div>
        
        <div style="margin-bottom:15px; padding:10px 12px; background:#f0f9ff; border:1px solid #bae6fd; border-radius:6px; display:flex; align-items:center; gap:8px;">
            <span style="font-size:0.9rem; color:#0369a1;">📋</span>
            <span style="font-size:0.9rem; color:#0c4a6e; flex:1;">TMR Master Document:</span>
            <a href="https://drive.google.com/file/d/1CS9_LMbzimHk5tiEhArxSBEKRgGFubXh/view?usp=sharing" target="_blank" style="color:#0284c7; text-decoration:none; font-weight:600; font-size:0.9rem; display:flex; align-items:center; gap:4px;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">
                View All Barriers & End Treatments
                <span style="font-size:0.75rem;">↗</span>
            </a>
        </div>
        
        <div style="margin-bottom:20px; display:flex; gap:10px;">
            <input type="text" id="barrierNameSearch" placeholder="Search by name..." style="padding:10px; border:1px solid #cbd5e1; border-radius:6px; flex:1;" oninput="filterBarriers()">
        </div>

        <div id="quickFavorites" class="quick-picks"></div>
        <div id="quickRecents" class="quick-picks"></div>

        <div id="barrierGrid" class="barrier-grid"></div>

        <!-- COMPARISON BAR -->
        <div id="compareBar" style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#1e293b; color:white; padding:16px 24px; border-radius:99px; box-shadow:0 10px 25px -5px rgba(0,0,0,0.3); align-items:center; gap:20px; z-index:1000;">
            <div style="font-weight:600;"><span id="compareCount">0</span> selected for comparison</div>
            <button class="btn btn-sm" style="background:white; color:#0f172a; padding:8px 16px; font-size:0.9rem;" onclick="showComparison()">Compare Now</button>
            <button class="btn-link" style="color:#94a3b8; font-size:1.2rem; padding:0;" onclick="clearComparison()">×</button>
        </div>

        <!-- COMPARISON MODAL -->
        <div id="compareModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
             <div style="background:white; width:90%; max-width:900px; max-height:90vh; border-radius:12px; display:flex; flex-direction:column; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);">
                 <div style="padding:20px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
                     <h3 style="margin:0;">Barrier Comparison</h3>
                     <button class="btn-link" onclick="closeComparison()" style="color:#64748b; font-size:1.5rem;">×</button>
                 </div>
                 <div id="compareContent" style="padding:20px; overflow-y:auto;"></div>
             </div>
        </div>

      </div>

    <!-- STAGE 3: Calculations -->
    <div id="stage3" class="calc-container">
        
        <div class="panel" id="inputsPanel">
            <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
              <button class="btn btn-outline no-print navigation-allowed" style="flex:1; min-width:140px;" onclick="backToSelection()">← Back to Selection</button>
              <button class="btn btn-outline no-print" style="flex:1; min-width:140px;" onclick="generateShareLink()">🔗 Share</button>
              <button class="btn no-print navigation-allowed" style="flex:1; min-width:140px;" onclick="goToStage4()">Next: End Treatment →</button>
            </div>
            <h2 id="barrierNameDisplay" style="margin-top:0; color:var(--primary); font-size: 1.25rem;">-</h2>
            <div id="supplierDisplay" style="font-size:0.85rem; color:var(--secondary); margin-bottom:15px;">-</div>
            
            <a id="imgSearchLink" href="#" target="_blank" class="image-preview" title="Search Google Images">
                <div class="image-icon">📷</div>
                <div class="image-text">Find Images</div>
                <div style="font-size:0.7rem; color:#64748b; margin-top:4px; text-align:center;">
                    Search: <span id="searchQueryDisplay">Supplier + Name</span>
                </div>
            </a>
            
            <div id="extraImageSearch" style="display:none; text-align:center; margin-bottom:24px; margin-top:-16px;">
                <a id="extraSearchLink" href="#" target="_blank" class="btn-link" style="font-size:0.85rem;">
                   🔍 Search Google for more Images
                </a>
            </div>

            <div id="terminalDetailsDisplay" style="display:none; margin-bottom: 20px;">
                <div class="section-title" style="margin-top:0;">Specifications</div>
                <div class="form-group"><label>Type</label><input type="text" id="termFullType" class="readonly" readonly></div>
                <div class="form-group"><label>MASH TL</label><input type="text" id="termTL" class="readonly" readonly></div>
                 <div class="form-group"><label>Test Speed</label><input type="text" id="termSpeed" class="readonly" readonly></div>
                <div class="form-group"><label>Deflection</label><input type="text" id="termDefl" class="readonly" readonly></div>
                <div class="form-group"><label>Working Width</label><input type="text" id="termWW" class="readonly" readonly></div>
                <div class="form-group"><label>System Width</label><input type="text" id="termWidth" class="readonly" readonly></div>
                <div class="form-group"><label>Test Length</label><input type="text" id="termLen" class="readonly" readonly></div>
            </div>

            <div id="calcInputSection">
            <div class="section-title" style="margin-top:0;">Impact Parameters</div>
            <div class="form-group">
                <label>Mass (kg)</label>
                <input type="number" id="inMass" value="2270" oninput="markCalcDirty()">
            </div>
            <div class="form-group">
                <label>Test Speed (km/h)</label>
                <input type="number" id="inSpeed" class="readonly" value="" readonly>
            </div>
            <div class="form-group">
                <label>Angle (°)</label>
                <input type="number" id="inAngle" value="25" oninput="markCalcDirty()">
            </div>
            <hr class="energy-separator">
            <div class="form-group">
                <label>Calculated Impact Energy (kJ)</label>
                <input type="text" id="outEnergy" class="readonly calc-highlight" readonly>
            </div>

            <div class="section-title">Barrier Config</div>
            <div class="barrier-config-grid">
                <div class="form-group">
                    <label>Test Len (m)</label>
                    <input type="text" id="valTestLength" class="readonly" readonly>
                </div>
                <div class="form-group">
                    <label>Design Len (m)</label>
                  <input type="number" id="inDesignLength" value="30" oninput="markCalcDirty()">
                </div>
                <div class="form-group">
                    <label>Friction</label>
                  <input type="number" id="inFriction" value="0.4" step="0.1" oninput="markCalcDirty()">
                </div>
                <div class="form-group">
                    <label>System Width (m)</label>
                    <input type="text" id="valSystemWidth" class="readonly" readonly>
                </div>
                <div class="form-group">
                    <label>Design Allowance (m)</label>
                    <input type="text" id="valWidthAllowance" class="readonly" readonly>
                </div>
            </div>

            <div class="section-title">Unit Specs</div>
            <div class="form-group" id="containerUnitLength">
                <label>Length (m)</label>
                <input type="number" id="inUnitLength" value="6" oninput="markCalcDirty()">
            </div>
            <div class="form-group" id="containerUnitWeight">
                <label>Wt (Tonnes)</label>
                <input type="number" id="inUnitWeightT" value="0.6" step="0.1" oninput="markCalcDirty()">
            </div>
            <div class="form-group" id="containerUnitWeightKg">
                <label>Wt (kg)</label>
                <input type="text" id="outUnitWeightKg" class="readonly" readonly>
            </div>

              <button id="applyCalcBtn" class="btn no-print" style="display:none; margin: 10px 0 20px 0;" onclick="applyCalcUpdates()">Update Calculations</button>
            </div>

            <a id="techSheetLink" href="#" target="_blank" class="btn" style="display:inline-flex; align-items:center; gap:6px;">
                <span>📄</span> View Tech Sheet
            </a>
            <a id="manuSpecLink" href="#" target="_blank" class="btn" style="display:none; align-items:center; gap:6px; margin-top: 10px; background-color: #64748b;">
                <span>🏭</span> Manufacturer's Specs
            </a>
            <a id="installVideoLink" href="#" target="_blank" class="btn" style="display:none; align-items:center; gap:6px; margin-top: 10px; background-color: #dc2626;">
                <span>🎥</span> Installation Process
            </a>
            <a id="manuWebsiteLink" href="#" target="_blank" class="btn" style="display:none; align-items:center; gap:6px; margin-top: 10px; background-color: #0ea5e9;">
              <span>🌐</span> Manufacturer Website
            </a>
            <div id="linkHealthNote" class="link-health"></div>
        </div>

        <div class="panel" id="resultsPanel" style="background: #f8fafc; border:none; padding:0;">
          <div class="results-card" id="resultsCard">
            <div class="results-header">
              <h4>Estimated Results</h4>
              <div class="design-speed-input">
                <label for="designSpeedInput">Design Speed (km/h)</label>
                <input type="number" id="designSpeedInput" step="1" min="0" placeholder="e.g. 80" oninput="onDesignSpeedInput()">
              </div>
            </div>
            <div class="res-row">
              <span class="res-label">Base Deflection:</span>
              <span class="res-val" id="resBaseDefl">-</span>
            </div>
            <div class="res-row">
              <span class="res-label">Base Working Width:</span>
              <span class="res-val" id="resBaseWW">-</span>
            </div>
            <div class="res-sub">(Before length correction)</div>

            <div style="margin: 10px 0; border-top:1px solid #334155;"></div>

            <div class="res-row">
              <span class="res-label">Units Displaced:</span>
              <span class="res-val" id="resUnits">-</span>
            </div>

            <div style="margin: 10px 0; border-top:1px solid #334155;"></div>

            <div class="res-row">
              <span class="res-label">Design Deflection:</span>
              <span class="res-val" id="resDesignDefl">-</span>
            </div>
            <div class="res-row">
              <span class="res-label">Design Working Width:</span>
              <span class="res-val" id="resDesignWW">-</span>
            </div>
            <div class="res-sub">(Corrected for Design Length)</div>

          </div>

          <div id="techSheetPreview" class="tech-preview" style="display:none; margin:16px 24px 0 24px;">
            <div class="tech-preview-header">
              <div>
                <div class="tech-preview-title">Tech Sheet Preview</div>
                <p class="tech-preview-note">Loaded automatically when a barrier is selected. Use the buttons to reload or open full screen.</p>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                <button class="btn btn-outline btn-auto" type="button" onclick="reloadTechSheetPreview()">Reload</button>
                <button class="btn btn-outline btn-auto" type="button" onclick="openTechSheetFullscreen()">Full Screen</button>
              </div>
            </div>
            <iframe id="techSheetFrame" class="tech-preview-frame" title="Tech sheet preview"></iframe>
            <div id="techSheetEmpty" class="tech-preview-empty" style="display:none;">No tech sheet available for this item.</div>
          </div>

          <div id="layoutPanel" style="margin: 16px 24px; background:#fff; border:1px solid #e2e8f0; border-radius:10px; padding:14px; box-shadow:var(--shadow-sm);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
              <h3 style="margin:0; font-size:1rem;">Layout Optimizer</h3>
              <span style="font-size:0.85rem; color:var(--secondary);">Length / width fit</span>
            </div>
            <div class="filter-mini" style="margin:0; background:#f8fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0;">
              <div class="form-group">
                <label>Target Run Length (m)</label>
                <input type="number" id="layoutTargetLength" step="0.1" placeholder="e.g. 80" oninput="renderLayoutSummary()">
              </div>
              <div class="form-group">
                <label>Available Corridor Length (m)</label>
                <input type="number" id="layoutRunLength" step="0.1" placeholder="optional" oninput="renderLayoutSummary()">
              </div>
              <div class="form-group">
                <label>Available Width (m)</label>
                <input type="number" id="layoutWidthAvail" step="0.01" placeholder="auto uses Stage 2" oninput="renderLayoutSummary()">
              </div>
              <div class="form-group">
                <label>Available Work Area (m)</label>
                <input type="number" id="layoutWorkArea" step="0.01" placeholder="optional" oninput="renderLayoutSummary()">
              </div>
              <div class="form-group" style="max-width:180px;">
                <label style="visibility:hidden;">Action</label>
                <button class="btn btn-auto" type="button" onclick="renderLayoutSummary()">Optimize</button>
              </div>
            </div>
            <div id="layoutSummary" style="font-size:0.95rem; color:#0f172a; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:12px; margin-top:10px;">Enter a target length to see a unit mix.</div>
          </div>

          <div id="validationHints" style="margin: 0 24px 16px 24px; background:#fefce8; border:1px solid #fef08a; border-radius:10px; padding:12px; color:#713f12; font-size:0.95rem; box-shadow:var(--shadow-xs);">
            Validation hints will appear here after you run a calculation or pick an end treatment.
          </div>

          <div style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; padding:0 24px;">
                <h2 style="margin:0;">Analysis Matrix</h2>
                <div style="font-size:0.8rem; color:var(--secondary);">
                    Red values exceed available width.
                </div>
            </div>

            <div id="matrixLegend" class="info-banner">
              <div class="legend-row">
                <span class="status-pill highlight">Highlighted row = your design speed/angle</span>
                <span class="status-pill warn">Red = exceeds available width</span>
                <span class="status-pill note" id="matrixLegendWidth">Width limit not set</span>
                <span class="status-pill note">Req. Energy scales deflection to your design length</span>
              </div>
              <div class="legend-row" id="dataHealthSummary"></div>
            </div>

            <div class="scenario-toolbar no-print">
              <button class="btn btn-auto" onclick="saveScenarioSnapshot()">Save Scenario Snapshot</button>
              <div class="spacer" style="flex:1;"></div>
              <button id="exportJsonBtn" class="btn btn-outline btn-auto" style="display:none; margin-right:8px;" onclick="exportScenariosToJSON()">Export JSON</button>
              <button id="exportCsvBtn" class="btn btn-outline btn-auto" style="display:none; margin-right:8px;" onclick="exportScenariosToCSV()">Export CSV</button>
              <button id="importJsonBtn" class="btn btn-outline btn-auto" style="display:none; margin-right:8px;" onclick="document.getElementById('importScenariosInput').click()">Import JSON</button>
              <input type="file" id="importScenariosInput" accept="application/json" style="display:none;" onchange="handleScenarioImport(event)">
              <button id="clearScenariosBtn" class="btn btn-outline btn-auto" style="display:none;" onclick="clearSavedScenarios()">Clear All</button>
            </div>
            <div id="savedScenariosContainer"></div>

            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('deflection')">Deflection Table</button>
                <button class="tab-btn" onclick="switchTab('ww')">Working Width Table</button>
            </div>

            <div id="matrixContainer"></div>
            <div id="printMatrixContainer" class="print-only"></div>
          </div>
        </div>

        <!-- GLOSSARY MODAL (global) -->
        <div id="glossaryModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
           <div style="background:white; width:90%; max-width:600px; max-height:90vh; border-radius:12px; display:flex; flex-direction:column; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);">
             <div style="padding:20px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
               <h3 style="margin:0;">Definitions & Glossary</h3>
               <button class="btn-link" onclick="closeGlossary()" style="color:#64748b; font-size:1.5rem;">×</button>
             </div>
             <div style="padding:20px; overflow-y:auto;">
              <dl style="display:grid; grid-template-columns:auto 1fr; gap:10px 20px; align-items:baseline;">
                <!-- MASH / Standards -->
                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">MASH</dt>
                <dd style="margin:0; grid-column:2;"><strong>Manual for Assessing Safety Hardware.</strong> The current international standard (AASHTO) for evaluating safety hardware devices.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Test Level (TL)</dt>
                <dd style="margin:0; grid-column:2;">
                  Indicates crash test severity under MASH guidelines:
                  <div style="display:grid; grid-template-columns: auto 1fr; gap: 4px 15px; margin-top:5px; font-size:0.9em; padding:8px; background:#f8fafc; border-radius:6px; border:1px solid #e2e8f0;">
                    <strong>TL-1:</strong> <span>50 km/h (Work zones, low speed)</span>
                    <strong>TL-2:</strong> <span>70 km/h (Local/Collectors)</span>
                    <strong>TL-3:</strong> <span>100 km/h (Highways/Arterials - 2,270kg pickup)</span>
                    <strong>TL-4:</strong> <span>100 km/h (Rigid Truck - 10,000kg)</span>
                    <strong>TL-5:</strong> <span>80 km/h (Articulated Van - 36,000kg)</span>
                    <strong>TL-6:</strong> <span>80 km/h (Tanker Truck)</span>
                  </div>
                </dd>

                <div style="grid-column:1/-1; border-top:1px solid #e2e8f0; margin:10px 0;"></div>

                <!-- Performance -->
                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Dynamic Deflection</dt>
                <dd style="margin:0; grid-column:2;">The maximum lateral displacement of the barrier <em>system itself</em> (traffic face) from its original position during a crash test.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Working Width</dt>
                <dd style="margin:0; grid-column:2;">Maximum lateral distance from the traffic-side face of the barrier to the furthest extent of any part of the barrier or vehicle during impact.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">System Width</dt>
                <dd style="margin:0; grid-column:2;">Physical width of the barrier footprint (nose to traffic face), excluding deflection/working width.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Available Width</dt>
                <dd style="margin:0; grid-column:2;">The total clear width available between the traffic lane and the hazard/edge. Must exceed system width + deflection.</dd>

                <div style="grid-column:1/-1; border-top:1px solid #e2e8f0; margin:10px 0;"></div>

                <!-- Intrusion / Envelope -->
                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Zone of Intrusion</dt>
                <dd style="margin:0; grid-column:2;">Region above/behind the barrier where vehicle components (e.g., tray) may sweep during impact; critical for sign/pier placement.</dd>

                <div style="grid-column:1/-1; border-top:1px solid #e2e8f0; margin:10px 0;"></div>

                <!-- Geometry / Length -->
                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Test Length</dt>
                <dd style="margin:0; grid-column:2;">Barrier length installed during crash testing.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Design Length</dt>
                <dd style="margin:0; grid-column:2;">Length you will install on site; used to adjust deflection/working width (longer = less deflection).</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Length of Need</dt>
                <dd style="margin:0; grid-column:2;">Total length required to stop vehicles from reaching the hazard behind the barrier.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Runout Length</dt>
                <dd style="margin:0; grid-column:2;">Theoretical distance a vehicle travels after leaving the roadway before stopping; informs Length of Need.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Shy Line</dt>
                <dd style="margin:0; grid-column:2;">Offset from lane where drivers will not shy from roadside objects; items inside may slow/shift traffic.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Flare Rate</dt>
                <dd style="margin:0; grid-column:2;">Rate a barrier departs from the road edge (e.g., 30:1) to introduce terminals safely.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Units Displaced</dt>
                <dd style="margin:0; grid-column:2;">Estimated number of barrier units impacted/moving laterally for the selected design length.</dd>

                <div style="grid-column:1/-1; border-top:1px solid #e2e8f0; margin:10px 0;"></div>

                <!-- Terminals -->
                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Gating Terminal</dt>
                <dd style="margin:0; grid-column:2;">Allows end-on impacts to pass through into a clear runout area.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Non-Gating</dt>
                <dd style="margin:0; grid-column:2;">Captures/redirects end-on impacts, preventing penetration behind the system.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Redirective</dt>
                <dd style="margin:0; grid-column:2;">Contains and redirects impacting vehicles back toward traffic flow.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Transition</dt>
                <dd style="margin:0; grid-column:2;">Stiffening section that connects barrier systems of differing rigidity to prevent pocketing.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Anchor</dt>
                <dd style="margin:0; grid-column:2;">End assembly providing tensile capacity in flexible systems (e.g., wire rope, W-beam).</dd>

                <div style="grid-column:1/-1; border-top:1px solid #e2e8f0; margin:10px 0;"></div>

                <!-- Design & Configuration -->
                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Clear Zone</dt>
                <dd style="margin:0; grid-column:2;">Unobstructed, relatively flat area beyond the edge of the traveled way for errant vehicle recovery.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Lateral Offset</dt>
                <dd style="margin:0; grid-column:2;">Distance from edge of traveled way to traffic face of barrier; affects impact angle/severity.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Impact Angle</dt>
                <dd style="margin:0; grid-column:2;">Angle at which a vehicle strikes the barrier during crash testing (typically 25° for MASH TL-3).</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Impact Speed</dt>
                <dd style="margin:0; grid-column:2;">Vehicle speed at moment of barrier impact during crash testing (e.g., 100 km/h for MASH TL-3).</dd>

                <div style="grid-column:1/-1; border-top:1px solid #e2e8f0; margin:10px 0;"></div>

                <!-- Barrier Types -->
                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Portable Barrier</dt>
                <dd style="margin:0; grid-column:2;">Free-standing barrier unit that relies on mass/inertia for stability; can be relocated without site modification.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Semi-Permanent</dt>
                <dd style="margin:0; grid-column:2;">Barrier system requiring ground anchoring or connection to fixed infrastructure; intended for medium-term installations.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Rigid Barrier</dt>
                <dd style="margin:0; grid-column:2;">Barrier with minimal deflection during impact (e.g., concrete barriers); high containment with small working width.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Semi-Rigid</dt>
                <dd style="margin:0; grid-column:2;">Barrier that deflects moderately during impact (e.g., steel guardrail); balances containment and deceleration.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Flexible Barrier</dt>
                <dd style="margin:0; grid-column:2;">Barrier with significant deflection (e.g., cable/wire rope systems); requires large working width but gentler deceleration.</dd>

                <div style="grid-column:1/-1; border-top:1px solid #e2e8f0; margin:10px 0;"></div>

                <!-- Impact Performance -->
                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Containment</dt>
                <dd style="margin:0; grid-column:2;">Barrier's ability to capture and redirect an impacting vehicle without allowing penetration or override.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Redirection</dt>
                <dd style="margin:0; grid-column:2;">Process of guiding an impacting vehicle back parallel to the barrier and toward traffic flow.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Vehicle Stability</dt>
                <dd style="margin:0; grid-column:2;">Evaluation criteria ensuring vehicle doesn't roll, vault, or penetrate barrier during impact.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Occupant Risk</dt>
                <dd style="margin:0; grid-column:2;">Assessment of injury potential to vehicle occupants based on vehicle deceleration and compartment intrusion.</dd>

                <div style="grid-column:1/-1; border-top:1px solid #e2e8f0; margin:10px 0;"></div>

                <!-- Australian Standards -->
                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">AS 1742.3</dt>
                <dd style="margin:0; grid-column:2;">Australian Standard for Traffic Control for Works on Roads - Part 3 covering temporary barriers and delineation.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Austroads</dt>
                <dd style="margin:0; grid-column:2;">Association of road transport and traffic agencies in Australasia; publishes design guides and standards.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">MUTCD</dt>
                <dd style="margin:0; grid-column:2;">Manual of Uniform Traffic Control Devices - provides national consistency for traffic control device design and application.</dd>

                <div style="grid-column:1/-1; border-top:1px solid #e2e8f0; margin:10px 0;"></div>

                <!-- Installation & Maintenance -->
                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Connection Detail</dt>
                <dd style="margin:0; grid-column:2;">Method of joining adjacent barrier units; critical for load transfer and preventing separation during impact.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Ballast</dt>
                <dd style="margin:0; grid-column:2;">Additional weight (e.g., water, sand) added to portable barriers to increase mass and improve stability.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Pin & Loop</dt>
                <dd style="margin:0; grid-column:2;">Common connection method for portable barriers using steel pins through connection loops.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Retrofit</dt>
                <dd style="margin:0; grid-column:2;">Modification or upgrade to existing barrier system to improve performance or meet current standards.</dd>

                <div style="grid-column:1/-1; border-top:1px solid #e2e8f0; margin:10px 0;"></div>

                <!-- Site-Specific Terms -->
                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Protected Area</dt>
                <dd style="margin:0; grid-column:2;">Work zone, pedestrian area, or other space requiring shielding from errant vehicles.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Hazard</dt>
                <dd style="margin:0; grid-column:2;">Fixed object, drop-off, or other roadside feature that warrants barrier protection.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">TTC Zone</dt>
                <dd style="margin:0; grid-column:2;">Temporary Traffic Control Zone - area where road user conditions are altered due to work activity.</dd>

                <dt style="font-weight:700; color:#1e40af; grid-column:1; white-space:nowrap;">Buffer Zone</dt>
                <dd style="margin:0; grid-column:2;">Longitudinal and lateral distance maintained between barrier and workers/equipment for safety during deflection.</dd>
              </dl>
             </div>
           </div>
        </div>

    <!-- STAGE 4: End Treatment Selection -->
    <div id="stage4" class="calc-container" style="display:none; grid-template-columns: 1fr;">
        <div class="panel">
            <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
              <button class="btn btn-outline no-print navigation-allowed" style="flex:1; min-width:160px;" onclick="backToStage2()">← Back to Calculations</button>
            </div>
            <h2 style="color:var(--primary); margin-top:0;">Select End Treatment</h2>
            <p style="color:var(--secondary);">Please select the end treatment for this project from the list below.</p>
            
            <div style="margin-bottom:20px; display:flex; gap:10px;">
                <input type="text" id="etSearch" placeholder="Search end treatments..." style="padding:10px; border:1px solid #cbd5e1; border-radius:6px; flex:1;" oninput="renderEndTreatments()">
            </div>
            
            <div id="selectedEtDisplay" style="display:none; margin-bottom:20px; padding:15px; background:#eff6ff; border:1px solid #bfdbfe; border-radius:8px;">
                <div style="font-weight:700; font-size:1.1em; margin-bottom:5px;" id="etNameSelect"></div>
                <div style="color:#64748b; margin-bottom:10px;" id="etSupplierSelect"></div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <a id="etTechSheetLink" href="#" target="_blank" class="btn" style="display:none; font-size:0.9em; padding:6px 12px; align-items:center; gap:5px;">
                        <span>📄</span> Tech Sheet
                    </a>
                    <a id="etManufSheetLink" href="#" target="_blank" class="btn" style="display:none; font-size:0.9em; padding:6px 12px; align-items:center; gap:5px;">
                        <span>🏭</span> Manufacturer Spec
                    </a>
                  <a id="etManufWebsiteLink" href="#" target="_blank" class="btn" style="display:none; font-size:0.9em; padding:6px 12px; align-items:center; gap:5px; background-color:#0ea5e9;">
                    <span>🌐</span> Manufacturer Website
                  </a>
                </div>
            </div>

            <div id="etGrid" class="barrier-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- STAGE 5: End Treatment Details -->
    <div id="stage5" class="calc-container" style="display:none; grid-template-columns: 1fr;">
        <div class="panel">
            <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
              <button class="btn btn-outline no-print navigation-allowed" style="flex:1; min-width:160px;" onclick="backToStage3()">← Back to End Treatment</button>
              <button class="btn no-print internal-only" style="flex:1; min-width:160px;" onclick="goToStage7()">Next: Sign Off →</button>
            </div>
            <h2 style="color:var(--primary); margin-top:0;">End Treatment Details</h2>
            <div id="etDetailsReview" style="padding:20px; background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0;">
                 <h3 id="etReviewName" style="margin-top:0;"></h3>
                 <div id="etReviewSupplier" style="color:var(--secondary); margin-bottom:10px;"></div>
                 <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-top:15px;">
                      <div class="form-group"><label>Type</label><div id="etReviewType" class="readonly-text" style="padding:8px; background:white; border:1px solid #cbd5e1; border-radius:4px;">-</div></div>
                      <div class="form-group"><label>MASH TL</label><div id="etReviewTL" class="readonly-text" style="padding:8px; background:white; border:1px solid #cbd5e1; border-radius:4px;">-</div></div>
                      <div class="form-group"><label>Test Speed</label><div id="etReviewSpeed" class="readonly-text" style="padding:8px; background:white; border:1px solid #cbd5e1; border-radius:4px;">-</div></div>
                      <div class="form-group"><label>Width</label><div id="etReviewWidth" class="readonly-text" style="padding:8px; background:white; border:1px solid #cbd5e1; border-radius:4px;">-</div></div>
                      <div class="form-group"><label>Design Length</label><div id="etReviewLen" class="readonly-text" style="padding:8px; background:white; border:1px solid #cbd5e1; border-radius:4px;">-</div></div>
                      <div class="form-group"><label>Anchor/Post Spacing</label><div id="etReviewSpacing" class="readonly-text" style="padding:8px; background:white; border:1px solid #cbd5e1; border-radius:4px;">-</div></div>
                      <div class="form-group"><label>Post/Pin Type</label><div id="etReviewPin" class="readonly-text" style="padding:8px; background:white; border:1px solid #cbd5e1; border-radius:4px;">-</div></div>
                 </div>
            </div>

            <div id="widthVisual" class="width-visual" aria-label="Width and deflection visualization">
              <div style="font-weight:700; margin-bottom:8px; color:#0f172a;">Width / Deflection Overview</div>
              <div style="color:#475569; font-size:0.9rem; margin-bottom:6px;">Barrier width, end treatment width, design deflection, and working width shown to scale with dimension lines (relative).</div>
              <div id="widthVisualBody">Loading...</div>
            </div>

            <div id="widthSketchWrap" class="width-sketch" aria-label="Stage 3 layout sketch">
              <div class="width-sketch-header">
                <div class="width-sketch-title">Stage 3 Layout Sketch</div>
                <div style="display:flex; gap:10px; align-items:center;">
                  <button id="widthSketchDownload" class="btn btn-outline" style="padding:6px 12px;" onclick="downloadWidthSketch()">Download as Image</button>
                </div>
              </div>
              <div class="input-grid" style="margin: 10px 0 0 0;">
                <div class="form-group">
                  <label>Total Road Width (m)</label>
                  <input type="number" id="totalRoadWidth" step="0.01" placeholder="e.g. 8.5" oninput="renderWidthVisual()">
                </div>
                <div class="form-group">
                  <label>Total Verge/Footpath Width (m)</label>
                  <input type="number" id="totalVergeWidth" step="0.01" placeholder="e.g. 3.5" oninput="renderWidthVisual()">
                </div>
                <div class="form-group">
                  <label>Remaining Road Width (m)</label>
                  <input type="number" id="remainingRoadWidth" step="0.01" placeholder="e.g. 3.0" oninput="renderWidthVisual()">
                </div>
                <div class="form-group">
                  <label>Total Length for Consideration (m)</label>
                  <input type="text" id="totalConsiderationWidth" class="readonly" readonly>
                </div>
                <div class="form-group">
                  <label>Work Area (m)</label>
                  <input type="text" id="computedWorkArea" class="readonly" readonly>
                </div>
              </div>
              <div id="widthSketch">Run Stage 3 calculation to view sketch.</div>
              <div class="width-sketch-note">Work area = (road + verge/footpath) - (working width + lateral clearance + remaining road width). Lateral clearance is fixed at 0.3 m.</div>
            </div>

            <div id="widthOverlayWrap" class="width-sketch" aria-label="Linear width overlay">
              <div class="width-sketch-header">
                <div class="width-sketch-title">Width Overlay </div>
                <div style="display:flex; gap:10px; align-items:center;">
                  <button id="widthOverlayDownload" class="btn btn-outline" style="padding:6px 12px;" onclick="downloadWidthOverlay()">Download as Image</button>
                </div>
              </div>
              <div id="widthOverlay">Run Stage 3 calculation to view overlay.</div>
              <div class="width-sketch-note">Blank background with dimension lines for available width, working width, barrier width, deflection, and clearance.</div>
            </div>

            <div id="longitudinalWrap" class="width-sketch" aria-label="Longitudinal view with end treatments">
              <div class="width-sketch-header">
                <div class="width-sketch-title">Longitudinal View (Barrier + End Treatment)</div>
                <div style="display:flex; gap:10px; align-items:center;">
                  <label style="display:flex; align-items:center; gap:6px; font-weight:600; color:#334155;">
                    <span>Ends:</span>
                    <select id="etEndsMode" onchange="renderLongitudinalView()" style="padding:6px 10px; border:1px solid #cbd5e1; border-radius:6px;">
                      <option value="single">Single end</option>
                      <option value="both">Both ends</option>
                    </select>
                  </label>
                  <label id="etSingleSideWrap" style="display:flex; align-items:center; gap:6px; font-weight:600; color:#334155;">
                    <span>Single-end side:</span>
                    <select id="etSingleSide" onchange="renderLongitudinalView()" style="padding:6px 10px; border:1px solid #cbd5e1; border-radius:6px;">
                      <option value="left">Left side</option>
                      <option value="right" selected>Right side</option>
                    </select>
                  </label>
                  <button class="btn btn-outline" style="padding:6px 12px;" onclick="addBufferLength()">Buffer Length</button>
                  <button id="longitudinalDownload" class="btn btn-outline" style="padding:6px 12px;" onclick="downloadLongitudinalView()">Download as Image</button>
                </div>
              </div>
              <div id="longitudinalView">Run Stage 3 calculation and select an end treatment to view the longitudinal line.</div>
              <div class="width-sketch-note">Blank background; shows barrier length with optional end treatment at one or both ends. For single-end mode, choose left or right side.</div>
            </div>
        </div>
    </div>

    <!-- STAGE 7: Sign Off & Print -->
    <div id="stage7" class="calc-container" style="display:none; grid-template-columns: 1fr;">
        <div class="panel" style="max-width:800px; margin:0 auto;">
            <button class="btn btn-outline no-print navigation-allowed" style="margin-bottom:15px; width:auto;" onclick="backToStage4()">← Back to End Treatment</button>
            <h2 style="color:var(--primary); margin-top:0;">Sign Off & Generate Report</h2>
            <p style="color:var(--secondary); margin-bottom:25px;">Please verify the details below and provided signature information before generating the PDF.</p>

            <!-- Project Information Block -->
            <div style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                <h3 style="margin-top:0; font-size:1rem; border-bottom:1px solid #cbd5e1; padding-bottom:10px; margin-bottom:15px;">Project Information</h3>
                <div class="input-grid" style="margin-bottom:0;">
                    <div class="form-group">
                        <label>Project Name / ID</label>
                        <input type="text" id="projName" placeholder="e.g. Highway Upgrade Sec 4">
                    </div>
                    <div class="form-group">
                        <label>Job Number</label>
                        <input type="text" id="projJobNum" placeholder="e.g. J-2024-001">
                    </div>
                    <div class="form-group">
                        <label>Site Location</label>
                        <input type="text" id="projLoc" placeholder="e.g. M1 Northbound Ch 12.5">
                    </div>
                </div>
            </div>

            <div style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 20px; border-radius: 8px;">
                <h3 style="margin-top:0; font-size:1rem; border-bottom:1px solid #cbd5e1; padding-bottom:10px; margin-bottom:15px;">Report Signatures</h3>
                <div class="form-row-3" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label>Designed by</label>
                        <input type="text" id="sigDesignedBy" value="Sanju Bhandari , TMD (OP-1569)">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="sigDate1">
                    </div>
                    <div class="form-group">
                        <label>Reviewed by</label>
                        <input type="text" id="sigReviewedBy" value="Aaron Kumar Anthony, TMD (OP-611)">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="sigDate2">
                    </div>
                </div>
            </div>

            <div style="margin-top:30px; display:flex; gap:15px; justify-content:center;">
                <button class="btn btn-auto planner-no-print admin-only" style="padding:15px 30px; font-size:1.1rem;" onclick="printReport()">🖨️ Sign & Print Report</button>
            </div>
        </div>
    </div>

  <div class="print-actions no-print" id="actionButtons">
    <!-- Visible in Stage 3 (Calculations) -->
    <button id="toStage3Btn" class="btn btn-auto navigation-allowed" style="display:none;" onclick="goToStage3()">Next: Select End Treatment</button>
    <!-- Visible in Stage 4 (End Treatment Selection) -->
    <button id="toStage4Btn" class="btn btn-auto navigation-allowed" style="display:none;" onclick="goToStage4()">Next: Review</button>
  </div>

  <div class="page-nav bottom no-print" id="pageNavBottom">
    <button type="button" id="prevPageBtnBottom" class="page-nav-btn" onclick="goToPreviousPage()">← Previous</button>
    <div id="pageNavTitleBottom" class="page-nav-title">Current: Risk Assessment</div>
    <button type="button" id="nextPageBtnBottom" class="page-nav-btn" onclick="goToNextPage()">Next →</button>
  </div>

  <footer class="app-footer no-print">© 2026 Sanju Bhandari. All rights reserved.</footer>
</div>
</div><!-- End mainApp -->

<div id="printReportOutput" class="print-only"></div>

<div id="printSignatureContainer" class="print-only" style="display:none;">
    <div class="signature-section">
        <div class="sig-row">
            <div class="sig-field main">
                <span class="sig-label">Designed by:</span>
                <div class="sig-input" id="printDesignBy">-</div>
            </div>
            <div class="sig-field date">
                <span class="sig-label">Date:</span>
                <div class="sig-input" id="printDate1">-</div>
            </div>
        </div>
        <div class="sig-row">
            <div class="sig-field main">
                <span class="sig-label">Reviewed by:</span>
                <div class="sig-input" id="printReviewBy">-</div>
            </div>
            <div class="sig-field date">
                <span class="sig-label">Date:</span>
                <div class="sig-input" id="printDate2">-</div>
            </div>
        </div>
    </div>
</div>

<script>
// DATA

// End Treatments (Mock Data for Stage 3)
const END_TREATMENTS = [
  {
    "id": 1,
    "name": "Absorb-M Plastic Crash Cushion",
    "supplier": "Safe Direction",
    "type": "Gating",
    "fullType": "Water Filled, Non-Redirective, Gating Plastic Terminal",
    "tl": "MASH TL-2",
    "testSpeed": 60,
    "defl": "N/A (Gating)",
    "ww": "N/A",
    "width": 0.67,
    "testLen": 5.29,
    "spacing": "Freestanding",
    "pinType": "N/A",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0031/425587/210607-TCU-ABSORB-M-Crash-Cushion.pdf",
    "manufLink": "https://drive.google.com/file/d/1FZ55JffSGO1zGWxZTiBZSr7tZ2v_TA1W/view?usp=sharing"
  },
  {
    "id": 2,
    "name": "Absorb-M Plastic Crash Cushion",
    "supplier": "Safe Direction",
    "type": "Gating",
    "fullType": "Water Filled, Non-Redirective, Gating Plastic Terminal",
    "tl": "MASH TL-3",
    "testSpeed": 80,
    "defl": "N/A (Gating)",
    "ww": "N/A",
    "width": 0.67,
    "testLen": 7.22,
    "spacing": "Freestanding",
    "pinType": "N/A",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0031/425587/210607-TCU-ABSORB-M-Crash-Cushion.pdf",
    "manufLink": "https://drive.google.com/file/d/1FZ55JffSGO1zGWxZTiBZSr7tZ2v_TA1W/view?usp=sharing"
  },
  {
    "id": 3,
    "name": "ArmorBuffa Plastic Water Filled Crash Cushion",
    "supplier": "Ingal Civil Products",
    "type": "Gating",
    "fullType": "Non-Redirective, Gating Plastic Water Filled End Treatment",
    "tl": "MASH TL-3",
    "testSpeed": 80,
    "defl": "N/A (Gating)",
    "ww": "N/A",
    "width": 0.46,
    "testLen": 9.313,
    "spacing": "Freestanding",
    "pinType": "N/A",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0024/444291/210903-TCU-ArmorBuffa-Crash-Cushion.pdf",
    "manufLink": "https://drive.google.com/file/d/1XMeu4A57SUpPbLaY-1P7bOvFBNQSjf_T/view?usp=sharing"
  },
  {
    "id": 4,
    "name": "ArmorBuffa Plastic Water Filled Crash Cushion",
    "supplier": "Ingal Civil Products",
    "type": "Gating",
    "fullType": "Non-Redirective, Gating Plastic Water Filled End Treatment",
    "tl": "MASH TL-2",
    "testSpeed": 70,
    "defl": "N/A (Gating)",
    "ww": "N/A",
    "width": 0.46,
    "testLen": 5.31,
    "spacing": "Freestanding",
    "pinType": "N/A",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0024/444291/210903-TCU-ArmorBuffa-Crash-Cushion.pdf",
    "manufLink": "https://drive.google.com/file/d/1XMeu4A57SUpPbLaY-1P7bOvFBNQSjf_T/view?usp=sharing"
  },
  {
    "id": 5,
    "name": "SLED Plastic Water Filled End Terminal",
    "supplier": "Saferoads Pty Ltd",
    "type": "Gating",
    "fullType": "Non-Redirective, Gating Plastic Water Filled End Treatment",
    "tl": "MASH TL-1",
    "testSpeed": 50,
    "defl": "N/A (Gating)",
    "ww": "N/A",
    "width": 0.7,
    "testLen": 3.85,
    "spacing": "Freestanding",
    "pinType": "N/A",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0022/391261/201205-TCU-SLED-Water-Filled-End-Terminal.pdf",
    "manufLink": "https://drive.google.com/file/d/1Xiw9-Iq6mzLj3DT0r5d-ywnETOk3_4FY/view?usp=sharing"
  },
  {
    "id": 6,
    "name": "SLED Plastic Water Filled End Terminal",
    "supplier": "Saferoads Pty Ltd",
    "type": "Gating",
    "fullType": "Non-Redirective, Gating Plastic Water Filled End Treatment",
    "tl": "MASH TL-2",
    "testSpeed": 70,
    "defl": "N/A (Gating)",
    "ww": "N/A",
    "width": 0.7,
    "testLen": 5.77,
    "spacing": "Freestanding",
    "pinType": "N/A",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0022/391261/201205-TCU-SLED-Water-Filled-End-Terminal.pdf",
    "manufLink": "https://drive.google.com/file/d/1Xiw9-Iq6mzLj3DT0r5d-ywnETOk3_4FY/view?usp=sharing"
  },
  {
    "id": 7,
    "name": "SLED Plastic Water Filled End Terminal",
    "supplier": "Saferoads Pty Ltd",
    "type": "Gating",
    "fullType": "Non-Redirective, Gating Plastic Water Filled End Treatment",
    "tl": "MASH TL-3",
    "testSpeed": 80,
    "defl": "N/A (Gating)",
    "ww": "N/A",
    "width": 0.7,
    "testLen": 7.92,
    "spacing": "Freestanding",
    "pinType": "N/A",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0022/391261/201205-TCU-SLED-Water-Filled-End-Terminal.pdf",
    "manufLink": "https://drive.google.com/file/d/1XMeu4A57SUpPbLaY-1P7bOvFBNQSjf_T/view?usp=sharing"
  },
  {
    "id": 8,
    "name": "Universal TAU-M Crash Cushion",
    "supplier": "Safe Direction",
    "type": "Redirective",
    "fullType": "Redirective Crash Cushion",
    "tl": "MASH TL-2",
    "testSpeed": 70,
    "defl": "Redirective",
    "ww": "Redirective",
    "width": 0.76,
    "testLen": 4.33,
    "spacing": "Refer to Drawings",
    "pinType": "Refer to Drawings",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0029/633386/240307-TCU-Universal-Tau-M-Crash-Cushion-Permanent-and-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1ibyoMMWi2NxCsLgRkkQcnYcCUugYy3-e/view?usp=sharing"
  },
  {
    "id": 9,
    "name": "Universal TAU-M Crash Cushion",
    "supplier": "Safe Direction",
    "type": "Redirective",
    "fullType": "Redirective Crash Cushion",
    "tl": "MASH TL-3",
    "testSpeed": 100,
    "defl": "Redirective",
    "ww": "Redirective",
    "width": 0.76,
    "testLen": 6.93,
    "spacing": "Refer to Drawings",
    "pinType": "Refer to Drawings",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0029/633386/240307-TCU-Universal-Tau-M-Crash-Cushion-Permanent-and-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1ibyoMMWi2NxCsLgRkkQcnYcCUugYy3-e/view?usp=sharing"
  },
  {
    "id": 10,
    "name": "TAU-XR Crash Cushion",
    "supplier": "Safe Direction",
    "type": "Redirective",
    "fullType": "Redirective Crash Cushion",
    "tl": "MASH TL-3",
    "testSpeed": 100,
    "defl": "Redirective",
    "ww": "Redirective",
    "width": 0.91,
    "testLen": 7.18,
    "spacing": "Refer to Drawings",
    "pinType": "Refer to Drawings",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0027/674910/240904-TCU-Tau-XR-Crash-Cushion.pdf",
    "manufLink": "https://drive.google.com/file/d/1mzfEKLJqgOfMsAXKj9cBqWwjZNGt1yCN/view?usp=sharing"
  },
  {
    "id": 11,
    "name": "ET-SS Guardrail End Terminal",
    "supplier": "Ingal Civil Products",
    "type": "Gating",
    "fullType": "Gating Terminal",
    "tl": "MASH TL-2",
    "testSpeed": 70,
    "defl": "Gating",
    "ww": "Gating",
    "width": 0.45,
    "testLen": 7.9,
    "spacing": "1.905",
    "pinType": "Driven or Baseplate",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0032/533849/221201-TCU-ET-SS-Terminal.pdf",
    "manufLink": "https://drive.google.com/file/d/1ibyoMMWi2NxCsLgRkkQcnYcCUugYy3-e/view?usp=sharing"
  },
  {
    "id": 12,
    "name": "ET-SS Guardrail End Terminal",
    "supplier": "Ingal Civil Products",
    "type": "Gating",
    "fullType": "Gating Terminal",
    "tl": "MASH TL-3",
    "testSpeed": 100,
    "defl": "Gating",
    "ww": "Gating",
    "width": 0.45,
    "testLen": 15.48,
    "spacing": "1.905",
    "pinType": "Driven or Baseplate",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0032/533849/221201-TCU-ET-SS-Terminal.pdf",
    "manufLink": "https://drive.google.com/file/d/1ibyoMMWi2NxCsLgRkkQcnYcCUugYy3-e/view?usp=sharing"
  },
  {
    "id": 13,
    "name": "MASH Sequential Kinking Terminal (MSKT)",
    "supplier": "Safe Direction",
    "type": "Gating",
    "fullType": "Gating Terminal",
    "tl": "MASH TL-2",
    "testSpeed": 70,
    "defl": "Gating",
    "ww": "Gating",
    "width": 0.51,
    "testLen": 9.5,
    "spacing": "1.905",
    "pinType": "Driven",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0027/633375/240307-TCU-MSKT-Permanent.pdf",
    "manufLink": "https://drive.google.com/file/d/1YFqXazu7cxIF4S0n6ipaXOOHmPFyRj3I/view?usp=sharing"
  },
  {
    "id": 14,
    "name": "MASH Sequential Kinking Terminal (MSKT)",
    "supplier": "Safe Direction",
    "type": "Gating",
    "fullType": "Gating Terminal",
    "tl": "MASH TL-3",
    "testSpeed": 100,
    "defl": "Gating",
    "ww": "Gating",
    "width": 0.51,
    "testLen": 14.29,
    "spacing": "1.905",
    "pinType": "Driven",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0027/633375/240307-TCU-MSKT-Permanent.pdf",
    "manufLink": "https://drive.google.com/file/d/1YFqXazu7cxIF4S0n6ipaXOOHmPFyRj3I/view?usp=sharing"
  },
  {
    "id": 15,
    "name": "MAX-Tension Guardrail Terminal",
    "supplier": "Safe Direction",
    "type": "Gating",
    "fullType": "Gating Terminal",
    "tl": "MASH TL-2",
    "testSpeed": 70,
    "defl": "Gating",
    "ww": "Gating",
    "width": 0.44,
    "testLen": 9.12,
    "spacing": "1.905",
    "pinType": "Driven or Baseplate",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0032/388247/201120-TCU-MAX-TENSION-Terminal.pdf",
    "manufLink": "https://drive.google.com/file/d/1NzEl1OWyiyhKfgG1YtUxzwMK37ZuHcjU/view?usp=sharing"
  },
  {
    "id": 16,
    "name": "MAX-Tension Guardrail Terminal",
    "supplier": "Safe Direction",
    "type": "Gating",
    "fullType": "Gating Terminal",
    "tl": "MASH TL-3",
    "testSpeed": 100,
    "defl": "Gating",
    "ww": "Gating",
    "width": 0.44,
    "testLen": 16.77,
    "spacing": "1.905",
    "pinType": "Driven or Baseplate",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0032/388247/201120-TCU-MAX-TENSION-Terminal.pdf",
    "manufLink": "https://drive.google.com/file/d/1NzEl1OWyiyhKfgG1YtUxzwMK37ZuHcjU/view?usp=sharing"
  },
  {
    "id": 17,
    "name": "Trend Median Terminal",
    "supplier": "Ingal Civil Products",
    "type": "Gating",
    "fullType": "Gating Terminal (Median)",
    "tl": "MASH TL-3",
    "testSpeed": 100,
    "defl": "Gating",
    "ww": "Gating",
    "width": 0.73,
    "testLen": 11.1,
    "spacing": "1.905",
    "pinType": "Driven",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0032/554855/230324-TCU-Trend-Median-Terminal.pdf",
    "manufLink": "https://drive.google.com/file/d/1WvlZui1G65iPq9xgH78fTmyTYGEi83wA/view?usp=sharing"
  },
  {
    "id": 18,
    "name": "QuadGuard M10 Crash Cushion",
    "supplier": "Ingal Civil Products",
    "type": "Redirective",
    "fullType": "Redirective Crash Cushion",
    "tl": "MASH TL-2",
    "testSpeed": 70,
    "defl": "Redirective",
    "ww": "Redirective",
    "width": 0.61,
    "testLen": 4.0,
    "spacing": "N/A",
    "pinType": "Refer to Drawings",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0032/406958/210304-TCU-QUADGUARD-M10-Crash-Cushion.pdf",
    "manufLink": "https://drive.google.com/file/d/1T6ToILuzcoIrEvrP87rx5FFrsyKu9if-/view?usp=sharing"
  },
  {
    "id": 19,
    "name": "QuadGuard M10 Crash Cushion",
    "supplier": "Ingal Civil Products",
    "type": "Redirective",
    "fullType": "Redirective Crash Cushion",
    "tl": "MASH TL-3",
    "testSpeed": 100,
    "defl": "Redirective",
    "ww": "Redirective",
    "width": 1.755,
    "testLen": 6.71,
    "spacing": "N/A",
    "pinType": "Refer to Drawings",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0032/406958/210304-TCU-QUADGUARD-M10-Crash-Cushion.pdf",
    "manufLink": "https://drive.google.com/file/d/1T6ToILuzcoIrEvrP87rx5FFrsyKu9if-/view?usp=sharing"
  },
  {
    "id": 20,
    "name": "QUADGUARD M10 CZ Crash Cushion",
    "supplier": "Ingal Civil Products",
    "type": "Redirective",
    "fullType": "Redirective Crash Cushion",
    "tl": "MASH TL-2",
    "testSpeed": 70,
    "defl": "Redirective",
    "ww": "Redirective",
    "width": 0.61,
    "testLen": 4.0,
    "spacing": "N/A",
    "pinType": "Refer to Drawings",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0019/444331/210906-TCU-QUADGUARD-M10-CZ-Crash-Cushion.pdf",
    "manufLink": "https://drive.google.com/file/d/1JRQWstGayd8QDaNqFmulJW9TZkPADdf1/view?usp=sharing"
  },
  {
    "id": 21,
    "name": "QUADGUARD M10 CZ Crash Cushion",
    "supplier": "Ingal Civil Products",
    "type": "Redirective",
    "fullType": "Redirective Crash Cushion",
    "tl": "MASH TL-3",
    "testSpeed": 100,
    "defl": "Redirective",
    "ww": "Redirective",
    "width": 0.61,
    "testLen": 6.71,
    "spacing": "N/A",
    "pinType": "Refer to Drawings",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0019/444331/210906-TCU-QUADGUARD-M10-CZ-Crash-Cushion.pdf",
    "manufLink": "https://drive.google.com/file/d/1JRQWstGayd8QDaNqFmulJW9TZkPADdf1/view?usp=sharing"
  },
  {
    "id": 22,
    "name": "QuadGuard Elite M10 Crash Cushion",
    "supplier": "Ingal Civil Products",
    "type": "Redirective",
    "fullType": "Redirective Crash Cushion",
    "tl": "MASH TL-3",
    "testSpeed": 100,
    "defl": "Redirective",
    "ww": "Redirective",
    "width": 0.61,
    "testLen": 8.3,
    "spacing": "N/A",
    "pinType": "Anchored",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0030/633378/240307-TCU-Quadguard-Elite-M10-Crash-Cushion-Permanent.pdf",
    "manufLink": "https://drive.google.com/file/d/145S4gU4vPa24odg_tGvOG_Dl1EMcFuj-/view?usp=sharing"
  },
  {
    "id": 23,
    "name": "Smart Cushion SCI100GM",
    "supplier": "LB Australia",
    "type": "Redirective",
    "fullType": "Redirective Crash Cushion",
    "tl": "MASH TL-2",
    "testSpeed": 70,
    "defl": "Redirective",
    "ww": "Redirective",
    "width": 0.61,
    "testLen": 4.2,
    "spacing": "N/A",
    "pinType": "Anchored",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0024/391236/201205-TCU-SMART-Steel-Crash-Cushion.pdf",
    "manufLink": "https://drive.google.com/file/d/1_36wbLHK4LcrWe-D9eN0ibK73JRxbt2W/view?usp=sharing"
  },
  {
    "id": 24,
    "name": "Smart Cushion SCI100GM",
    "supplier": "LB Australia",
    "type": "Redirective",
    "fullType": "Redirective Crash Cushion",
    "tl": "MASH TL-3",
    "testSpeed": 100,
    "defl": "Redirective",
    "ww": "Redirective",
    "width": 0.61,
    "testLen": 6.6,
    "spacing": "N/A",
    "pinType": "Anchored",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0024/391236/201205-TCU-SMART-Steel-Crash-Cushion.pdf",
    "manufLink": "https://drive.google.com/file/d/1_36wbLHK4LcrWe-D9eN0ibK73JRxbt2W/view?usp=sharing"
  },
  {
    "id": 25,
    "name": "Hercules Crash Cushion",
    "supplier": "Safe Direction",
    "type": "Redirective",
    "fullType": "Redirective Crash Cushion",
    "tl": "MASH TL-3",
    "testSpeed": 100,
    "defl": "Redirective",
    "ww": "Redirective",
    "width": 0.59,
    "testLen": 5.83,
    "spacing": "N/A",
    "pinType": "Anchored",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0022/444289/210903-TCU-Hercules-Crash-Cushion.pdf",
    "manufLink": "https://drive.google.com/file/d/1SfvSsfdRiD1n3AlI_LepNQltOJhjzRGJ/view?usp=sharing"
  },
  {
    "id": 26,
    "name": "Armorzone MASH End Treatment Unit",
    "supplier": "Ingal Civil Products",
    "type": "Gating",
    "fullType": "Water Filled, Non-Redirective, Gating End Treatment",
    "tl": "MASH TL-2",
    "testSpeed": 70,
    "defl": "N/A (Gating)",
    "ww": "N/A",
    "width": 0.45,
    "testLen": 2.0,
    "spacing": "Freestanding",
    "pinType": "N/A",
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0032/388283/201120-TCU-ARMORZONE-MASH-Water-Filled-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1Ts5JATyX2f5c3vzSMuRGIJ2oYpjW5HS0/view?usp=sharing",
    "unitWeight": 496
  },
  {
    "id": 27,
    "name": "Ricochet MASH TL1 Terminal End",
    "supplier": "Advantage Plastics",
    "type": "Gating",
    "fullType": "Non-Redirective, Gating Plastic End Terminal",
    "tl": "MASH TL-1",
    "testSpeed": 50,
    "defl": "N/A (Gating)",
    "ww": "N/A",
    "width": 0.58,
    "testLen": 1.7,
    "spacing": "Freestanding",
    "pinType": "N/A",
    "unitWeight": 580
  }
];
let selectedEndTreatment = null;

const highwayGuardMatrix = {
    speeds: [20, 40, 50, 60, 70, 80, 90, 100, 110, 120],
    angles: [5, 10, 15, 20, 25],
    data: [
        [0.001, 0.001, 0.001, 0.001, 0.003], 
        [0.005, 0.021, 0.048, 0.084, 0.129],
        [0.008, 0.034, 0.075, 0.132, 0.202],
        [0.012, 0.049, 0.109, 0.190, 0.291],
        [0.016, 0.067, 0.148, 0.260, 0.397],
        [0.021, 0.087, 0.194, 0.339, 0.518],
        [0.027, 0.111, 0.245, 0.429, 0.655],
        [0.033, 0.137, 0.303, 0.530, 0.809], 
        [0.040, 0.165, 0.366, 0.641, 0.979],
        [0.048, 0.195, 0.433, 0.758, 1.160]
    ]
};

const barriers = [
  // { id: 0, removed (PCB) }

  {
    "id": 1,
    "type": "barrier",
    "name": "DB80 K150 Precast Concrete Barrier",
    "supplier": "Jaybro Group Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.44,
    "ww": 1.94,
    "width": 0.57,
    "testLen": 61.17,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0018/433206/210720-TCU-DB80-K150-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1lYLtGalM1_uvM2uevyn4aOc75MevC3fC/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [2, 4, 6],
    "unitWeight": [1200, 2400, 3600]
  },
  {
    "id": 2,
    "type": "barrier",
    "name": "DB80 T150S Precast Concrete Barrier",
    "supplier": "Jaybro Group Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 0.81,
    "ww": 1.36,
    "width": 0.57,
    "testLen": 92.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0034/467467/211220-TCU-DB80-T150-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1LLi9Qu3Hp4SGl71314N8pcmX-vN5PVon/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [2, 4, 6],
    "unitWeight": [1050, 2100, 3150]
  },
  {
    "id": 3,
    "type": "barrier",
    "name": "DB80A T150S Precast Concrete Barrier",
    "supplier": "Jaybro Group Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 0.34,
    "ww": 0.91,
    "width": 0.57,
    "testLen": 68.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0029/533846/221201-TCU-DB80A-T150-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1LoZmf0q3aMfYDrtxSn72_EtX7TyoAbwA/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [2, 4, 6],
    "unitWeight": [1100, 2200, 3300]
  },
  {
    "id": 4,
    "type": "barrier",
    "name": "JJ Hooks MASH Precast Concrete Barrier",
    "supplier": "Australian Road Barriers",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.63,
    "ww": 2.23,
    "width": 0.61,
    "testLen": 59.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0025/480508/220314-TCU-3.6-M-JJ-Hooks-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1LUzvzR77MHrTHdq5TS7h2AnqIyhaYJHo/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [3.6],
    "unitWeight": [2600]
  },
  {
    "id": 5,
    "type": "barrier",
    "name": "T-LOK Precast Concrete Barrier",
    "supplier": "Saferoads Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.27,
    "ww": 1.88,
    "width": 0.61,
    "testLen": 58.5,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0019/570520/230601-TCU-T-LOK-MASH-F-TYPE-Concrete-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1TgaOsIO9LkAI4Xf7xC5RMVxdupqViQ8-/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [3.6, 5.49],
    "unitWeight": [2600, 3900]
  },
  {
    "id": 6,
    "type": "barrier",
    "name": "T-LOK Rubber Precast Concrete Barrier",
    "supplier": "Saferoads Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.76,
    "ww": 2.37,
    "width": 0.61,
    "testLen": 58.5,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0020/570521/230601-TCU-T-LOK-Rubber-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1DJq-1-IW0DuIIs3Lde-Z8-5LScod1sms/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [3.6, 5.49],
    "unitWeight": [2600, 3900]
  },
  {
    "id": 7,
    "type": "barrier",
    "name": "Pin and Loop Precast Concrete Barrier",
    "supplier": "WA Limestone",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.61,
    "ww": 2.22,
    "width": 0.61,
    "testLen": 61.4,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0024/463434/211201-TCU-PIN-and-LOOP-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1R1y0ZOsw5ENT7FVCerx7YCRHVRYppuCm/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 8,
    "type": "barrier",
    "name": "BG800 Steel Safety Barrier - Temporary",
    "supplier": "Ingal Civil Products",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.66,
    "ww": 2.2,
    "width": 0.54,
    "testLen": 72.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0027/463455/211201-TCU-BG800-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/15X4jRGK0T1uSk2_wanHw-3p2pCm36HIx/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 9,
    "type": "barrier",
    "name": "BG800 Steel Safety Barrier - Temporary (Minimum Deflection)",
    "supplier": "Ingal Civil Products",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 0.44,
    "ww": 0.98,
    "width": 0.54,
    "testLen": 42.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0031/463459/211201-TCU-BG800-MDS-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/15X4jRGK0T1uSk2_wanHw-3p2pCm36HIx/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 10,
    "type": "barrier",
    "name": "BG800 LDS Steel Safety Barrier - Temporary",
    "supplier": "Ingal Civil Products",
    "tl": "MASH TL-2",
    "testSpeed": 80.0,
    "defl": 0.42,
    "ww": 0.96,
    "width": 0.54,
    "testLen": 72.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0024/463452/211201-TCU-BG800-LDS-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/15X4jRGK0T1uSk2_wanHw-3p2pCm36HIx/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 11,
    "type": "barrier",
    "name": "HighwayGuard Steel Safety Barrier - Temporary",
    "supplier": "Ingal Civil Products",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.71,
    "ww": 2.25,
    "width": 0.54,
    "testLen": 108.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0024/516552/220908-TCU-HIGHWAYGUARD-Safety-Barrier-Temporary.pdf",
    "manufLink": "C:\\Users\\Sanju\\OneDrive - CromptonConcepts\\Desktop\\Temporary barriers\\TMR Approved Barriers\\Barriers\\10.HighwayGuard\\Standard",
    "isMatrix": true
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 12,
    "type": "barrier",
    "name": "HighwayGuard LDS Steel Safety Barrier - Temporary",
    "supplier": "Ingal Civil Products",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 0.68,
    "ww": 1.22,
    "width": 0.54,
    "testLen": 60.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0029/463448/211201-TCU-HIGHWAYGUARD-LDS-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1IH73E0qy5HBPJxKMVHMwDG86m828__di/view?usp=sharing",
    "isMatrix": true
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 13,
    "type": "barrier",
    "name": "HighwayGuard MDS Safety Barrier - Temporary",
    "supplier": "Ingal Civil Products",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 0.025,
    "ww": 0.67,
    "width": 0.54,
    "testLen": 36.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0027/570528/230601-TCU-HIGHWAYGUARD-MDS-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1DxqOzjGDg0E-u3Sou7OhkQMm5b-ZMRcr/view?usp=sharing",
    "isMatrix": true
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 14,
    "type": "barrier",
    "name": "Defender Barrier 70 Steel Safety Barrier - Temporary",
    "supplier": "Safe Barriers Pty Ltd",
    "tl": "MASH TL-2",
    "testSpeed": 70.0,
    "defl": 1.2,
    "ww": 1.88,
    "width": 0.68,
    "testLen": 105.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0028/463429/211201-TCU-DEFENDER-70-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/11rYLXesmG7J5DFRjhtgntREugcFWgraP/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 15,
    "type": "barrier",
    "name": "DEFENDER Barrier 100 LDS Safety Barrier - Temporary",
    "supplier": "Safe Barriers Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 0.88,
    "ww": 1.56,
    "width": 0.68,
    "testLen": 78.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0022/444307/210903-TCU-DEFENDER-100-LDS-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1qLEugecOdtVCNOdUCgJ4jHqsmq7sGMDL/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 16,
    "type": "barrier",
    "name": "DEFENDER Barrier 100 HC Steel Safety Barrier - Temporary",
    "supplier": "Safe Barriers Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.96,
    "ww": 2.44,
    "width": 0.68,
    "testLen": 97.5,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0021/444306/210903-TCU-DEFENDER-100-HC-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1aCrUADHqr19hkjxji-N4w--e9W2uR0DX/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 17,
    "type": "barrier",
    "name": "SafeZone Steel Safety Barrier - Temporary",
    "supplier": "Jaybro Group Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.7,
    "ww": 2.06,
    "width": 0.454,
    "testLen": 69.6,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0013/633100/240307-TCU-SafeZone-LDS-Safety-Barrier-Permanent-and-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1yoxc9f54tUAK6XUjY7kFGmVnFh_DeENV/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 18,
    "type": "barrier",
    "name": "SAFEZONE MDS Safety Barrier – Permanent & Temporary",
    "supplier": "Jaybro Group Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 0.17,
    "ww": 0.81,
    "width": 0.639,
    "testLen": 40.6,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0029/592643/230901-TCU-SAFEZONE-MDS-Safety-Barrier-Permanent-and-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1yoxc9f54tUAK6XUjY7kFGmVnFh_DeENV/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 19,
    "type": "barrier",
    "name": "SafeZone LDS Safety Barrier – Permanent & Temporary",
    "supplier": "Jaybro Group Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 0.42,
    "ww": 1.06,
    "width": 0.64,
    "testLen": 40.6,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0029/592643/230901-TCU-SAFEZONE-MDS-Safety-Barrier-Permanent-and-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1yoxc9f54tUAK6XUjY7kFGmVnFh_DeENV/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 20,
    "type": "barrier",
    "name": "IronMan Hybrid Steel Safety Barrier - Temporary",
    "supplier": "Saferoads Pty Ltd",
    "tl": "MASH TL-2",
    "testSpeed": 70.0,
    "defl": 1.49,
    "ww": 2.04,
    "width": 0.55,
    "testLen": 114.3,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0030/598620/230925-TCU-IRONMAN-HYBRID-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1UfcYtt6YNn4epy6depqvQRK3yVBm2XLb/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 21,
    "type": "barrier",
    "name": "ZONEGUARD Steel Safety Barrier - Temporary",
    "supplier": "Hill & Smith Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.9,
    "ww": 2.6,
    "width": 0.7,
    "testLen": 75.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0032/464981/211208-TCU-ZONEGUARD-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/11EFH9VYph2NLmm6ZfrO_Wt7NttYXs9XJ/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 22,
    "type": "barrier",
    "name": "ZONEGUARD MDS Steel Safety Barrier - Temporary",
    "supplier": "Hill & Smith Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 0.13,
    "ww": 0.83,
    "width": 0.7,
    "testLen": 95.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0032/406985/210304-TCU-ZONEGUARD-MDS-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/11EFH9VYph2NLmm6ZfrO_Wt7NttYXs9XJ/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 23,
    "type": "barrier",
    "name": "HV2 Steel and Concrete Longitudinal Barrier - Temporary",
    "supplier": "Saferoads Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.47,
    "ww": 1.84,
    "width": 0.45,
    "testLen": 98.6,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0021/463440/211201-TCU-HV2-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1Ts5JATyX2f5c3vzSMuRGIJ2oYpjW5HS0/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 24,
    "type": "barrier",
    "name": "ArmorZone MASH Water Filled Safety Barrier System - Temporary",
    "supplier": "Ingal Civil Products",
    "tl": "MASH TL-2",
    "testSpeed": 70.0,
    "defl": 4.1,
    "ww": 4.6,
    "width": 0.45,
    "testLen": 50.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0032/388283/201120-TCU-ARMORZONE-MASH-Water-Filled-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1Ts5JATyX2f5c3vzSMuRGIJ2oYpjW5HS0/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [2.0],
    "unitWeight": [496]
  },
  {
    "id": 25,
    "type": "barrier",
    "name": "RICOCHET Plastic Water Filled Safety Barrier System - Temporary",
    "supplier": "Advantage Plastics",
    "tl": "MASH TL-1",
    "testSpeed": 50.0,
    "defl": 2.28,
    "ww": 2.86,
    "width": 0.58,
    "testLen": 45.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0027/388323/201120-TCU-RICOCHET-Water-Filled-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1XMeu4A57SUpPbLaY-1P7bOvFBNQSjf_T/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 26,
    "type": "barrier",
    "name": "Lo-Ro Water Filled Cable Barrier System - Temporary",
    "supplier": "Jaybro Group Pty Ltd",
    "tl": "MASH TL-2",
    "testSpeed": 70.0,
    "defl": 3.6,
    "ww": 4.1,
    "width": 0.5,
    "testLen": 48.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0024/388320/201120-TCU-LO-RO-Water-Cable-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1ZHSg5IdzkklHhwYzUOmNZuzhSH10LDgZ/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 27,
    "type": "barrier",
    "name": "SHIELD I Water Filled Safety Barrier System - Temporary",
    "supplier": "National Plastic Group",
    "tl": "MASH TL-1",
    "testSpeed": 50.0,
    "defl": 2.2,
    "ww": 2.8,
    "width": 0.6,
    "testLen": 52.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0030/388326/201120-TCU-SHIELD-I-Water-Filled-Barrier-System-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1xW0lqDpWlswA80-4eE983vn0uXsR3n6K/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 28,
    "type": "barrier",
    "name": "MOBILE BARRIER MBT-1 Steel Safety Barrier - Temporary",
    "supplier": "Mobile Barriers",
    "tl": "MASH TL-3",
    "testSpeed": 80.0,
    "defl": 0.61,
    "ww": 1.22,
    "width": 0.61,
    "testLen": 30.5,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0025/388321/201120-TCU-MBT-1-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1seE4XAzVwSerP0X0INvohmuAGIy68teo/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 29,
    "type": "barrier",
    "name": "Rebloc 80SAH_12 Safety Barrier - Temporary",
    "supplier": "Onsite",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.31,
    "ww": 1.56,
    "width": 0.3,
    "testLen": 108.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0015/515130/220902-TCU-Rebloc-80SAH_12-Safety-Barrier.pdf",
    "manufLink": "https://drive.google.com/file/d/1BnkQoeUW_x0UhJTi2RFMr6IRiSOGc2gh/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 30,
    "type": "barrier",
    "name": "Rebloc 80SAH_12_8B Safety Barrier - Temporary",
    "supplier": "Onsite",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 0.3,
    "ww": 0.6,
    "width": 0.3,
    "testLen": 60.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0027/481626/220322-TCU-Rebloc-80SAH_12_8B-Safety-Barrier.pdf",
    "manufLink": "https://drive.google.com/file/d/1R9GLFNljmj_YqGtuOK3ZsajYkLTHDH8i/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 31,
    "type": "barrier",
    "name": "Rebloc 80SAH_4 Safety Barrier - Temporary",
    "supplier": "Onsite",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.21,
    "ww": 1.51,
    "width": 0.3,
    "testLen": 109.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0029/533576/221201-TCU-Rebloc-80SAH_4-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1SrR9hEsesKqx5UriGXw7bsDJgDOUefHz/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 32,
    "type": "barrier",
    "name": "DB80 T150S Precast Concrete Barrier (MASH TL-4)",
    "supplier": "Jaybro Group Pty Ltd",
    "tl": "MASH TL-4",
    "testSpeed": 100.0,
    "defl": 0.81,
    "ww": 2.5,
    "width": 0.57,
    "testLen": 92.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0034/467467/211220-TCU-DB80-T150-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1LLi9Qu3Hp4SGl71314N8pcmX-vN5PVon/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [2, 4, 6],
    "unitWeight": [1050, 2100, 3150]
  },
  {
    "id": 33,
    "type": "barrier",
    "name": "DB80A T150S Precast Concrete Barrier (Asphalt)",
    "supplier": "Jaybro Group Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 80.0,
    "defl": 0.55,
    "ww": 0.91,
    "width": 0.57,
    "testLen": 68.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0029/533846/221201-TCU-DB80A-T150-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1LoZmf0q3aMfYDrtxSn72_EtX7TyoAbwA/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [2, 4, 6],
    "unitWeight": [1100, 2200, 3300]
  },
  {
    "id": 34,
    "type": "barrier",
    "name": "JJ Hooks MASH Precast Concrete Barrier (Variation)",
    "supplier": "Australian Road Barriers",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.6,
    "ww": 2.2,
    "width": 0.6,
    "testLen": 66.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0026/480509/220314-TCU-JJ-HOOKS-MASH-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1LUzvzR77MHrTHdq5TS7h2AnqIyhaYJHo/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [6],
    "unitWeight": [4430]
  },
  {
    "id": 35,
    "type": "barrier",
    "name": "BG800 Steel Rail Safety Barrier (MASH TL-4)",
    "supplier": "Ingal Civil Products",
    "tl": "MASH TL-4",
    "testSpeed": 100.0,
    "defl": 2.31,
    "ww": 3.66,
    "width": 0.54,
    "testLen": 72.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0027/463455/211201-TCU-BG800-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/15X4jRGK0T1uSk2_wanHw-3p2pCm36HIx/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 36,
    "type": "barrier",
    "name": "HighwayGuard Safety Barrier (MASH TL-3)",
    "supplier": "Ingal Civil Products",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.93,
    "ww": 2.47,
    "width": 0.54,
    "testLen": 120.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0024/516552/220908-TCU-HIGHWAYGUARD-Safety-Barrier-Temporary.pdf",
    "manufLink": "C:\\Users\\Sanju\\OneDrive - CromptonConcepts\\Desktop\\Temporary barriers\\TMR Approved Barriers\\Barriers\\10.HighwayGuard\\Standard",
    "isMatrix": true
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 37,
    "type": "barrier",
    "name": "HighwayGuard Safety Barrier (MASH TL-4)",
    "supplier": "Ingal Civil Products",
    "tl": "MASH TL-4",
    "testSpeed": 100.0,
    "defl": 2.16,
    "ww": 3.51,
    "width": 0.54,
    "testLen": 120.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0024/516552/220908-TCU-HIGHWAYGUARD-Safety-Barrier-Temporary.pdf",
    "manufLink": "C:\\Users\\Sanju\\OneDrive - CromptonConcepts\\Desktop\\Temporary barriers\\TMR Approved Barriers\\Barriers\\10.HighwayGuard\\Standard",
    "isMatrix": true
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 38,
    "type": "barrier",
    "name": "HighwayGuard LDS Safety Barrier ( MASH TL-3)",
    "supplier": "Ingal Civil Products",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.16,
    "ww": 1.7,
    "width": 0.54,
    "testLen": 84.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0029/463448/211201-TCU-HIGHWAYGUARD-LDS-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1IH73E0qy5HBPJxKMVHMwDG86m828__di/view?usp=sharing",
    "isMatrix": true
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 39,
    "type": "barrier",
    "name": "HighwayGuard LDS Safety Barrier (MASH TL-4)",
    "supplier": "Ingal Civil Products",
    "tl": "MASH TL-4",
    "testSpeed": 100.0,
    "defl": 1.16,
    "ww": 2.88,
    "width": 0.54,
    "testLen": 84.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0029/463448/211201-TCU-HIGHWAYGUARD-LDS-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1IH73E0qy5HBPJxKMVHMwDG86m828__di/view?usp=sharing",
    "isMatrix": true
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 40,
    "type": "barrier",
    "name": "DEFENDER Barrier 100 HC Steel Safety Barrier (48m)",
    "supplier": "Safe Barriers Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 2.3,
    "ww": 2.98,
    "width": 0.68,
    "testLen": 97.5,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0021/444306/210903-TCU-DEFENDER-100-HC-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1aCrUADHqr19hkjxji-N4w--e9W2uR0DX/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 41,
    "type": "barrier",
    "name": "DEFENDER Barrier 100 HC Steel Safety Barrier (MASH TL-4)",
    "supplier": "Safe Barriers Pty Ltd",
    "tl": "MASH TL-4",
    "testSpeed": 100.0,
    "defl": 2.47,
    "ww": 3.31,
    "width": 0.68,
    "testLen": 97.5,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0021/444306/210903-TCU-DEFENDER-100-HC-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1aCrUADHqr19hkjxji-N4w--e9W2uR0DX/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 42,
    "type": "barrier",
    "name": "DEFENDER 100 FS Safety Barrier - Temporary",
    "supplier": "Safe Barriers Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 1.9,
    "ww": 2.58,
    "width": 0.68,
    "testLen": 156.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0022/463432/211201-TCU-DEFENDER-100-FS-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1aCrUADHqr19hkjxji-N4w--e9W2uR0DX/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 43,
    "type": "barrier",
    "name": "SafeZone Steel Safety Barrier - Temporary (MASH TL-4)",
    "supplier": "Jaybro Group Pty Ltd",
    "tl": "MASH TL-4",
    "testSpeed": 100.0,
    "defl": 2.07,
    "ww": 2.96,
    "width": 0.454,
    "testLen": 69.6,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0013/633100/240307-TCU-SafeZone-LDS-Safety-Barrier-Permanent-and-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1yoxc9f54tUAK6XUjY7kFGmVnFh_DeENV/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 44,
    "type": "barrier",
    "name": "SafeZone LDS Safety Barrier – Permanent & Temporary (MASH TL-4)",
    "supplier": "Jaybro Group Pty Ltd",
    "tl": "MASH TL-4",
    "testSpeed": 100.0,
    "defl": 0.45,
    "ww": 2.17,
    "width": 0.64,
    "testLen": 40.6,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0013/633100/240307-TCU-SafeZone-LDS-Safety-Barrier-Permanent-and-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1yoxc9f54tUAK6XUjY7kFGmVnFh_DeENV/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 45,
    "type": "barrier",
    "name": "ZONEGUARD MDS Steel Safety Barrier (Asphalt)",
    "supplier": "Hill & Smith Pty Ltd",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 0.1,
    "ww": 0.8,
    "width": 0.7,
    "testLen": 95.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0032/406985/210304-TCU-ZONEGUARD-MDS-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/11EFH9VYph2NLmm6ZfrO_Wt7NttYXs9XJ/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 46,
    "type": "barrier",
    "name": "HV2 Steel and Concrete Longitudinal Barrier - Temporary (MASH TL-4)",
    "supplier": "Saferoads Pty Ltd",
    "tl": "MASH TL-4",
    "testSpeed": 100.0,
    "defl": 2.37,
    "ww": 3.74,
    "width": 0.45,
    "testLen": 278.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0021/463440/211201-TCU-HV2-Safety-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1Ts5JATyX2f5c3vzSMuRGIJ2oYpjW5HS0/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 47,
    "type": "barrier",
    "name": "ArmorZone MASH Water Filled Safety Barrier System - Temporary (TL-1)",
    "supplier": "Ingal Civil Products",
    "tl": "MASH TL-1",
    "testSpeed": 50.0,
    "defl": 2.16,
    "ww": 2.61,
    "width": 0.45,
    "testLen": 50.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0032/388283/201120-TCU-ARMORZONE-MASH-Water-Filled-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1Ts5JATyX2f5c3vzSMuRGIJ2oYpjW5HS0/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [2],
    "unitWeight": [496]
  },
  {
    "id": 48,
    "type": "barrier",
    "name": "Lo-Ro Water Filled Cable Barrier System - Temporary (TL-1)",
    "supplier": "Jaybro Group Pty Ltd",
    "tl": "MASH TL-1",
    "testSpeed": 50.0,
    "defl": 1.8,
    "ww": 2.3,
    "width": 0.5,
    "testLen": 48.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0024/388320/201120-TCU-LO-RO-Water-Cable-Barrier-Temporary.pdf",
    "manufLink": "https://drive.google.com/file/d/1ZHSg5IdzkklHhwYzUOmNZuzhSH10LDgZ/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [2],
    "unitWeight": [496]
  },
  {
    "id": 49,
    "type": "barrier",
    "name": "Rebloc 80SAH_12 Safety Barrier - Temporary (MASH TL-4)",
    "supplier": "Onsite",
    "tl": "MASH TL-4",
    "testSpeed": 100.0,
    "defl": 1.7,
    "ww": 3.23,
    "width": 0.3,
    "testLen": 156.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0015/515130/220902-TCU-Rebloc-80SAH_12-Safety-Barrier.pdf",
    "manufLink": "https://drive.google.com/file/d/1BnkQoeUW_x0UhJTi2RFMr6IRiSOGc2gh/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [2],
    "unitWeight": [580]
  },
  {
    "id": 50,
    "type": "barrier",
    "name": "Rebloc 120FA_6_SF Safety Barrier - Temporary",
    "supplier": "Rebloc",
    "tl": "MASH TL-3",
    "testSpeed": 100.0,
    "defl": 0.4,
    "ww": 1.0,
    "width": 0.62,
    "testLen": 102.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0043/498778/220616-TCU-Rebloc-120FA_6_FS-Safety-Barrier.pdf",
    "manufLink": "https://drive.google.com/file/d/1A_h5uprcVqwsF95nHRsFxNmmboe7L6Gn/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  },
  {
    "id": 51,
    "type": "barrier",
    "name": "Rebloc 120FA_6_SF Safety Barrier - Temporary (MASH TL-5)",
    "supplier": "Rebloc",
    "tl": "MASH TL-5",
    "testSpeed": 100.0,
    "defl": 1.58,
    "ww": 2.29,
    "width": 0.62,
    "testLen": 102.0,
    "link": "https://austroads.gov.au/__data/assets/pdf_file/0043/498778/220616-TCU-Rebloc-120FA_6_FS-Safety-Barrier.pdf",
    "manufLink": "https://drive.google.com/file/d/1A_h5uprcVqwsF95nHRsFxNmmboe7L6Gn/view?usp=sharing",
    "isMatrix": false
  ,
    "availableLengths": [0],
    "unitWeight": [0]
  }
];
// --- MANUFACTURER SPECIFICATIONS & IMAGE INJECTION ---
const specMap = {
  "DB80 K150 Precast Concrete Barrier": "https://drive.google.com/file/d/1LLi9Qu3Hp4SGl71314N8pcmX-vN5PVon/view?usp=sharing",
  "DB80 T150S Precast Concrete Barrier": "https://drive.google.com/file/d/1LLi9Qu3Hp4SGl71314N8pcmX-vN5PVon/view?usp=sharing",
  "DB80A T150S Precast Concrete Barrier": "https://drive.google.com/file/d/1LoZmf0q3aMfYDrtxSn72_EtX7TyoAbwA/view?usp=sharing",
  "JJ Hooks MASH Precast Concrete Barrier": "https://drive.google.com/file/d/1LUzvzR77MHrTHdq5TS7h2AnqIyhaYJHo/view?usp=sharing",
  "T-LOK Precast Concrete Barrier": "https://drive.google.com/file/d/1TgaOsIO9LkAI4Xf7xC5RMVxdupqViQ8-/view?usp=sharing",
  "T-LOK Rubber Precast Concrete Barrier": "https://drive.google.com/file/d/1DJq-1-IW0DuIIs3Lde-Z8-5LScod1sms/view?usp=sharing",
  "Pin and Loop Precast Concrete Barrier": "https://drive.google.com/file/d/1R1y0ZOsw5ENT7FVCerx7YCRHVRYppuCm/view?usp=sharing",
  "BG800 Steel Rail Safety Barrier": "https://drive.google.com/file/d/15X4jRGK0T1uSk2_wanHw-3p2pCm36HIx/view?usp=sharing",
  "HighwayGuard Safety Barrier - Temporary": "C:\\Users\\Sanju\\OneDrive - CromptonConcepts\\Desktop\\Temporary barriers\\TMR Approved Barriers\\Barriers\\10.HighwayGuard\\Standard",
  "HighwayGuard LDS Safety Barrier – Temporary": "https://drive.google.com/file/d/1IH73E0qy5HBPJxKMVHMwDG86m828__di/view?usp=sharing",
  "HighwayGuard MDS Safety Barrier – Temporary": "https://drive.google.com/file/d/1DxqOzjGDg0E-u3Sou7OhkQMm5b-ZMRcr/view?usp=sharing",
  "DEFENDER Barrier 70 Steel Safety Barrier - Temporary": "https://drive.google.com/file/d/11rYLXesmG7J5DFRjhtgntREugcFWgraP/view?usp=sharing",
  "DEFENDER Barrier 100 LDS Safety Barrier - Temporary": "https://drive.google.com/file/d/1qLEugecOdtVCNOdUCgJ4jHqsmq7sGMDL/view?usp=sharing",
  "DEFENDER Barrier 100 HC Steel Safety Barrier - Temporary": "https://drive.google.com/file/d/1aCrUADHqr19hkjxji-N4w--e9W2uR0DX/view?usp=sharing",
  "DEFENDER 100 FS Safety Barrier - Temporary": "https://drive.google.com/file/d/1aCrUADHqr19hkjxji-N4w--e9W2uR0DX/view?usp=sharing",
  "SAFEZONE Safety Barrier - Temporary": "https://drive.google.com/file/d/1yoxc9f54tUAK6XUjY7kFGmVnFh_DeENV/view?usp=sharing",
  "SafeZone LDS Safety Barrier – Permanent & Temporary": "https://drive.google.com/file/d/1yoxc9f54tUAK6XUjY7kFGmVnFh_DeENV/view?usp=sharing",
  "IRONMAN HYBRID Steel Safety Barrier - Temporary": "https://drive.google.com/file/d/1UfcYtt6YNn4epy6depqvQRK3yVBm2XLb/view?usp=sharing",
  "ZONEGUARD Steel Safety Barrier - Temporary": "https://drive.google.com/file/d/11EFH9VYph2NLmm6ZfrO_Wt7NttYXs9XJ/view?usp=sharing",
  "HV2 Steel and Concrete Longitudinal Barrier - Temporary": "https://drive.google.com/file/d/1ibyoMMWi2NxCsLgRkkQcnYcCUugYy3-e/view?usp=sharing",
  "ArmorZone MASH Water Filled Safety Barrier System - Temporary": "https://drive.google.com/file/d/1Ts5JATyX2f5c3vzSMuRGIJ2oYpjW5HS0/view?usp=sharing",
  "RICOCHET Plastic Water Filled Safety Barrier System - Temporary": "https://drive.google.com/file/d/1XMeu4A57SUpPbLaY-1P7bOvFBNQSjf_T/view?usp=sharing",
  "Lo-Ro Water Filled Cable Barrier System - Temporary": "https://drive.google.com/file/d/1ZHSg5IdzkklHhwYzUOmNZuzhSH10LDgZ/view?usp=sharing",
  "SHIELD I Water Filled Safety Barrier System - Temporary": "https://drive.google.com/file/d/IQAUlEQKQuqoRLf5dV8UKo3mASE0hqnt51jV83jCgKmOW48/view?usp=sharing",
  "MOBILE BARRIER MBT-1 Steel Safety Barrier - Temporary": "https://drive.google.com/file/d/1seE4XAzVwSerP0X0INvohmuAGIy68teo/view?usp=sharing",
  "Rebloc 80SAH_12 Safety Barrier - Temporary": "https://drive.google.com/file/d/1BnkQoeUW_x0UhJTi2RFMr6IRiSOGc2gh/view?usp=sharing",
  "Rebloc 80SAH_12_8B Safety Barrier - Temporary": "https://drive.google.com/file/d/1R9GLFNljmj_YqGtuOK3ZsajYkLTHDH8i/view?usp=sharing",
  "Rebloc 80SAH_4 Safety Barrier - Temporary": "https://drive.google.com/file/d/1SrR9hEsesKqx5UriGXw7bsDJgDOUefHz/view?usp=sharing",
  "Rebloc 120FA_6_SF Safety Barrier - Temporary": "https://drive.google.com/file/d/1A_h5uprcVqwsF95nHRsFxNmmboe7L6Gn/view?usp=sharing"
};

const imageMap = {
  "DB80 K150 Precast Concrete Barrier": "https://www.rsea.com.au/Images/ProductImages/Medium/DB80_1.jpg",
  "DB80 T150S Precast Concrete Barrier": "https://deltabloc.com/assets/images/9/slider-db80-product-01-d5f86934.webp",
  "DB80A T150S Precast Concrete Barrier": "https://deltabloc.com/assets/images/9/slider-db80-product-01-d5f86934.webp",
  "JJ Hooks MASH Precast Concrete Barrier": "https://s.yimg.com/ny/api/res/1.2/UlYB4Dh.4B0CAJsf4YWd5w--/YXBwaWQ9aGlnaGxhbmRlcjt3PTY0MDtoPTM0MA--/https://media.zenfs.com/en/accesswire.ca/23c1b596b6abd4fe4b9e65c0db6631f9",
  "T-LOK Precast Concrete Barrier": "https://www.rockinghamprecast.com/assets/barrier/Barrier-1-1024x682-e95d03ae3260558bf15e2099b35e70a1e313f215f9b847ccb799794663fe98ff.jpg",
  "T-LOK Rubber Precast Concrete Barrier": "https://www.saferoads.com.au/media/rubbertlok1472.jpg",
  "Pin and Loop Precast Concrete Barrier": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTd_vcY9htRDEx3kmmIPL8e_dFsQ77E7J1cmA&s",
  "BG800 Steel Safety Barrier - Temporary": "https://webassetsprod.valmont.com/valmontproduction/images/ingalcivilau2024libraries/products/guardrail/ezyguard-smart/ezyguard-smart.png?sfvrsn=63618039_1",
  "BG800 LDS Steel Safety Barrier - Temporary": "https://webassetsprod.valmont.com/valmontproduction/images/ingalcivilau2024libraries/products/guardrail/ezyguard-smart/ezyguard-smart.png?sfvrsn=63618039_1",
  "HighwayGuard Steel Safety Barrier - Temporary": "https://www.rpmhire.com.au/wp-content/uploads/2022/09/38-1-1024x1024.jpg",
  "HighwayGuard LDS Steel Safety Barrier - Temporary": "https://www.rpmhire.com.au/wp-content/uploads/2022/09/38-1-1024x1024.jpg",
  "HighwayGuard MDS Safety Barrier - Temporary": "https://www.rpmhire.com.au/wp-content/uploads/2022/09/38-1-1024x1024.jpg",
  "Defender Barrier 70 Steel Safety Barrier - Temporary": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTMm5AdBQwuyp-njndvqUyd9L2girh5J469fw&s",
  "DEFENDER Barrier 100 LDS Safety Barrier - Temporary": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTMm5AdBQwuyp-njndvqUyd9L2girh5J469fw&s",
  "DEFENDER Barrier 100 HC Steel Safety Barrier - Temporary": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTMm5AdBQwuyp-njndvqUyd9L2girh5J469fw&s",
  "DEFENDER 100 FS Safety Barrier - Temporary": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTMm5AdBQwuyp-njndvqUyd9L2girh5J469fw&s",
  "SafeZone Steel Safety Barrier - Temporary": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSrke7EEFUMwI0AfwPZuWn2eWlrr_H3L95STw&s",
  "SAFEZONE MDS Safety Barrier – Permanent & Temporary": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSrke7EEFUMwI0AfwPZuWn2eWlrr_H3L95STw&s",
  "SafeZone LDS Safety Barrier – Permanent & Temporary": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSrke7EEFUMwI0AfwPZuWn2eWlrr_H3L95STw&s",
  "IronMan Hybrid Steel Safety Barrier - Temporary": "https://www.saferoads.com.au/media/IHB-2.jpg",
  "ZONEGUARD Steel Safety Barrier - Temporary": "https://hillandsmith.com/wp-content/uploads/2022/02/floating-image.png",
  "ZONEGUARD MDS Steel Safety Barrier - Temporary": "https://hillandsmith.com/wp-content/uploads/2022/02/floating-image.png",
  "HV2 Steel and Concrete Longitudinal Barrier - Temporary": "https://drive.google.com/thumbnail?id=1ervOqUucoqwmWgT0rrPDifn9yx7pXq4b&sz=w1000",
  "ArmorZone MASH Water Filled Safety Barrier System - Temporary": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSqvX9uI5h7NpJSrwBs6d28iMU3GQysQGj1kQ&s",
  "Armorzone MASH End Treatment Unit": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSc1uWNB28LN3JoxEC_Ko6SRN8GE10jfBi82Q&s",
  "RICOCHET Plastic Water Filled Safety Barrier System - Temporary": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSlYEbeYaI4LAckOZhO2SSIHaEw3Mx2QQ8-Sg&s",
  "Lo-Ro Water Filled Cable Barrier System - Temporary": "https://www.jaybro.com.au/pub/media/catalog/product/1/5/15-loror-lo-ro-water-cable-barrier-red.jpg?width=265&height=265&store=au_default&image-type=image",
  "SHIELD I Water Filled Safety Barrier System - Temporary": "https://sitehq-production.s3.amazonaws.com/wp-prod/uploads/5.-Shield-I-Product-Manual1.jpg",
  "MOBILE BARRIER MBT-1 Steel Safety Barrier - Temporary": "https://www.mobilebarriers.com/media/index_media/Capital%20Beltway%20I-495%20Express%20Lanes%20Maintenance%20_27_n%20Mobile%20Barriers%20MBT-1.jpg",
  "Rebloc 80SAH_12 Safety Barrier - Temporary": "https://www.roadsidepooledfund.org/wp-content/uploads/2021/10/Screenshot-153.png",
  "Rebloc 80SAH_12_8B Safety Barrier - Temporary": "https://www.roadsidepooledfund.org/wp-content/uploads/2021/10/Screenshot-155.png",
  "Rebloc 80SAH_4 Safety Barrier - Temporary": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRWHQk1XrRCxX6lrEyVsGFPmr32B-Ttmr-XAA&s",
  "Rebloc 120FA_6_SF Safety Barrier - Temporary": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQnyqAAIEOlYEDSkUpm3aRalO_m6tWQqLkasQ&s",
  "Absorb-M Plastic Crash Cushion": "https://www.safedirection.com.au/wp-content/uploads/2024/02/Screenshot-2024-02-06-at-4.40.43%E2%80%AFpm.png",
  "ArmorBuffa Plastic Water Filled Crash Cushion": "https://transpo.com/wp-content/uploads/ArmorBuffa-main-image-scaled-1.jpg",
  "SLED Plastic Water Filled End Terminal": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQgPvfai-BV5OIWxNzVJMQarK51cUwuAUz5ow&s",
  "Universal TAU-M Crash Cushion": "https://barrierdesigns.com.au/wp-content/uploads/2024/10/TAU-M.jpg",
  "TAU-XR Crash Cushion": "https://www.jaybro.com.au/pub/media/mageplaza/blog/post/b/l/blog_tau_xr.jpg",
  "ET-SS Guardrail End Terminal": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRAxI7yU5UpOWzWm7Z73jQ7eD8XE5wgwDgung&s",
  "MASH Sequential Kinking Terminal (MSKT)": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTx68Khf-lTUUroy0cOcNI7adgcxJJoNjekSg&s",
  "MAX-Tension Guardrail Terminal": "https://www.safedirection.com.au/wp-content/uploads/2024/02/Screenshot-2024-02-06-at-4.13.23%E2%80%AFpm.png",
  "Trend Median Terminal": "https://barrierdesigns.com.au/wp-content/uploads/2024/09/trend-end-terminal-image-web.jpg",
  "QuadGuard M10 Crash Cushion": "https://www.rpmhire.com.au/wp-content/uploads/2021/12/imahe-2.png",
  "QUADGUARD M10 CZ Crash Cushion": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR_8IjeNYHG6BW1yTI4mzG9Xn6Ggbw7zCCb4A&s",
  "QuadGuard Elite M10 Crash Cushion": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTNWdITu00u14pCQWYy638VGL7_HZQqnW66fQ&s",
  "Smart Cushion SCI100GM": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQkwB34e30f2EYoexXHsKG7LEby1TG8QGGvfw&s",
  "Hercules Crash Cushion": "https://steelgal.co.nz/wp-content/uploads/2023/07/Hercules.jpg"
};

const imageAliases = {
  "DB80 T150S Precast Concrete Barrier (MASH TL-4)": "DB80 T150S Precast Concrete Barrier",
  "DB80A T150S Precast Concrete Barrier (Asphalt)": "DB80A T150S Precast Concrete Barrier",
  "JJ Hooks MASH Precast Concrete Barrier (Variation)": "JJ Hooks MASH Precast Concrete Barrier",
  "BG800 Steel Safety Barrier - Temporary (Minimum Deflection)": "BG800 Steel Safety Barrier - Temporary",
  "BG800 Steel Rail Safety Barrier (MASH TL-4)": "BG800 Steel Safety Barrier - Temporary",
  "HighwayGuard Safety Barrier (58m Spacing)": "HighwayGuard Steel Safety Barrier - Temporary",
  "HighwayGuard Safety Barrier (MASH TL-4)": "HighwayGuard Steel Safety Barrier - Temporary",
  "HighwayGuard LDS Safety Barrier (24m Spacing)": "HighwayGuard LDS Steel Safety Barrier - Temporary",
  "HighwayGuard LDS Safety Barrier (MASH TL-4)": "HighwayGuard LDS Steel Safety Barrier - Temporary",
  "SafeZone Steel Safety Barrier - Temporary (MASH TL-4)": "SafeZone Steel Safety Barrier - Temporary",
  "SafeZone LDS Safety Barrier – Permanent & Temporary (MASH TL-4)": "SafeZone LDS Safety Barrier – Permanent & Temporary",
  "ZONEGUARD MDS Steel Safety Barrier (Asphalt)": "ZONEGUARD MDS Steel Safety Barrier - Temporary",
  "ArmorZone MASH Water Filled Safety Barrier System - Temporary (TL-1)": "ArmorZone MASH Water Filled Safety Barrier System - Temporary",
  "Lo-Ro Water Filled Cable Barrier System - Temporary (TL-1)": "Lo-Ro Water Filled Cable Barrier System - Temporary",
  "Rebloc 80SAH_12 Safety Barrier - Temporary (MASH TL-4)": "Rebloc 80SAH_12 Safety Barrier - Temporary",
  "Rebloc 120FA_6_SF Safety Barrier - Temporary (MASH TL-5)": "Rebloc 120FA_6_SF Safety Barrier - Temporary",
  "DEFENDER Barrier 100 HC Steel Safety Barrier (48m)": "DEFENDER Barrier 100 HC Steel Safety Barrier - Temporary",
  "DEFENDER Barrier 100 HC Steel Safety Barrier (MASH TL-4)": "DEFENDER Barrier 100 HC Steel Safety Barrier - Temporary",
  "HV2 Steel and Concrete Longitudinal Barrier - Temporary (MASH TL-4)": "HV2 Steel and Concrete Longitudinal Barrier - Temporary",
  "SafeZone Safety Barrier - Temporary": "SafeZone Steel Safety Barrier - Temporary",
  "BG800 Steel Rail Safety Barrier": "BG800 Steel Safety Barrier - Temporary",
  "Armorzone MASH End Treatment Unit": "ArmorZone MASH Water Filled Safety Barrier System - Temporary",
  "Ricochet MASH TL1 Terminal End": "RICOCHET Plastic Water Filled Safety Barrier System - Temporary"
};

// Manufacturer home pages (per supplier) to surface a "Manufacturer Website" link
const manufacturerSiteMap = {
  "Jaybro Group Pty Ltd": "https://www.jaybro.com.au/",
  "Australian Road Barriers": "https://www.australianroadbarriers.com.au/",
  "Saferoads Pty Ltd": "https://www.saferoads.com.au/",
  "WA Limestone": "https://www.walimestone.com/",
  "Ingal Civil Products": "https://www.ingalcivil.com.au/",
  "Safe Barriers Pty Ltd": "https://www.safebarriers.com.au/",
  "Hill & Smith Pty Ltd": "https://hillandsmith.com/",
  "Advantage Plastics": "https://www.advantageplastics.com.au/",
  "National Plastic Group": "https://www.npg.com.sa/",
  "Mobile Barriers": "https://www.mobilebarriers.com/",
  "Onsite": "https://www.onsite.com.au/",
  "Safe Direction": "https://www.safedirection.com.au/",
  "LB Australia": "https://lbaustralia.com.au/"
};

// Product/brand specific websites when available (overrides supplier homepage)
const manufacturerSiteByName = {
  "Rebloc 80SAH_12 Safety Barrier - Temporary": "https://www.rebloc.com/",
  "Rebloc 80SAH_12_8B Safety Barrier - Temporary": "https://www.rebloc.com/",
  "Rebloc 80SAH_4 Safety Barrier - Temporary": "https://www.rebloc.com/",
  "Rebloc 120FA_6_SF Safety Barrier - Temporary": "https://www.rebloc.com/",
  "HighwayGuard Steel Safety Barrier - Temporary": "https://highwayguard.com/",
  "HighwayGuard LDS Steel Safety Barrier – Temporary": "https://highwayguard.com/",
  "HighwayGuard MDS Safety Barrier – Temporary": "https://highwayguard.com/",
  "HighwayGuard Safety Barrier (58m Spacing)": "https://highwayguard.com/",
  "HighwayGuard Safety Barrier (MASH TL-4)": "https://highwayguard.com/",
  "HighwayGuard LDS Safety Barrier (24m Spacing)": "https://highwayguard.com/",
  "HighwayGuard LDS Safety Barrier (MASH TL-4)": "https://highwayguard.com/",
  "ZONEGUARD Steel Safety Barrier - Temporary": "https://hillandsmith.com/products/zoneguard/",
  "ZONEGUARD MDS Steel Safety Barrier - Temporary": "https://hillandsmith.com/products/zoneguard/",
  "ZONEGUARD MDS Steel Safety Barrier (Asphalt)": "https://hillandsmith.com/products/zoneguard/",
  "BG800 Steel Safety Barrier - Temporary": "https://www.ingalcivil.com.au/products/aus/bg800",
  "BG800 LDS Steel Safety Barrier - Temporary": "https://www.ingalcivil.com.au/products/aus/bg800",
  "BG800 Steel Safety Barrier - Temporary (Minimum Deflection)": "https://www.ingalcivil.com.au/products/aus/bg800",
  "BG800 Steel Rail Safety Barrier (MASH TL-4)": "https://www.ingalcivil.com.au/products/aus/bg800",
  "ArmorZone MASH Water Filled Safety Barrier System - Temporary": "https://www.ingalcivil.com.au/products/aus/armorzone",
  "Lo-Ro Water Filled Cable Barrier System - Temporary": "https://www.jaybro.com.au/lo-ro-water-filled-cable-barrier-mash-tl-2.html",
  "RICOCHET Plastic Water Filled Safety Barrier System - Temporary": "https://www.advantageplastics.com.au/",
  "SHIELD I Water Filled Safety Barrier System - Temporary": "https://www.npg.com.sa/",
  "MOBILE BARRIER MBT-1 Steel Safety Barrier - Temporary": "https://www.mobilebarriers.com/",
  "Absorb-M Plastic Crash Cushion": "https://www.safedirection.com.au/products/guardrail-products/road-barriers/crash-cushions/absorb-m-plastic-crash-cushion/",
  "ArmorBuffa Plastic Water Filled Crash Cushion": "https://transpo.com/armorbuffa-crash-cushion/",
  "SLED Plastic Water Filled End Terminal": "https://www.saferoads.com.au/products/sled/",
  "Universal TAU-M Crash Cushion": "https://www.safedirection.com.au/products/guardrail-products/road-barriers/crash-cushions/universal-tau-m-crash-cushion/",
  "TAU-XR Crash Cushion": "https://www.safedirection.com.au/products/guardrail-products/road-barriers/crash-cushions/tau-xr-crash-cushion/",
  "ET-SS Guardrail End Terminal": "https://www.ingalcivil.com.au/products/aus/et-ss-terminal",
  "MASH Sequential Kinking Terminal (MSKT)": "https://www.safedirection.com.au/products/guardrail-products/road-barriers/end-terminals/mash-sequential-kinking-terminal-mskt/",
  "MAX-Tension Guardrail Terminal": "https://www.safedirection.com.au/products/guardrail-products/road-barriers/end-terminals/max-tension-terminal/",
  "Trend Median Terminal": "https://www.ingalcivil.com.au/products/aus/trend-median-terminal",
  "QuadGuard M10 Crash Cushion": "https://www.ingalcivil.com.au/products/aus/quadguard-m10",
  "QUADGUARD M10 CZ Crash Cushion": "https://www.ingalcivil.com.au/products/aus/quadguard-m10",
  "QuadGuard Elite M10 Crash Cushion": "https://www.ingalcivil.com.au/products/aus/quadguard-elite-m10",
  "Smart Cushion SCI100GM": "https://lbaustralia.com.au/products/smart-cushion-speed-dependent-crash-attenuator/",
  "Hercules Crash Cushion": "https://www.safedirection.com.au/products/guardrail-products/road-barriers/crash-cushions/hercules/"
};

const RECENT_STORAGE_KEY = 'deflection-recents-v1';
let recentSelections = [];

function resolveImage(name) {
  const direct = imageMap[name];
  if (direct) {
    return direct;
  }

  const alias = imageAliases[name];
  if (alias && imageMap[alias]) {
    return imageMap[alias];
  }

  return null;
}

function resolveManufacturerSite(item) {
  if (!item) return null;

  if (manufacturerSiteByName[item.name]) {
    return manufacturerSiteByName[item.name];
  }

  if (manufacturerSiteMap[item.supplier]) {
    return manufacturerSiteMap[item.supplier];
  }

  return null;
}

function loadRecents() {
  try {
    const raw = localStorage.getItem(RECENT_STORAGE_KEY);
    recentSelections = raw ? JSON.parse(raw) : [];
  } catch (e) {
    recentSelections = [];
  }
}

function persistRecents() {
  localStorage.setItem(RECENT_STORAGE_KEY, JSON.stringify(recentSelections));
}

function touchRecent(id, type) {
  const key = `${type}:${id}`;
  recentSelections = recentSelections.filter(r => `${r.type}:${r.id}` !== key);
  recentSelections.unshift({ id, type });
  if (recentSelections.length > 5) recentSelections = recentSelections.slice(0, 5);
  persistRecents();
  renderQuickPicks();
}

function renderQuickPicks() {
  const favWrap = document.getElementById('quickFavorites');
  const recentWrap = document.getElementById('quickRecents');
  if (!favWrap || !recentWrap) return;

  // Favorites only for barriers (existing data model)
  if (currentStage1Tab === 'barrier') {
    const favItems = barriers.filter(b => favoriteBarriers.includes(b.id)).slice(0, 5);
    if (favItems.length) {
      favWrap.innerHTML = '<span class="quick-heading">Favorites:</span>' + favItems.map(b => `<button class="chip chip-fav" onclick="selectBarrier(${b.id}, 'barrier'); event.stopPropagation();">★ ${b.name}</button>`).join('');
      favWrap.style.display = 'flex';
    } else {
      favWrap.innerHTML = '<span class="quick-heading">Favorites:</span><span style="color:#94a3b8;">No favorites yet</span>';
      favWrap.style.display = 'flex';
    }
  } else {
    favWrap.style.display = 'none';
  }

  const source = currentStage1Tab === 'terminal' ? END_TREATMENTS : barriers;
  const recentItems = recentSelections
    .filter(r => r.type === currentStage1Tab)
    .map(r => source.find(i => i.id === r.id))
    .filter(Boolean)
    .slice(0, 5);

  if (recentItems.length) {
    recentWrap.innerHTML = '<span class="quick-heading">Recent:</span>' + recentItems.map(item => `<button class="chip chip-recent" onclick="selectBarrier(${item.id}, '${currentStage1Tab}'); event.stopPropagation();">${item.name}</button>`).join('');
    recentWrap.style.display = 'flex';
  } else {
    recentWrap.innerHTML = '<span class="quick-heading">Recent:</span><span style="color:#94a3b8;">No recent selections</span>';
    recentWrap.style.display = 'flex';
  }

  renderDataHealth();
}

barriers.forEach(b => {
  // Normalise name (trim spaces)
  const name = b.name.trim();
  
  if (specMap[name]) {
    b.specLink = specMap[name];
  }
  
  // Exact match for image
  console.log(`Checking image for: "${name}"`);
  const resolvedImage = resolveImage(name);
  if (resolvedImage) {
      b.image = resolvedImage;
      console.log(`✓ Image assigned for: ${name}`, b.image);
  } else {
      console.log(`✗ No image found for: "${name}"`);
  }
});

// Apply images to end treatments as well
END_TREATMENTS.forEach(et => {
  const name = et.name.trim();
  const resolvedImage = resolveImage(name);
  if (resolvedImage) {
    et.image = resolvedImage;
  }
});

const SCENARIO_STORAGE_KEY = 'deflection-scenarios-v1';
let selectedBarrier = null;
let currentTab = 'deflection';
let currentStage1Tab = 'barrier'; // 'barrier' or 'terminal'
let calcDirty = false;
let lastCalcInputs = null;
let lastScenarioSnapshot = null;
let savedScenarios = [];
let pendingScenarioLoad = null;
let compareSelections = [];
let favoriteBarriers = [];
const FAV_STORAGE_KEY = 'deflection-favs-v1';

const MATRIX_SPEEDS = [20, 40, 50, 60, 70, 80, 90, 100, 110, 120];
const MATRIX_ANGLES = [5, 10, 15, 20, 25];

// --- FAVORITES ---
function loadFavorites() {
    try {
        const raw = localStorage.getItem(FAV_STORAGE_KEY);
        favoriteBarriers = raw ? JSON.parse(raw) : [];
    } catch(e) { favoriteBarriers = []; }
}

function persistFavorites() {
    localStorage.setItem(FAV_STORAGE_KEY, JSON.stringify(favoriteBarriers));
}

function toggleFavorite(id) {
    const idx = favoriteBarriers.indexOf(id);
    if (idx > -1) {
        favoriteBarriers.splice(idx, 1);
    } else {
        favoriteBarriers.push(id);
    }
    persistFavorites();
    filterBarriers(); // Refresh to update star
}

// --- COMPARE FUNCTIONS ---
function toggleCompare(id) {
    const idx = compareSelections.indexOf(id);
    if (idx > -1) {
        compareSelections.splice(idx, 1);
    } else {
        if (compareSelections.length >= 3) {
            alert("You can compare up to 3 items at a time.");
            // Revert checkbox
            setTimeout(() => {
                const el = document.getElementById('chk_' + id);
                if (el) el.checked = false;
            }, 0);
            return;
        }
        compareSelections.push(id);
    }
    updateCompareBar();
}

function updateCompareBar() {
    const bar = document.getElementById('compareBar');
    const countEl = document.getElementById('compareCount');
    if (!bar || !countEl) return;
    
    countEl.innerText = compareSelections.length;
    if (compareSelections.length > 0) {
        bar.style.display = 'flex';
    } else {
        bar.style.display = 'none';
    }
}

function clearComparison() {
    compareSelections = [];
    updateCompareBar();
    filterBarriers(); // Refresh grid checkboxes
}

function showComparison() {
    const modal = document.getElementById('compareModal');
    const content = document.getElementById('compareContent');
    if (!modal || !content) return;
    
    // Get Items
    const source = currentStage1Tab === 'terminal' ? END_TREATMENTS : barriers;
    const items = source.filter(b => compareSelections.includes(b.id));
    
    if (items.length === 0) return;
    
    // Build Table
    let html = `<table class="matrix-table" style="margin:0;">`;
    
    // Header
    html += `<tr><th style="width:20%">Feature</th>`;
    items.forEach(item => {
        html += `<th style="width:${80/items.length}%">${item.name}<br><span style="font-weight:400; font-size:0.85rem;">${item.supplier}</span></th>`;
    });
    html += `</tr>`;
    
    // Rows
    const rows = [
      { label: 'Type', key: 'type', fn: (v, i) => i.fullType || i.type },
      { label: 'MASH TL', key: 'tl' },
      { label: 'Test Speed', key: 'testSpeed', suffix: ' km/h', numeric: true },
      { label: 'Deflection', key: 'defl', suffix: ' m', numeric: true },
      { label: 'Working Width', key: 'ww', suffix: ' m', numeric: true },
      { label: 'System Width', key: 'width', suffix: ' m', numeric: true },
      { label: 'Test Length', key: 'testLen', suffix: ' m', numeric: true }
    ];

    rows.forEach(r => {
      html += `<tr><td><strong>${r.label}</strong></td>`;

      let minVal = Infinity;
      let hasNumber = false;
      if (r.numeric) {
        items.forEach(item => {
          const raw = r.fn ? r.fn(null, item) : item[r.key];
          const num = parseFloat(raw);
          if (!isNaN(num)) {
            hasNumber = true;
            if (num < minVal) minVal = num;
          }
        });
      }

      items.forEach(item => {
        let val = r.fn ? r.fn(null, item) : item[r.key];
        let display = val;
        let deltaBadge = '';
        if (r.numeric) {
          const num = parseFloat(val);
          if (!isNaN(num) && hasNumber && isFinite(minVal)) {
            const delta = num - minVal;
            if (Math.abs(delta) < 0.01) {
              deltaBadge = '<span class="delta-good">best</span>';
            } else {
              deltaBadge = `<span class="delta-bad">+${delta.toFixed(2)}</span>`;
            }
          }
          display = isNaN(num) ? '-' : num.toFixed(2);
        }
        if (display === undefined || display === null || display === 'NaN') display = '-';
        if (r.suffix && display !== '-') display += r.suffix;
        html += `<td>${display} ${deltaBadge}</td>`;
      });
      html += `</tr>`;
    });
    
    html += `</table>`;
    
    content.innerHTML = html;
    modal.style.display = 'flex';
}

function closeComparison() {
    document.getElementById('compareModal').style.display = 'none';
}

function openGlossary() {
    document.getElementById('glossaryModal').style.display = 'flex';
}

function closeGlossary() {
    document.getElementById('glossaryModal').style.display = 'none';
}

function generateShareLink() {
    if (!selectedBarrier) {
        alert("Please select a barrier to share.");
        return;
    }
    
    const params = new URLSearchParams();
    
    // Core selection
    params.set('type', currentStage1Tab); // barrier/terminal
    params.set('id', selectedBarrier.id);
    
    // Site Inputs
    const speed = document.getElementById('siteSpeed').value;
    const width = document.getElementById('siteWidth').value;
    if (speed) params.set('speed', speed);
    if (width) params.set('width', width);

    const url = window.location.origin + window.location.pathname + '?' + params.toString();
    
    // Copy to clipboard
    navigator.clipboard.writeText(url).then(() => {
        // Show temporary success feedback
        const btn = document.activeElement;
        if(btn && btn.tagName === 'BUTTON') {
            const originalText = btn.innerHTML;
            btn.innerHTML = '✅ Link Copied!';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        } else {
             alert("Link copied to clipboard!\n" + url);
        }
    }).catch(err => {
        prompt("Copy this link:", url);
    });
}

function checkUrlParams() {
    const params = new URLSearchParams(window.location.search);
    const type = params.get('type');
    const id = parseInt(params.get('id'));
    const speed = params.get('speed');
    const width = params.get('width');
    
    if (!type && !id && !speed && !width) return;

    if (speed) document.getElementById('siteSpeed').value = speed;
    if (width) document.getElementById('siteWidth').value = width;
    
    // Update filters
    if (speed || width) filterBarriers();
    
    if (type && !isNaN(id)) {
        // Ensure correct tab
        if (type === 'terminal' || type === 'barrier') {
             switchStage1Tab(type);
        }
        
        // Select Barrier
        // Delay to allow any UI updates
        setTimeout(() => {
            selectBarrier(id, type);
        }, 200);
    }
}

// ========================================
// RISK ASSESSMENT FUNCTIONS
// ========================================

// Calculate risk level from likelihood and consequence
function calculateRisk(likelihood, consequence) {
    if (!likelihood || !consequence) return '';
    
    const matrix = {
        '1': { '1': 'Low', '2': 'Low', '3': 'Medium', '4': 'High', '5': 'High' },
        '2': { '1': 'Low', '2': 'Medium', '3': 'Medium', '4': 'High', '5': 'Critical' },
        '3': { '1': 'Medium', '2': 'Medium', '3': 'High', '4': 'High', '5': 'Critical' },
        '4': { '1': 'High', '2': 'High', '3': 'High', '4': 'Critical', '5': 'Critical' },
        '5': { '1': 'High', '2': 'Critical', '3': 'Critical', '4': 'Critical', '5': 'Critical' }
    };
    
    return matrix[likelihood]?.[consequence] || '';
}

// Update calculated risk field
function updateCalculatedRisk(row, type) {
    const selects = row.querySelectorAll('select');
    let likelihoodSelect, consequenceSelect, riskDisplay;
    
    if (type === 'initial') {
        likelihoodSelect = selects[0]; // Initial Likelihood
        consequenceSelect = selects[1]; // Initial Consequence
        riskDisplay = selects[2]; // Initial Risk display
    } else {
        likelihoodSelect = selects[3]; // Residual Likelihood
        consequenceSelect = selects[4]; // Residual Consequence
        riskDisplay = selects[5]; // Residual Risk display
    }
    
    const likelihood = likelihoodSelect?.value;
    const consequence = consequenceSelect?.value;
    const calculatedRisk = calculateRisk(likelihood, consequence);
    
    if (riskDisplay && calculatedRisk) {
        riskDisplay.value = calculatedRisk;
        updateSeverityColor(riskDisplay);
    }
    
    updateRiskSummary();
}

// --- UPDATED RISK ASSESSMENT DATA FROM PDF ---
// Risk templates for different design types
const riskTemplates = {
    'swept-paths': [
        { 
            name: 'Footpath Encroachment', 
            impact: 'Public Injury (Severe) - Vehicle striking pedestrians on footpath.',
            initialLikelihood: '5',
            initialConsequence: '5',
            controls: [
                { type: 'Elimination', description: 'Restrict vehicle access to smaller vehicles that do not encroach on footpaths.' },
                { type: 'Administrative', description: 'Use traffic controllers to manage pedestrian movement during vehicle maneuvers.' }
            ],
            residualLikelihood: '2',
            residualConsequence: '3',
            owner: 'Site Manager'
        },
        { 
            name: 'Traffic Island/Refuge Impact', 
            impact: 'Property Damage - Vehicle grounding or striking infrastructure during turns.',
            initialLikelihood: '4',
            initialConsequence: '3',
            controls: [
                { type: 'Engineering', description: 'Physical removal/modification of refuge island required prior to access.' },
                { type: 'Administrative', description: 'Verify works complete before first delivery. Pre-delivery site inspection.' }
            ],
            residualLikelihood: '1',
            residualConsequence: '3',
            owner: 'Project Engineer'
        },
        { 
            name: 'Multi-Lane Use (Wide Turns)', 
            impact: 'Traffic Collision - Collision with oncoming or adjacent traffic during wide turning movements.',
            initialLikelihood: '4',
            initialConsequence: '4',
            controls: [
                { type: 'Administrative', description: 'Use authorized Traffic Controllers to hold traffic during maneuvers.' },
                { type: 'Administrative', description: 'Schedule deliveries during off-peak hours to minimize traffic conflicts.' }
            ],
            residualLikelihood: '2',
            residualConsequence: '3',
            owner: 'Traffic Coordinator'
        },
        { 
            name: 'Overhead Clearance Issues', 
            impact: 'Vehicle/Infrastructure Damage - Collision with overhead utilities, signs, or structures.',
            initialLikelihood: '3',
            initialConsequence: '4',
            controls: [
                { type: 'Engineering', description: 'Conduct height clearance survey and mark low clearance areas.' },
                { type: 'Administrative', description: 'Provide drivers with site-specific route plans showing clearance heights.' }
            ],
            residualLikelihood: '1',
            residualConsequence: '3',
            owner: 'Site Manager'
        },
        { 
            name: 'Sight Distance Restrictions', 
            impact: 'Traffic Collision - Reduced visibility at entry/exit points leading to collisions.',
            initialLikelihood: '3',
            initialConsequence: '4',
            controls: [
                { type: 'Administrative', description: 'Deploy traffic controllers at blind spots during vehicle movements.' },
                { type: 'Engineering', description: 'Install temporary mirrors or warning signs to improve sight lines.' }
            ],
            residualLikelihood: '2',
            residualConsequence: '2',
            owner: 'Traffic Coordinator'
        }
    ],
    'barrier': [
        { 
            name: 'Inadequate Barrier Deflection Containment', 
            impact: 'Vehicle Intrusion - Errant vehicle breaking through barrier and entering work zone or adjacent property.',
            initialLikelihood: '3',
            initialConsequence: '5',
            controls: [
                { type: 'Engineering', description: 'Design barrier with appropriate working width based on speed and road type per AS1742.3.' },
                { type: 'Engineering', description: 'Ensure adequate clearance between barrier and protected area (workers/public).' },
                { type: 'Administrative', description: 'Regular inspection and maintenance of barrier integrity.' }
            ],
            residualLikelihood: '1',
            residualConsequence: '4',
            owner: 'Project Engineer'
        },
        { 
            name: 'Barrier Installation Errors', 
            impact: 'Barrier Failure - Incorrect installation leading to barrier not performing as designed during impact.',
            initialLikelihood: '3',
            initialConsequence: '4',
            controls: [
                { type: 'Administrative', description: 'Use trained and competent installers. Provide installation drawings and specifications.' },
                { type: 'Administrative', description: 'Conduct installation quality checks before site handover.' },
                { type: 'Engineering', description: 'Ensure correct anchoring, connection, and orientation as per manufacturer specifications.' }
            ],
            residualLikelihood: '1',
            residualConsequence: '3',
            owner: 'Site Supervisor'
        },
        { 
            name: 'Vehicle Impact on Barrier', 
            impact: 'Worker Injury/Property Damage - Vehicle striking barrier causing deflection into work area.',
            initialLikelihood: '4',
            initialConsequence: '4',
            controls: [
                { type: 'Engineering', description: 'Select appropriate barrier type and length for site speed and conditions.' },
                { type: 'Engineering', description: 'Provide adequate transition and end treatments.' },
                { type: 'Administrative', description: 'Maintain exclusion zones behind barriers. Post speed restrictions and warning signage.' }
            ],
            residualLikelihood: '2',
            residualConsequence: '3',
            owner: 'Site Manager'
        },
        { 
            name: 'End Terminal Hazard', 
            impact: 'Severe Injury/Fatality - Vehicle striking exposed barrier end causing vehicle intrusion or injury.',
            initialLikelihood: '3',
            initialConsequence: '5',
            controls: [
                { type: 'Engineering', description: 'Install approved end terminals or transition to rigid barrier/guardrail.' },
                { type: 'Engineering', description: 'Flare barrier away from traffic or anchor to rigid structure where possible.' },
                { type: 'Administrative', description: 'Install advanced warning signs and delineation.' }
            ],
            residualLikelihood: '1',
            residualConsequence: '4',
            owner: 'Project Engineer'
        },
        { 
            name: 'Insufficient Working Width', 
            impact: 'Worker/Public Injury - Deflecting barrier encroaching into work zone or adjacent areas.',
            initialLikelihood: '3',
            initialConsequence: '4',
            controls: [
                { type: 'Engineering', description: 'Calculate and verify working width requirements per AS1742.3 Table 6.1.' },
                { type: 'Engineering', description: 'Adjust barrier placement or work zone layout to provide adequate clearance.' },
                { type: 'Administrative', description: 'Mark exclusion zones and ensure workers stay clear of deflection areas.' }
            ],
            residualLikelihood: '1',
            residualConsequence: '3',
            owner: 'Project Engineer'
        },
        { 
            name: 'Barrier Displacement/Movement', 
            impact: 'Gap Formation - Barriers separating or moving creating gaps for vehicle intrusion.',
            initialLikelihood: '3',
            initialConsequence: '3',
            controls: [
                { type: 'Engineering', description: 'Use appropriate connections and ballasting for site conditions.' },
                { type: 'Administrative', description: 'Daily visual inspections for gaps, displacement, or damage.' },
                { type: 'Administrative', description: 'Immediate rectification of any displacement or separation.' }
            ],
            residualLikelihood: '1',
            residualConsequence: '2',
            owner: 'Site Supervisor'
        }
    ],
    'other': [
        { 
            name: 'Traffic Management Inadequacy', 
            impact: 'Traffic Collision - Inadequate traffic control leading to vehicle-vehicle or vehicle-pedestrian collisions.',
            initialLikelihood: '3',
            initialConsequence: '4',
            controls: [
                { type: 'Engineering', description: 'Develop and implement Traffic Management Plan (TMP) per AS1742 series.' },
                { type: 'Administrative', description: 'Use qualified traffic controllers and ensure compliance with TMP.' },
                { type: 'Administrative', description: 'Regular review and update of traffic management measures.' }
            ],
            residualLikelihood: '1',
            residualConsequence: '3',
            owner: 'Traffic Coordinator'
        },
        { 
            name: 'Work Zone Intrusion', 
            impact: 'Worker Injury - Vehicles entering work zone and striking workers or equipment.',
            initialLikelihood: '3',
            initialConsequence: '5',
            controls: [
                { type: 'Engineering', description: 'Install physical barriers and delineation around work zones.' },
                { type: 'Administrative', description: 'Enforce exclusion zones and provide hi-visibility clothing for workers.' },
                { type: 'Administrative', description: 'Deploy traffic controllers at high-risk locations.' }
            ],
            residualLikelihood: '1',
            residualConsequence: '4',
            owner: 'Site Manager'
        },
        { 
            name: 'Inadequate Signage/Delineation', 
            impact: 'Driver Confusion - Motorists unaware of hazards leading to erratic movements or collisions.',
            initialLikelihood: '4',
            initialConsequence: '3',
            controls: [
                { type: 'Engineering', description: 'Install compliant warning signs, speed limits, and delineation devices.' },
                { type: 'Administrative', description: 'Conduct site audit to verify signage placement and visibility.' },
                { type: 'Administrative', description: 'Maintain and replace damaged or missing signs immediately.' }
            ],
            residualLikelihood: '2',
            residualConsequence: '2',
            owner: 'Project Engineer'
        }
    ]
};

// Keep legacy default for backwards compatibility
const defaultRiskFactors = riskTemplates['barrier'];

// Common notes templates for each design type
const riskNotesTemplates = {
    'swept-paths': [
        'All swept path analysis conducted using AutoTURN or similar software with design vehicle specifications per Austroads guidelines.',
        'Site-specific constraints including existing infrastructure, utilities, and property boundaries have been considered.',
        'Traffic management measures must be implemented during vehicle access and egress as per approved Traffic Management Plan.',
        'Pre-delivery site inspections required to verify all required modifications/removals are complete.',
        'All vehicle movements to be supervised by qualified traffic controllers when public access is maintained.'
    ],
    'barrier': [
        'Barrier design and placement complies with AS1742.3 requirements for temporary traffic barriers.',
        'Working width calculations based on design speed, barrier type, and site-specific conditions.',
        'Regular inspections required to verify barrier integrity, connections, and correct placement.',
        'All barrier installations to be completed by trained personnel following manufacturer specifications.',
        'Appropriate end treatments and transitions required at all barrier terminations.',
        'Exclusion zones behind barriers to be maintained and clearly marked to protect workers and public.'
    ],
    'other': [
        'Traffic Management Plan (TMP) prepared in accordance with AS1742 series standards.',
        'All traffic control devices to comply with current MUTCD and relevant state/territory requirements.',
        'Regular site audits required to verify compliance with approved TMP.',
        'All personnel working in or near traffic to complete appropriate traffic management training.',
        'Emergency response procedures established and communicated to all site personnel.'
    ]
};

let riskRowCounter = 0;

// Initialize risk assessment table
function initRiskAssessment() {
    const tableBody = document.getElementById('riskTableBody');
    tableBody.innerHTML = ''; // Clear existing
    riskRowCounter = 0;
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('riskDate').value = today;
    document.getElementById('preparedDate').value = today;
    document.getElementById('reviewedDate').value = today;
    // Keep approvedDate blank by default
    
    // Auto-populate Prepared by and Reviewed by from barrier section
    const designedBy = document.getElementById('sigDesignedBy')?.value || '';
    const reviewedByBarrier = document.getElementById('sigReviewedBy')?.value || '';
    
    if (designedBy) {
        document.getElementById('preparedBy').value = designedBy;
    }
    if (reviewedByBarrier) {
        document.getElementById('reviewedBy').value = reviewedByBarrier;
    }
    
    // Don't populate risks on initial load - wait for design type selection
    updateRiskSummary();
}

// Handle design type selection change
function handleDesignTypeChange() {
    const designType = document.getElementById('designType').value;
    const otherContainer = document.getElementById('otherDesignTypeContainer');
    const infoDiv = document.getElementById('designTypeInfo');
    const infoParagraph = infoDiv.querySelector('p');
    
    // Show/hide 'other' specification field
    if (designType === 'other') {
        otherContainer.style.display = 'block';
    } else {
        otherContainer.style.display = 'none';
        document.getElementById('otherDesignType').value = '';
    }
    
    // Show info message and populate risks
    if (designType) {
        infoDiv.style.display = 'block';
        
        let infoText = '';
        let riskCount = 0;
        
        switch(designType) {
            case 'swept-paths':
                infoText = '✓ Pre-populating common risks for Swept Paths Design (footpath encroachment, traffic islands, wide turns, overhead clearance, sight distances). You can edit or add more risks as needed.';
                riskCount = riskTemplates['swept-paths'].length;
                break;
            case 'barrier':
                infoText = '✓ Pre-populating common risks for Barrier Design (deflection containment, installation errors, impacts, end terminals, working width, displacement). You can edit or add more risks as needed.';
                riskCount = riskTemplates['barrier'].length;
                break;
            case 'other':
                infoText = '✓ Pre-populating general traffic management risks. Please specify your design type above and customize the risks as needed.';
                riskCount = riskTemplates['other'].length;
                break;
        }
        
        infoParagraph.textContent = `${infoText} (${riskCount} risks loaded)`;
        
        // Clear existing risks and populate based on selection
        const tableBody = document.getElementById('riskTableBody');
        tableBody.innerHTML = '';
        riskRowCounter = 0;
        
        const selectedTemplate = riskTemplates[designType] || [];
        selectedTemplate.forEach((factor) => {
            addRiskRowWithData(factor.name, factor.impact, factor.initialLikelihood, factor.initialConsequence, 
                              factor.controls, factor.residualLikelihood, factor.residualConsequence, factor.owner);
        });
        
        // Populate common notes for the selected design type
        const notesTemplate = riskNotesTemplates[designType] || [];
        riskNotes = []; // Clear existing notes
        riskNoteCounter = 0;
        notesTemplate.forEach(noteText => {
            addRiskNote(noteText);
        });
        
        updateRiskSummary();
    } else {
        infoDiv.style.display = 'none';
    }
}

// Add risk row with data (Updated for new columns)
function addRiskRowWithData(name, impact, initLikelihood, initConsequence, controls, resLikelihood, resConsequence, owner) {
    riskRowCounter++;
    const tableBody = document.getElementById('riskTableBody');
    const row = document.createElement('tr');
    row.style.borderBottom = '1px solid var(--border-color)';
    
    // Calculate initial and residual risk
    const initialRisk = calculateRisk(initLikelihood, initConsequence);
    const residualRisk = calculateRisk(resLikelihood, resConsequence);
    
    // Generate controls HTML
    const controlTypes = ['Elimination', 'Substitution', 'Engineering', 'Administrative', 'PPE'];
    let controlsHTML = '<div style="display:flex; flex-direction:column; gap:6px;">';
    
    controlTypes.forEach(type => {
        const existingControl = Array.isArray(controls) ? controls.find(c => c.type === type) : null;
        const isChecked = existingControl ? 'checked' : '';
        const description = existingControl ? existingControl.description : '';
        
        controlsHTML += `
            <div style="display:flex; align-items:start; gap:6px; padding:4px; background:${isChecked ? '#f8fafc' : 'transparent'}; border-radius:4px;">
                <input type="checkbox" ${isChecked} style="margin-top:4px;" onchange="toggleControlField(this)">
                <div style="flex:1;">
                    <div style="font-size:0.75rem; font-weight:600; color:#64748b; margin-bottom:2px;">${type}</div>
                    <textarea placeholder="Describe ${type.toLowerCase()} control..." rows="2"
                           style="width:100%; padding:4px; border:1px solid #cbd5e1; border-radius:3px; font-size:0.8rem; resize:vertical; display:${isChecked ? 'block' : 'none'};">${description}</textarea>
                </div>
            </div>
        `;
    });
    
    controlsHTML += '</div>';
    
    row.innerHTML = `
        <td style="padding:8px; text-align:center; vertical-align:middle; font-weight:700; color:#64748b;">
            ${riskRowCounter}
        </td>
        <td style="padding:8px; vertical-align:top;">
            <textarea placeholder="Hazard name" rows="3"
                   style="width:100%; padding:6px; border:1px solid #cbd5e1; border-radius:4px; font-family:inherit; resize:vertical; font-size:0.9rem;"
                   onchange="updateRiskSummary()">${name}</textarea>
        </td>
        <td style="padding:8px; vertical-align:top;">
            <textarea placeholder="Impact/Consequence" rows="3"
                   style="width:100%; padding:6px; border:1px solid #cbd5e1; border-radius:4px; font-family:inherit; resize:vertical; font-size:0.9rem;">${impact}</textarea>
        </td>
        <td style="padding:8px; text-align:center; vertical-align:top;">
            <select style="width:100%; padding:6px; border:1px solid #cbd5e1; border-radius:4px; font-size:0.85rem;" 
                    onchange="updateCalculatedRisk(this.closest('tr'), 'initial');">
                <option value="">-</option>
                <option value="1" ${initLikelihood === '1' ? 'selected' : ''}>1 - Rare</option>
                <option value="2" ${initLikelihood === '2' ? 'selected' : ''}>2 - Unlikely</option>
                <option value="3" ${initLikelihood === '3' ? 'selected' : ''}>3 - Possible</option>
                <option value="4" ${initLikelihood === '4' ? 'selected' : ''}>4 - Likely</option>
                <option value="5" ${initLikelihood === '5' ? 'selected' : ''}>5 - Almost Certain</option>
            </select>
        </td>
        <td style="padding:8px; text-align:center; vertical-align:top;">
            <select style="width:100%; padding:6px; border:1px solid #cbd5e1; border-radius:4px; font-size:0.85rem;" 
                    onchange="updateCalculatedRisk(this.closest('tr'), 'initial');">
                <option value="">-</option>
                <option value="1" ${initConsequence === '1' ? 'selected' : ''}>1 - Insignificant</option>
                <option value="2" ${initConsequence === '2' ? 'selected' : ''}>2 - Minor</option>
                <option value="3" ${initConsequence === '3' ? 'selected' : ''}>3 - Moderate</option>
                <option value="4" ${initConsequence === '4' ? 'selected' : ''}>4 - Major</option>
                <option value="5" ${initConsequence === '5' ? 'selected' : ''}>5 - Catastrophic</option>
            </select>
        </td>
        <td style="padding:8px; text-align:center; vertical-align:top;">
            <select style="width:100%; padding:6px; border:1px solid #cbd5e1; border-radius:4px; font-weight:700; font-size:0.85rem;" 
                    disabled
                    data-severity="${initialRisk}">
                <option value="">-</option>
                <option value="Low" ${initialRisk === 'Low' ? 'selected' : ''}>Low</option>
                <option value="Medium" ${initialRisk === 'Medium' ? 'selected' : ''}>Medium</option>
                <option value="High" ${initialRisk === 'High' ? 'selected' : ''}>High</option>
                <option value="Critical" ${initialRisk === 'Critical' ? 'selected' : ''}>Critical</option>
            </select>
        </td>
        <td style="padding:8px; vertical-align:top;">
            ${controlsHTML}
        </td>
        <td style="padding:8px; text-align:center; vertical-align:top;">
            <select style="width:100%; padding:6px; border:1px solid #cbd5e1; border-radius:4px; font-size:0.85rem;" 
                    onchange="updateCalculatedRisk(this.closest('tr'), 'residual');">
                <option value="">-</option>
                <option value="1" ${resLikelihood === '1' ? 'selected' : ''}>1 - Rare</option>
                <option value="2" ${resLikelihood === '2' ? 'selected' : ''}>2 - Unlikely</option>
                <option value="3" ${resLikelihood === '3' ? 'selected' : ''}>3 - Possible</option>
                <option value="4" ${resLikelihood === '4' ? 'selected' : ''}>4 - Likely</option>
                <option value="5" ${resLikelihood === '5' ? 'selected' : ''}>5 - Almost Certain</option>
            </select>
        </td>
        <td style="padding:8px; text-align:center; vertical-align:top;">
            <select style="width:100%; padding:6px; border:1px solid #cbd5e1; border-radius:4px; font-size:0.85rem;" 
                    onchange="updateCalculatedRisk(this.closest('tr'), 'residual');">
                <option value="">-</option>
                <option value="1" ${resConsequence === '1' ? 'selected' : ''}>1 - Insignificant</option>
                <option value="2" ${resConsequence === '2' ? 'selected' : ''}>2 - Minor</option>
                <option value="3" ${resConsequence === '3' ? 'selected' : ''}>3 - Moderate</option>
                <option value="4" ${resConsequence === '4' ? 'selected' : ''}>4 - Major</option>
                <option value="5" ${resConsequence === '5' ? 'selected' : ''}>5 - Catastrophic</option>
            </select>
        </td>
        <td style="padding:8px; text-align:center; vertical-align:top;">
            <select style="width:100%; padding:6px; border:1px solid #cbd5e1; border-radius:4px; font-weight:700; font-size:0.85rem;" 
                    disabled
                    data-severity="${residualRisk}">
                <option value="">-</option>
                <option value="Low" ${residualRisk === 'Low' ? 'selected' : ''}>Low</option>
                <option value="Medium" ${residualRisk === 'Medium' ? 'selected' : ''}>Medium</option>
                <option value="High" ${residualRisk === 'High' ? 'selected' : ''}>High</option>
                <option value="Critical" ${residualRisk === 'Critical' ? 'selected' : ''}>Critical</option>
            </select>
        </td>
        <td style="padding:8px; vertical-align:top;">
            <input type="text" placeholder="Risk owner" value="${owner}"
                   style="width:100%; padding:6px; border:1px solid #cbd5e1; border-radius:4px; font-size:0.9rem;">
        </td>
        <td style="padding:8px; text-align:center; vertical-align:middle;">
            <button class="btn-link" onclick="removeRiskRow(this)" style="color:#ef4444; font-size:1.5rem; padding:4px;">×</button>
        </td>
    `;
    
    // Apply initial colors
    const selects = row.querySelectorAll('select[data-severity]');
    selects.forEach(s => updateSeverityColor(s));
    
    tableBody.appendChild(row);
}

// Toggle control field visibility
function toggleControlField(checkbox) {
    const textarea = checkbox.parentElement.querySelector('textarea');
    const container = checkbox.parentElement;
    if (checkbox.checked) {
        textarea.style.display = 'block';
        container.style.background = '#f8fafc';
    } else {
        textarea.style.display = 'none';
        textarea.value = '';
        container.style.background = 'transparent';
    }
}

function updateSeverityColor(select) {
    const val = select.value;
    select.style.backgroundColor = getSeverityColor(val);
    select.style.color = getSeverityTextColor(val);
}

// Add custom risk row
function addRiskRow() {
    addRiskRowWithData('', '', '', '', [], '', '', '');
}

// Remove risk row
function removeRiskRow(button) {
    const row = button.closest('tr');
    row.remove();
    updateRiskSummary();
}

// Get severity color
function getSeverityColor(severity) {
    const colors = {
        'Low': '#d1fae5',
        'Medium': '#fef3c7',
        'High': '#fed7aa',
        'Critical': '#fecaca'
    };
    return colors[severity] || '#ffffff';
}

// Get severity text color
function getSeverityTextColor(severity) {
    const colors = {
        'Low': '#065f46',
        'Medium': '#92400e',
        'High': '#9a3412',
        'Critical': '#991b1b'
    };
    return colors[severity] || '#000000';
}

// Update risk summary with enhanced statistics dashboard
function updateRiskSummary() {
    const tableBody = document.getElementById('riskTableBody');
    const rows = tableBody.querySelectorAll('tr');
    
    let initialCounts = { Low: 0, Medium: 0, High: 0, Critical: 0, Unassessed: 0 };
    let residualCounts = { Low: 0, Medium: 0, High: 0, Critical: 0, Unassessed: 0 };
    let totalRisks = rows.length;
    let totalInitialScore = 0;
    let totalResidualScore = 0;
    let risksWithControls = 0;
    
    rows.forEach(row => {
        const selects = row.querySelectorAll('select');
        
        // Initial Risk (5th select)
        const initialRiskSelect = selects[2];
        if (initialRiskSelect && initialRiskSelect.value) {
            initialCounts[initialRiskSelect.value]++;
            const riskValue = getRiskNumericValue(initialRiskSelect.value);
            totalInitialScore += riskValue;
        } else {
            initialCounts.Unassessed++;
        }
        
        // Residual Risk (8th select)
        const residualRiskSelect = selects[5];
        if (residualRiskSelect && residualRiskSelect.value) {
            residualCounts[residualRiskSelect.value]++;
            const riskValue = getRiskNumericValue(residualRiskSelect.value);
            totalResidualScore += riskValue;
        } else {
            residualCounts.Unassessed++;
        }
        
        // Check if controls are present
        const controlTextareas = row.querySelectorAll('textarea');
        if (controlTextareas.length > 0 && controlTextareas[0].value.trim()) {
            risksWithControls++;
        }
    });
    
    const summaryDiv = document.getElementById('riskSummary');
    
    if (totalRisks === 0) {
        summaryDiv.innerHTML = '<p style="color:var(--text-sub); margin:0;">No risk factors assessed yet. Add risks using the table above.</p>';
        return;
    }
    
    // Calculate improvement
    const avgInitial = totalRisks > 0 ? (totalInitialScore / totalRisks).toFixed(0) : 0;
    const avgResidual = totalRisks > 0 ? (totalResidualScore / totalRisks).toFixed(0) : 0;
    const improvement = totalInitialScore > 0 ? (((totalInitialScore - totalResidualScore) / totalInitialScore) * 100).toFixed(0) : 0;
    
    // Calculate overall risk levels
    const overallInitial = getOverallRiskLevel(initialCounts);
    const overallResidual = getOverallRiskLevel(residualCounts);
    
    summaryDiv.innerHTML = `
        <!-- Statistics Dashboard -->
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:20px;">
            <div style="text-align:center; padding:16px; background:white; border-radius:8px; border:1px solid #e2e8f0;">
                <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:4px;">Total Risks</div>
                <div style="font-size:2rem; font-weight:700; color:var(--primary);">${totalRisks}</div>
            </div>
            <div style="text-align:center; padding:16px; background:white; border-radius:8px; border:1px solid #e2e8f0;">
                <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:4px;">Avg Initial Risk</div>
                <div style="font-size:2rem; font-weight:700; color:#f59e0b;">${avgInitial}</div>
            </div>
            <div style="text-align:center; padding:16px; background:white; border-radius:8px; border:1px solid #e2e8f0;">
                <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:4px;">Avg Residual Risk</div>
                <div style="font-size:2rem; font-weight:700; color:#10b981;">${avgResidual}</div>
            </div>
            <div style="text-align:center; padding:16px; background:white; border-radius:8px; border:1px solid #e2e8f0;">
                <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:4px;">Risk Reduction</div>
                <div style="font-size:2rem; font-weight:700; color:#10b981;">${improvement}%</div>
            </div>
        </div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <!-- Initial Risk Distribution -->
            <div>
                <h4 style="margin:0 0 12px 0; font-size:0.95rem; color:var(--text-main);">Initial Risk Distribution</h4>
                <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px;">
                    <div style="text-align:center; padding:12px; background:#dcfce7; border-radius:6px;">
                        <div style="font-size:0.75rem; color:#065f46; margin-bottom:2px;">Low</div>
                        <div style="font-size:1.5rem; font-weight:700; color:#065f46;">${initialCounts.Low}</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#fef9c3; border-radius:6px;">
                        <div style="font-size:0.75rem; color:#854d0e; margin-bottom:2px;">Medium</div>
                        <div style="font-size:1.5rem; font-weight:700; color:#854d0e;">${initialCounts.Medium}</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#ffedd5; border-radius:6px;">
                        <div style="font-size:0.75rem; color:#9a3412; margin-bottom:2px;">High</div>
                        <div style="font-size:1.5rem; font-weight:700; color:#9a3412;">${initialCounts.High}</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#fee2e2; border-radius:6px;">
                        <div style="font-size:0.75rem; color:#991b1b; margin-bottom:2px;">Critical</div>
                        <div style="font-size:1.5rem; font-weight:700; color:#991b1b;">${initialCounts.Critical}</div>
                    </div>
                </div>
                <div style="margin-top:12px; padding:12px; background:${overallInitial.color}15; border-left:4px solid ${overallInitial.color}; border-radius:4px;">
                    <div style="font-size:0.8rem; color:var(--text-sub);">Overall Initial Risk</div>
                    <div style="font-size:1.1rem; font-weight:700; color:${overallInitial.color};">${overallInitial.level}</div>
                </div>
            </div>
            
            <!-- Residual Risk Distribution -->
            <div>
                <h4 style="margin:0 0 12px 0; font-size:0.95rem; color:var(--text-main);">Residual Risk Distribution</h4>
                <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px;">
                    <div style="text-align:center; padding:12px; background:#dcfce7; border-radius:6px;">
                        <div style="font-size:0.75rem; color:#065f46; margin-bottom:2px;">Low</div>
                        <div style="font-size:1.5rem; font-weight:700; color:#065f46;">${residualCounts.Low}</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#fef9c3; border-radius:6px;">
                        <div style="font-size:0.75rem; color:#854d0e; margin-bottom:2px;">Medium</div>
                        <div style="font-size:1.5rem; font-weight:700; color:#854d0e;">${residualCounts.Medium}</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#ffedd5; border-radius:6px;">
                        <div style="font-size:0.75rem; color:#9a3412; margin-bottom:2px;">High</div>
                        <div style="font-size:1.5rem; font-weight:700; color:#9a3412;">${residualCounts.High}</div>
                    </div>
                    <div style="text-align:center; padding:12px; background:#fee2e2; border-radius:6px;">
                        <div style="font-size:0.75rem; color:#991b1b; margin-bottom:2px;">Critical</div>
                        <div style="font-size:1.5rem; font-weight:700; color:#991b1b;">${residualCounts.Critical}</div>
                    </div>
                </div>
                <div style="margin-top:12px; padding:12px; background:${overallResidual.color}15; border-left:4px solid ${overallResidual.color}; border-radius:4px;">
                    <div style="font-size:0.8rem; color:var(--text-sub);">Overall Residual Risk</div>
                    <div style="font-size:1.1rem; font-weight:700; color:${overallResidual.color};">${overallResidual.level}</div>
                </div>
            </div>
        </div>
        
        ${residualCounts.Critical > 0 || residualCounts.High > 0 ? `
        <div style="margin-top:16px; padding:12px; background:#fef3c7; border-left:4px solid #f59e0b; border-radius:4px;">
            <strong style="color:#92400e;">⚠️ Action Required:</strong>
            <span style="color:#92400e; font-size:0.9rem;">
                ${residualCounts.Critical > 0 ? `${residualCounts.Critical} Critical risk(s) require immediate attention. ` : ''}
                ${residualCounts.High > 0 ? `${residualCounts.High} High risk(s) need management review.` : ''}
            </span>
        </div>
        ` : ''}
    `;
}

// Helper: Get numeric value for risk level
function getRiskNumericValue(severity) {
    const values = { 'Low': 2, 'Medium': 7, 'High': 12, 'Critical': 20 };
    return values[severity] || 0;
}

// Helper: Get overall risk level
function getOverallRiskLevel(counts) {
    if (counts.Critical > 0) {
        return { level: 'Critical', color: '#ef4444' };
    } else if (counts.High >= 2) {
        return { level: 'High', color: '#f97316' };
    } else if (counts.High >= 1 || counts.Medium >= 3) {
        return { level: 'Medium-High', color: '#f59e0b' };
    } else if (counts.Medium >= 1) {
        return { level: 'Medium', color: '#eab308' };
    }
    return { level: 'Low', color: '#10b981' };
}

  // Helper: Format risk notes for report
  function buildRiskNotesHtml(notes, format) {
    const trimmed = (notes || '').trim();
    if (!trimmed) {
      return '<div style="color:#475569; font-size:0.85rem;">No additional notes provided.</div>';
    }

    if (format === 'bulleted') {
      const lines = trimmed
        .split(/\n+/)
        .map(line => line.trim())
        .filter(Boolean);

      if (lines.length === 0) {
        return '<div style="color:#475569; font-size:0.85rem;">No additional notes provided.</div>';
      }

      return `
        <ul style="margin:0; padding-left:18px; color:#475569; font-size:0.85rem;">
          ${lines.map(line => `<li>${line}</li>`).join('')}
        </ul>
      `;
    }

    return `<div style="white-space:pre-wrap; color:#475569; font-size:0.85rem;">${trimmed}</div>`;
  }

// Generate updated risk assessment report matching PDF columns
function generateRiskReport() {
    const projectName = document.getElementById('riskProjectName').value || 'Untitled Project';
    const location = document.getElementById('riskLocation').value || 'Not specified';
    const date = document.getElementById('riskDate').value || 'Not specified';
    const docRef = document.getElementById('riskDocRef').value || 'Not specified';
    const refDrawings = document.getElementById('riskRefDrawings').value || 'Not specified';
    
    const tableBody = document.getElementById('riskTableBody');
    const rows = tableBody.querySelectorAll('tr');
    
    // Calculate statistics for the report
    let initialCounts = { Low: 0, Medium: 0, High: 0, Critical: 0 };
    let residualCounts = { Low: 0, Medium: 0, High: 0, Critical: 0 };
    let totalRisks = rows.length;
    let totalInitialScore = 0;
    let totalResidualScore = 0;
    
    rows.forEach(row => {
        const selects = row.querySelectorAll('select');
        const initialRiskSelect = selects[2];
        const residualRiskSelect = selects[5];
        
        if (initialRiskSelect?.value) {
            initialCounts[initialRiskSelect.value]++;
            totalInitialScore += getRiskNumericValue(initialRiskSelect.value);
        }
        if (residualRiskSelect?.value) {
            residualCounts[residualRiskSelect.value]++;
            totalResidualScore += getRiskNumericValue(residualRiskSelect.value);
        }
    });
    
    const avgInitial = totalRisks > 0 ? (totalInitialScore / totalRisks).toFixed(0) : 0;
    const avgResidual = totalRisks > 0 ? (totalResidualScore / totalRisks).toFixed(0) : 0;
    const improvement = totalInitialScore > 0 ? (((totalInitialScore - totalResidualScore) / totalInitialScore) * 100).toFixed(0) : 0;
    const overallInitial = getOverallRiskLevel(initialCounts);
    const overallResidual = getOverallRiskLevel(residualCounts);
    
    const likelihoodLabels = { '1': 'Rare', '2': 'Unlikely', '3': 'Possible', '4': 'Likely', '5': 'Almost Certain' };
    const consequenceLabels = { '1': 'Insignificant', '2': 'Minor', '3': 'Moderate', '4': 'Major', '5': 'Catastrophic' };
    
    let reportHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Risk Assessment - ${projectName}</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; padding: 20px; color: #1e293b; font-size:0.85rem; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .header { border-bottom: 3px solid #2563eb; padding-bottom: 20px; margin-bottom: 20px; display:flex; justify-content:space-between; }
        .header h1 { color: #2563eb; margin: 0; font-size: 1.6rem; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.8rem; }
        th { background: #1e293b; color: white; padding: 8px; text-align: left; border: 1px solid #0f172a; font-size:0.75rem; }
        td { padding: 8px; border: 1px solid #cbd5e1; vertical-align: top; }
        .sev-Low { background: #dcfce7; color: #166534; font-weight:700; padding:3px 6px; border-radius:3px; display:inline-block; font-size:0.75rem; }
        .sev-Medium { background: #fef9c3; color: #854d0e; font-weight:700; padding:3px 6px; border-radius:3px; display:inline-block; font-size:0.75rem; }
        .sev-High { background: #ffedd5; color: #9a3412; font-weight:700; padding:3px 6px; border-radius:3px; display:inline-block; font-size:0.75rem; }
        .sev-Critical { background: #fee2e2; color: #991b1b; font-weight:700; padding:3px 6px; border-radius:3px; display:inline-block; font-size:0.75rem; }
        .matrix-cell { padding: 8px; text-align: center; font-weight: 700; border: 1px solid #cbd5e1; }
        @media print { @page { size: landscape; margin: 0.5cm; } }
    </style>
</head>
<body>
    <!-- Site Information -->
    <div class="header">
        <div>
            <div style="font-size:0.9rem; color:#64748b; font-weight:600; margin-bottom:8px;">CROMPTON CONCEPTS</div>
            <h1>Risk Assessment</h1>
            <div style="margin-top:6px; color:#64748b;">${projectName} | ${location}</div>
            <div style="margin-top:4px; font-size:0.8rem; color:#64748b;">Doc Ref: ${docRef} | Reference Drawings: ${refDrawings}</div>
        </div>
        <div style="text-align:right;">Date: ${date}</div>
    </div>
    
    <h2 style="color:#2563eb; border-bottom:2px solid #e2e8f0; padding-bottom:8px; margin:0 0 20px 0; font-size:1.2rem;">Risk Assessment Table</h2>
    
    <!-- Rating Scales, Risk Levels, and Risk Matrix -->
    <div style="page-break-inside:avoid; margin-bottom:30px; display:grid; grid-template-columns: 1fr 1.2fr; gap:20px;">
        <!-- Left Column: Rating Scales and Risk Levels stacked -->
        <div style="display:flex; flex-direction:column; gap:16px;">
            <div style="padding:16px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px;">
                <h3 style="margin:0 0 12px 0; color:#2563eb; font-size:1rem;">Rating Scales</h3>
                <div style="font-size:0.75rem; line-height:1.6;">
                    <div style="margin-bottom:10px;">
                        <strong style="color:#1e293b;">Likelihood:</strong><br>
                        1=Rare, 2=Unlikely, 3=Possible, 4=Likely, 5=Almost Certain
                    </div>
                    <div>
                        <strong style="color:#1e293b;">Consequence:</strong><br>
                        1=Insignificant, 2=Minor, 3=Moderate, 4=Major, 5=Catastrophic
                    </div>
                    <div style="margin-top:10px; padding:8px; background:#eff6ff; border-left:3px solid #2563eb; font-size:0.75rem;">
                        <strong>Risk Rating = Likelihood × Consequence</strong>
                    </div>
                </div>
            </div>
            
            <div style="padding:16px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px;">
                <h3 style="margin:0 0 12px 0; color:#2563eb; font-size:1rem;">Risk Levels</h3>
                <div style="font-size:0.75rem; line-height:1.8;">
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                        <div style="width:20px; height:20px; background:#00b050; border:1px solid #cbd5e1;"></div>
                        <strong>Low (1-4):</strong> Monitor with routine procedures
                    </div>
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                        <div style="width:20px; height:20px; background:#ffe699; border:1px solid #cbd5e1;"></div>
                        <strong>Medium (5-9):</strong> Management responsibility required
                    </div>
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                        <div style="width:20px; height:20px; background:#f4b183; border:1px solid #cbd5e1;"></div>
                        <strong>High (10-15):</strong> Senior management attention
                    </div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <div style="width:20px; height:20px; background:#c00000; border:1px solid #cbd5e1;"></div>
                        <strong>Critical (16-25):</strong> Immediate action required
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Risk Matrix -->
        <div style="padding:16px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px;">
            <h3 style="margin:0 0 12px 0; color:#2563eb; font-size:1rem;">Risk Matrix</h3>
            <table style="border-collapse:collapse; width:100%;">
            <thead>
                <tr>
                    <th style="border:1px solid #cbd5e1; padding:8px; background:#f1f5f9; font-size:0.75rem; text-align:center; color:#1e293b;" rowspan="2">Likelihood</th>
                    <th style="border:1px solid #cbd5e1; padding:8px; background:#f1f5f9; font-size:0.75rem; text-align:center; color:#1e293b;" colspan="5">Consequence</th>
                </tr>
                <tr>
                    <th style="border:1px solid #cbd5e1; padding:8px; background:#f1f5f9; font-size:0.7rem; text-align:center; color:#1e293b;">1<br>Insignificant</th>
                    <th style="border:1px solid #cbd5e1; padding:8px; background:#f1f5f9; font-size:0.7rem; text-align:center; color:#1e293b;">2<br>Minor</th>
                    <th style="border:1px solid #cbd5e1; padding:8px; background:#f1f5f9; font-size:0.7rem; text-align:center; color:#1e293b;">3<br>Moderate</th>
                    <th style="border:1px solid #cbd5e1; padding:8px; background:#f1f5f9; font-size:0.7rem; text-align:center; color:#1e293b;">4<br>Major</th>
                    <th style="border:1px solid #cbd5e1; padding:8px; background:#f1f5f9; font-size:0.7rem; text-align:center; color:#1e293b;">5<br>Catastrophic</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="border:1px solid #cbd5e1; padding:8px; background:#f1f5f9; font-size:0.7rem; text-align:center; font-weight:600;">5<br>Almost Certain</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#ffe699; text-align:center; font-weight:700; font-size:0.9rem;">5</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#f4b183; text-align:center; font-weight:700; font-size:0.9rem;">10</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#f4b183; text-align:center; font-weight:700; font-size:0.9rem;">15</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#c00000; text-align:center; font-weight:700; font-size:0.9rem; color:#ffffff;">20</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#c00000; text-align:center; font-weight:700; font-size:0.9rem; color:#ffffff;">25</td>
                </tr>
                <tr>
                    <td style="border:1px solid #cbd5e1; padding:8px; background:#f1f5f9; font-size:0.7rem; text-align:center; font-weight:600;">4<br>Likely</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#00b050; text-align:center; font-weight:700; font-size:0.9rem; color:#ffffff;">4</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#ffe699; text-align:center; font-weight:700; font-size:0.9rem;">8</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#f4b183; text-align:center; font-weight:700; font-size:0.9rem;">12</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#c00000; text-align:center; font-weight:700; font-size:0.9rem; color:#ffffff;">16</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#c00000; text-align:center; font-weight:700; font-size:0.9rem; color:#ffffff;">20</td>
                </tr>
                <tr>
                    <td style="border:1px solid #cbd5e1; padding:8px; background:#f1f5f9; font-size:0.7rem; text-align:center; font-weight:600;">3<br>Possible</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#00b050; text-align:center; font-weight:700; font-size:0.9rem; color:#ffffff;">3</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#ffe699; text-align:center; font-weight:700; font-size:0.9rem;">6</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#ffe699; text-align:center; font-weight:700; font-size:0.9rem;">9</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#f4b183; text-align:center; font-weight:700; font-size:0.9rem;">12</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#f4b183; text-align:center; font-weight:700; font-size:0.9rem;">15</td>
                </tr>
                <tr>
                    <td style="border:1px solid #cbd5e1; padding:8px; background:#f1f5f9; font-size:0.7rem; text-align:center; font-weight:600;">2<br>Unlikely</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#00b050; text-align:center; font-weight:700; font-size:0.9rem; color:#ffffff;">2</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#00b050; text-align:center; font-weight:700; font-size:0.9rem; color:#ffffff;">4</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#ffe699; text-align:center; font-weight:700; font-size:0.9rem;">6</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#ffe699; text-align:center; font-weight:700; font-size:0.9rem;">8</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#f4b183; text-align:center; font-weight:700; font-size:0.9rem;">10</td>
                </tr>
                <tr>
                    <td style="border:1px solid #cbd5e1; padding:8px; background:#f1f5f9; font-size:0.7rem; text-align:center; font-weight:600;">1<br>Rare</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#00b050; text-align:center; font-weight:700; font-size:0.9rem; color:#ffffff;">1</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#00b050; text-align:center; font-weight:700; font-size:0.9rem; color:#ffffff;">2</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#00b050; text-align:center; font-weight:700; font-size:0.9rem; color:#ffffff;">3</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#00b050; text-align:center; font-weight:700; font-size:0.9rem; color:#ffffff;">4</td>
                    <td style="border:1px solid #cbd5e1; padding:12px; background:#ffe699; text-align:center; font-weight:700; font-size:0.9rem;">5</td>
                </tr>
            </tbody>
        </table>
        </div>
    </div>
    
    <!-- Risk Register Table -->
    <div style="page-break-before:always;"></div>
    <h2 style="color:#2563eb; border-bottom:2px solid #e2e8f0; padding-bottom:8px; margin:0 0 20px 0; font-size:1.2rem;">Risk Regsiter</h2>
    <table>
        <thead>
            <tr>
                <th style="width: 3%;">S.N.</th>
                <th style="width: 11%;">Hazard / Risk</th>
                <th style="width: 11%;">Impact</th>
                <th style="width: 6%;">L</th>
                <th style="width: 6%;">C</th>
                <th style="width: 7%;">Initial Risk</th>
                <th style="width: 24%;">Controls</th>
                <th style="width: 6%;">L</th>
                <th style="width: 6%;">C</th>
                <th style="width: 7%;">Residual Risk</th>
                <th style="width: 13%;">Risk Owner</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    rows.forEach((row, index) => {
        const sn = index + 1;
        const textareas = row.querySelectorAll('textarea');
        const selects = row.querySelectorAll('select');
        const inputs = row.querySelectorAll('input[type="text"]');
        const checkboxes = row.querySelectorAll('input[type="checkbox"]');
        
        const hazard = textareas[0]?.value || '-';
        const impact = textareas[1]?.value || '-';
        const owner = inputs[0]?.value || '-';
        
        // Extract controls from checkboxes and textareas
        const controlTypes = ['Elimination', 'Substitution', 'Engineering', 'Administrative', 'PPE'];
        let controlsList = [];
        checkboxes.forEach((cb, idx) => {
            if (cb.checked) {
                const desc = cb.parentElement.querySelector('textarea')?.value || '';
                if (desc.trim()) {
                    controlsList.push(`<strong>${controlTypes[idx]}:</strong> ${desc}`);
                }
            }
        });
        const controls = controlsList.length > 0 ? controlsList.join('<br>') : '-';
        
        const initLikelihood = selects[0]?.value || '';
        const initConsequence = selects[1]?.value || '';
        const initialRisk = selects[2]?.value || '';
        const resLikelihood = selects[3]?.value || '';
        const resConsequence = selects[4]?.value || '';
        const residualRisk = selects[5]?.value || '';
        
        // Convert newlines to <br>
        const format = (txt) => txt.replace(/\n/g, '<br>');

        reportHTML += `
            <tr>
                <td style="text-align:center; font-weight:700;">${sn}</td>
                <td><strong>${format(hazard)}</strong></td>
                <td>${format(impact)}</td>
                <td style="text-align:center; font-size:0.7rem;">${initLikelihood ? likelihoodLabels[initLikelihood] : '-'}</td>
                <td style="text-align:center; font-size:0.7rem;">${initConsequence ? consequenceLabels[initConsequence] : '-'}</td>
                <td style="text-align:center;">${initialRisk ? `<span class="sev-${initialRisk}">${initialRisk}</span>` : '-'}</td>
                <td>${controls}</td>
                <td style="text-align:center; font-size:0.7rem;">${resLikelihood ? likelihoodLabels[resLikelihood] : '-'}</td>
                <td style="text-align:center; font-size:0.7rem;">${resConsequence ? consequenceLabels[resConsequence] : '-'}</td>
                <td style="text-align:center;">${residualRisk ? `<span class="sev-${residualRisk}">${residualRisk}</span>` : '-'}</td>
                <td>${format(owner)}</td>
            </tr>
        `;
    });
    
    reportHTML += `
        </tbody>
    </table>
    
    <!-- Risk Assessment Notes -->
    <div style="margin-top:30px; padding:20px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; page-break-inside:avoid;">
        <h3 style="margin:0 0 12px 0; color:#2563eb; font-size:1rem;">Risk Assessment Notes</h3>
      ${riskNotes.length > 0 ? `
          <ol style="margin:0; padding-left:20px; color:#475569; font-size:0.85rem; line-height:1.8;">
            ${riskNotes.filter(n => n.text.trim()).map(note => `<li>${note.text.replace(/\n/g, '<br>')}</li>`).join('')}
          </ol>
      ` : '<div style="color:#475569; font-size:0.85rem;">No additional notes provided.</div>'}
    </div>
    
    <!-- Risk Summary (Tabular Format) -->
    <div style="margin-top:30px; page-break-inside:avoid;">
        <h3 style="margin:0 0 16px 0; color:#2563eb; font-size:1rem;">Risk Summary</h3>
        <table style="width:100%; border-collapse:collapse; margin-bottom:16px; font-size:0.85rem;">
            <thead>
                <tr style="background:#f1f5f9;">
                    <th style="border:1px solid #cbd5e1; padding:10px; text-align:left;">Metric</th>
                    <th style="border:1px solid #cbd5e1; padding:10px; text-align:center;">Initial</th>
                    <th style="border:1px solid #cbd5e1; padding:10px; text-align:center;">Residual</th>
                    <th style="border:1px solid #cbd5e1; padding:10px; text-align:center;">Change</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="border:1px solid #cbd5e1; padding:10px; font-weight:600;">Total Risks</td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center;">${totalRisks}</td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center;">${totalRisks}</td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center;">-</td>
                </tr>
                <tr>
                    <td style="border:1px solid #cbd5e1; padding:10px; font-weight:600;">Average Risk Score</td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center;">${avgInitial}</td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center;">${avgResidual}</td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center; color:#10b981; font-weight:600;">▼ ${improvement}%</td>
                </tr>
                <tr style="background:#f8fafc;">
                    <td style="border:1px solid #cbd5e1; padding:10px; font-weight:600;">Overall Risk Level</td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center;">
                        <span style="padding:4px 8px; background:${overallInitial.color}20; color:${overallInitial.color}; border-radius:4px; font-weight:600;">${overallInitial.level}</span>
                    </td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center;">
                        <span style="padding:4px 8px; background:${overallResidual.color}20; color:${overallResidual.color}; border-radius:4px; font-weight:600;">${overallResidual.level}</span>
                    </td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center;">-</td>
                </tr>
            </tbody>
        </table>
        
        <table style="width:100%; border-collapse:collapse; font-size:0.85rem;">
            <thead>
                <tr style="background:#f1f5f9;">
                    <th style="border:1px solid #cbd5e1; padding:10px; text-align:left;">Risk Category</th>
                    <th style="border:1px solid #cbd5e1; padding:10px; text-align:center;">Initial Count</th>
                    <th style="border:1px solid #cbd5e1; padding:10px; text-align:center;">Residual Count</th>
                    <th style="border:1px solid #cbd5e1; padding:10px; text-align:center;">Improvement</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="border:1px solid #cbd5e1; padding:10px; display:flex; align-items:center; gap:8px;">
                        <div style="width:16px; height:16px; background:#fee2e2; border:1px solid #cbd5e1;"></div>
                        <strong>Critical (16-25)</strong>
                    </td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center; color:#991b1b; font-weight:600;">${initialCounts.Critical}</td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center; color:#991b1b; font-weight:600;">${residualCounts.Critical}</td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center; color:#10b981; font-weight:600;">${initialCounts.Critical > residualCounts.Critical ? '▼ ' + (initialCounts.Critical - residualCounts.Critical) : (residualCounts.Critical > initialCounts.Critical ? '▲ ' + (residualCounts.Critical - initialCounts.Critical) : '-')}</td>
                </tr>
                <tr>
                    <td style="border:1px solid #cbd5e1; padding:10px; display:flex; align-items:center; gap:8px;">
                        <div style="width:16px; height:16px; background:#ffedd5; border:1px solid #cbd5e1;"></div>
                        <strong>High (10-15)</strong>
                    </td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center; color:#9a3412; font-weight:600;">${initialCounts.High}</td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center; color:#9a3412; font-weight:600;">${residualCounts.High}</td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center; color:#10b981; font-weight:600;">${initialCounts.High > residualCounts.High ? '▼ ' + (initialCounts.High - residualCounts.High) : (residualCounts.High > initialCounts.High ? '▲ ' + (residualCounts.High - initialCounts.High) : '-')}</td>
                </tr>
                <tr>
                    <td style="border:1px solid #cbd5e1; padding:10px; display:flex; align-items:center; gap:8px;">
                        <div style="width:16px; height:16px; background:#fef9c3; border:1px solid #cbd5e1;"></div>
                        <strong>Medium (5-9)</strong>
                    </td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center; color:#854d0e; font-weight:600;">${initialCounts.Medium}</td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center; color:#854d0e; font-weight:600;">${residualCounts.Medium}</td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center; font-weight:600;">${initialCounts.Medium > residualCounts.Medium ? '▼ ' + (initialCounts.Medium - residualCounts.Medium) : (residualCounts.Medium > initialCounts.Medium ? '▲ ' + (residualCounts.Medium - initialCounts.Medium) : '-')}</td>
                </tr>
                <tr>
                    <td style="border:1px solid #cbd5e1; padding:10px; display:flex; align-items:center; gap:8px;">
                        <div style="width:16px; height:16px; background:#dcfce7; border:1px solid #cbd5e1;"></div>
                        <strong>Low (1-4)</strong>
                    </td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center; color:#065f46; font-weight:600;">${initialCounts.Low}</td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center; color:#065f46; font-weight:600;">${residualCounts.Low}</td>
                    <td style="border:1px solid #cbd5e1; padding:10px; text-align:center; font-weight:600;">${initialCounts.Low > residualCounts.Low ? '▼ ' + (initialCounts.Low - residualCounts.Low) : (residualCounts.Low > initialCounts.Low ? '▲ ' + (residualCounts.Low - initialCounts.Low) : '-')}</td>
                </tr>
            </tbody>
        </table>
        
        ${residualCounts.Critical > 0 || residualCounts.High > 0 ? `
        <div style="padding:12px; background:#fef3c7; border-left:4px solid #f59e0b; border-radius:4px; margin-top:16px;">
            <strong style="color:#92400e;">⚠️ Action Required:</strong>
            <span style="color:#92400e; font-size:0.85rem;">
                ${residualCounts.Critical > 0 ? `${residualCounts.Critical} Critical risk(s) require immediate attention. ` : ''}
                ${residualCounts.High > 0 ? `${residualCounts.High} High risk(s) need management review.` : ''}
            </span>
        </div>
        ` : ''}
    </div>
    
    <!-- Sign-off -->
    <div style="margin-top:30px; padding:20px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; page-break-inside:avoid;">
        <h3 style="margin:0 0 16px 0; color:#2563eb; font-size:1rem;">Sign-off</h3>
        <table style="width:100%; border:none; font-size:0.85rem;">
            <tr>
                <td style="border:none; padding:8px 0;"><strong>Prepared by:</strong></td>
                <td style="border:none; padding:8px 0; border-bottom:1px solid #cbd5e1; width:50%;">${document.getElementById('preparedBy')?.value || '_____________________'}</td>
                <td style="border:none; padding:8px 0 8px 20px;"><strong>Date:</strong></td>
                <td style="border:none; padding:8px 0; border-bottom:1px solid #cbd5e1; width:20%;">${document.getElementById('preparedDate')?.value || '_____'}</td>
            </tr>
            <tr>
                <td style="border:none; padding:8px 0;"><strong>Reviewed by:</strong></td>
                <td style="border:none; padding:8px 0; border-bottom:1px solid #cbd5e1;">${document.getElementById('reviewedBy')?.value || '_____________________'}</td>
                <td style="border:none; padding:8px 0 8px 20px;"><strong>Date:</strong></td>
                <td style="border:none; padding:8px 0; border-bottom:1px solid #cbd5e1;">${document.getElementById('reviewedDate')?.value || '_____'}</td>
            </tr>
            <tr>
                <td style="border:none; padding:8px 0;"><strong>Approved by:</strong></td>
                <td style="border:none; padding:8px 0; border-bottom:1px solid #cbd5e1;">${document.getElementById('approvedBy')?.value || '_____________________'}</td>
                <td style="border:none; padding:8px 0 8px 20px;"><strong>Date:</strong></td>
                <td style="border:none; padding:8px 0; border-bottom:1px solid #cbd5e1;">${document.getElementById('approvedDate')?.value || '_____'}</td>
            </tr>
        </table>
    </div>
</body>
</html>
    `;
    
    const w = window.open('', '_blank');
    w.document.write(reportHTML);
    w.document.close();
    setTimeout(() => w.print(), 500);
}

// Risk Assessment Notes Management
let riskNotes = [];
let riskNoteCounter = 0;

function addRiskNote(noteText = '') {
    riskNoteCounter++;
    const noteId = `note_${riskNoteCounter}`;
    
    const note = {
        id: noteId,
        number: riskNotes.length + 1,
        text: noteText
    };
    
    riskNotes.push(note);
    renderRiskNotes();
}

function deleteRiskNote(noteId) {
    riskNotes = riskNotes.filter(n => n.id !== noteId);
    // Renumber the notes
    riskNotes.forEach((note, index) => {
        note.number = index + 1;
    });
    renderRiskNotes();
    saveRiskNotes();
}

function updateRiskNoteText(noteId, text) {
    const note = riskNotes.find(n => n.id === noteId);
    if (note) {
        note.text = text;
        saveRiskNotes();
    }
}

function renderRiskNotes() {
    const container = document.getElementById('riskNotesContainer');
    if (!container) return;
    
    if (riskNotes.length === 0) {
        container.innerHTML = '<p style="color:var(--text-sub); font-style:italic; font-size:0.9rem;">No notes added yet. Click "Add Note" to add your first note.</p>';
        return;
    }
    
    container.innerHTML = riskNotes.map(note => `
        <div style="display:flex; gap:12px; margin-bottom:12px; align-items:flex-start; background:var(--bg-body); padding:12px; border-radius:6px; border:1px solid var(--border-color);">
            <div style="background:var(--primary); color:white; width:32px; height:32px; min-width:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:0.9rem;">
                ${note.number}
            </div>
            <textarea 
                id="${note.id}" 
                placeholder="Enter note details..."
                style="flex:1; padding:10px; border:1px solid var(--border-color); border-radius:4px; min-height:60px; resize:vertical; font-family:inherit; font-size:0.95rem;"
                oninput="updateRiskNoteText('${note.id}', this.value)"
            >${note.text}</textarea>
            <button 
                onclick="deleteRiskNote('${note.id}')" 
                class="btn-link" 
                style="color:#ef4444; font-size:1.3rem; padding:4px 8px; min-width:auto;" 
                title="Delete note">
                ×
            </button>
        </div>
    `).join('');
}

function getRiskNotesForReport() {
    return riskNotes.filter(n => n.text.trim() !== '');
}

function saveRiskNotes() {
    try {
        localStorage.setItem('riskAssessmentNotes', JSON.stringify({
            notes: riskNotes,
            counter: riskNoteCounter
        }));
    } catch (e) {
        console.error('Error saving risk notes:', e);
    }
}

function loadRiskNotes() {
    try {
        const saved = localStorage.getItem('riskAssessmentNotes');
        if (saved) {
            const data = JSON.parse(saved);
            riskNotes = data.notes || [];
            riskNoteCounter = data.counter || 0;
            renderRiskNotes();
        }
    } catch (e) {
        console.error('Error loading risk notes:', e);
    }
}

// Proceed to barrier selection
function proceedToBarrierSelection() {
    saveRiskNotes(); // Save notes before proceeding
  showOnlyStage('stage2');
    document.getElementById('resetBtn').style.display = 'inline-flex';
}


// INIT
function init() {
  initRiskAssessment();
  loadRiskNotes(); // Load saved notes on init
  loadFavorites();
  loadRecents();
  initializeFilterButtons();
  filterBarriers();
  loadSavedScenarios();
  const stageDesignSpeedField = document.getElementById('siteSpeed');
  if (stageDesignSpeedField) {
    stageDesignSpeedField.addEventListener('input', syncDesignSpeedFromStage);
    stageDesignSpeedField.addEventListener('change', syncDesignSpeedFromStage);
  }
  const stageWidthField = document.getElementById('siteWidth');
  if (stageWidthField) {
    stageWidthField.addEventListener('input', () => renderMatrixLegend(lastCalcInputs));
    stageWidthField.addEventListener('change', () => renderMatrixLegend(lastCalcInputs));
  }
  const layoutWidthField = document.getElementById('layoutWidthAvail');
  if (layoutWidthField) {
    layoutWidthField.addEventListener('input', renderWidthVisual);
    layoutWidthField.addEventListener('change', renderWidthVisual);
  }

  // Default Dates to Today
  const today = new Date().toISOString().split('T')[0];
  const d1 = document.getElementById('sigDate1');
  const d2 = document.getElementById('sigDate2');
  if(d1 && !d1.value) d1.value = today;
  if(d2 && !d2.value) d2.value = today;

  checkUrlParams();
  renderMatrixLegend(null);
}

function deriveRequiredTL(speed) {
  if (!speed || isNaN(speed)) return 0;
  if (speed <= 70) return 2;
  if (speed <= 100) return 3;
  return 4;
}

function extractBarrierTLLevel(barrier) {
  if (!barrier || !barrier.tl) return 0;
  const match = barrier.tl.match(/TL-?\s*(\d)/i);
  return match ? parseInt(match[1], 10) : 0;
}

function updateTLNote(hasWidth) {
  const noteEl = document.getElementById('autoTLNote');
  if (!noteEl) return;
  if (!hasWidth) {
    noteEl.textContent = 'All items shown. Enter available width, then choose "Search" to refine the list.';
    return;
  }
  noteEl.textContent = 'Filtering by available width.';
}

function switchStage1Tab(type) {
  currentStage1Tab = type;
  
  // Update Buttons
  document.getElementById('tabBarriers').classList.toggle('active', type === 'barrier');
  document.getElementById('tabTerminals').classList.toggle('active', type === 'terminal');
  
  // Reset search
  filterBarriers();
  renderQuickPicks();
}

function showAllBarriers() {
  document.getElementById('siteSpeed').value = '';
  document.getElementById('siteWidth').value = '';
  document.getElementById('barrierNameSearch').value = '';
  clearActiveFilters();
  filterBarriers();
}

// Track active filters
let activeFilters = {
  mash: [],
  material: [],
  category: [],
  features: [],
  supplier: [],
  deflMax: null,
  wwMax: null,
  favorites: false
};

function toggleFavFilter() {
    activeFilters.favorites = !activeFilters.favorites;
    const btn = document.getElementById('btnShowFavs');
    if (btn) {
        if (activeFilters.favorites) {
            btn.classList.add('active');
            btn.style.background = '#FEF3C7'; // Light yellow
            btn.style.borderColor = '#F59E0B';
            btn.style.color = '#B45309';
        } else {
            btn.classList.remove('active');
            btn.style.background = 'white';
            btn.style.borderColor = '#e2e8f0';
            btn.style.color = '#1e293b';
        }
    }
    filterBarriers();
}

function extractMaterials(barrierName) {
  const materials = [];
  const nameLower = barrierName.toLowerCase();
  if (nameLower.includes('steel')) materials.push('Steel');
  if (nameLower.includes('concrete')) materials.push('Concrete');
  if (nameLower.includes('plastic')) materials.push('Plastic');
  if (nameLower.includes('water')) materials.push('Water-Filled');
  if (nameLower.includes('cable')) materials.push('Cable');
  if (nameLower.includes('hybrid')) materials.push('Hybrid');
  return materials.length > 0 ? materials : ['Other'];
}

function extractCategories(barrierName) {
  const categories = [];
  const nameLower = barrierName.toLowerCase();
  if (nameLower.includes('precast') || nameLower.includes('concrete barrier')) categories.push('Precast');
  if (nameLower.includes('safety barrier') || nameLower.includes('rail')) categories.push('Rail Barrier');
  if (nameLower.includes('crash cushion') || nameLower.includes('terminal')) categories.push('Terminal');
  if (nameLower.includes('water filled')) categories.push('Water System');
  if (nameLower.includes('guardrail')) categories.push('Guardrail');
  return categories.length > 0 ? categories : [];
}

function extractFeatures(barrier) {
  const features = [];
  const nameLower = barrier.name.toLowerCase();
  if (nameLower.includes('mds')) features.push('Minimal Deflection');
  if (nameLower.includes('lds')) features.push('Low Deflection');
  if (barrier.isMatrix) features.push('Matrix Barrier');
  if (nameLower.includes('redirective')) features.push('Redirective');
  if (nameLower.includes('gating')) features.push('Gating');
  return features;
}

function initializeFilterButtons() {
  // Extract unique values
  const allMash = new Set();
  const allMaterials = new Set();
  const allCategories = new Set();
  const allFeatures = new Set();
  const allSuppliers = new Set();

  barriers.forEach(b => {
    if (b.type === 'barrier') {
      const tl = extractBarrierTLLevel(b);
      if (tl > 0) allMash.add(`TL-${tl}`);
      extractMaterials(b.name).forEach(m => allMaterials.add(m));
      extractCategories(b.name).forEach(c => allCategories.add(c));
      extractFeatures(b).forEach(f => allFeatures.add(f));
      allSuppliers.add(b.supplier);
    }
  });

  END_TREATMENTS.forEach(et => {
    if (et.supplier) allSuppliers.add(et.supplier);
  });

  // Sort and render as Select Options
  renderSelectOptions('mashFilters', Array.from(allMash).sort());
  renderSelectOptions('materialFilters', Array.from(allMaterials).sort());
  renderSelectOptions('categoryFilters', Array.from(allCategories).sort());
  renderSelectOptions('featureFilters', Array.from(allFeatures).sort());
  renderSelectOptions('supplierFilters', Array.from(allSuppliers).sort());
}

function renderSelectOptions(selectId, items) {
  const select = document.getElementById(selectId);
  if (!select) return;
  
  // Keep the first "All" option
  const firstOption = select.options[0];
  select.innerHTML = '';
  select.appendChild(firstOption);

  items.forEach(item => {
    const opt = document.createElement('option');
    opt.value = item;
    opt.textContent = item;
    select.appendChild(opt);
  });
}

function updateFilterFromSelect(filterType, selectEl) {
    const val = selectEl.value;
    if (val === "") {
        activeFilters[filterType] = [];
    } else {
        activeFilters[filterType] = [val];
    }
    filterBarriers();
}

function updateNumericFilter(key, value) {
  const num = parseFloat(value);
  activeFilters[key] = isNaN(num) ? null : num;
  filterBarriers();
}

function clearAllFilters() {
  activeFilters = {
    mash: [],
    material: [],
    category: [],
    features: [],
    supplier: [],
    deflMax: null,
    wwMax: null,
    favorites: false // preserve or reset? user said "Clear All"
  };
  
  // Reset Selects
  ['mashFilters', 'materialFilters', 'categoryFilters', 'featureFilters'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.selectedIndex = 0;
  });
  const supplierSelect = document.getElementById('supplierFilters');
  if (supplierSelect) supplierSelect.selectedIndex = 0;

  const deflMaxInput = document.getElementById('deflMaxFilter');
  const wwMaxInput = document.getElementById('wwMaxFilter');
  if (deflMaxInput) deflMaxInput.value = '';
  if (wwMaxInput) wwMaxInput.value = '';

  // Reset Favourites toggle if needed
  if(document.getElementById('btnShowFavs')) {
       // Optional: Decide if "Clear All" clears favorites mode. 
       // Usually "Clear Filters" implies data filters. 
       // Favorites is a mode. I will leave favorites alone here or reset it depending on UX.
       // Current implementation of clearAllFilters reset EVERYTHING including favs flag.
       // But let's check older code.
       // I'll keep it simple and just reset data filters.
       // If I want to clear favorites too:
       activeFilters.favorites = false;
       const btn = document.getElementById('btnShowFavs');
       if(btn) {
            btn.classList.remove('active');
            btn.style.background = 'white';
            btn.style.borderColor = '#e2e8f0';
            btn.style.color = '#1e293b';
       }
  }

  // Clear inputs
  const sSpeed = document.getElementById('siteSpeed');
  const sWidth = document.getElementById('siteWidth');
  const sName = document.getElementById('barrierNameSearch');
  if(sSpeed) sSpeed.value = "";
  if(sWidth) sWidth.value = "";
  if(sName) sName.value = "";
  
  filterBarriers();
}

function filterBarriers() {
  try {
    const widthField = document.getElementById('siteWidth');
    const nameField = document.getElementById('barrierNameSearch');
    
    const widthValueRaw = widthField ? widthField.value : '';
    const nameSearch = nameField ? nameField.value.toLowerCase().trim() : '';

    const hasWidth = widthValueRaw !== '' && !isNaN(parseFloat(widthValueRaw));
    const filtersActive = hasWidth;

    const siteWidth = hasWidth ? parseFloat(widthValueRaw) : null;
    updateTLNote(hasWidth);

    const widthLimit = siteWidth;
    
    // Decide source array
    const sourceArray = currentStage1Tab === 'terminal' ? END_TREATMENTS : barriers;

  // Filter
  const filtered = sourceArray.filter(b => {
    if (currentStage1Tab === 'barrier') {
        if (b.type !== 'barrier') return false;
    } 
    
    // Name Filter
    if (nameSearch !== '') {
        const matchName = b.name.toLowerCase().includes(nameSearch);
        const matchSupplier = b.supplier.toLowerCase().includes(nameSearch);
        if (!matchName && !matchSupplier) return false;
    }

    // MASH Filter
    if (activeFilters.mash.length > 0) {
      const barrierTL = extractBarrierTLLevel(b);
      const barrierMash = `TL-${barrierTL}`;
      if (!activeFilters.mash.includes(barrierMash)) return false;
    }

    // Material Filter
    if (activeFilters.material.length > 0) {
      const barrierMaterials = extractMaterials(b.name);
      const hasMatchingMaterial = activeFilters.material.some(m => barrierMaterials.includes(m));
      if (!hasMatchingMaterial) return false;
    }

    // Category Filter
    if (activeFilters.category.length > 0) {
      const barrierCategories = extractCategories(b.name);
      const hasMatchingCategory = activeFilters.category.some(c => barrierCategories.includes(c));
      if (!hasMatchingCategory) return false;
    }

    // Features Filter
    if (activeFilters.features.length > 0) {
      const barrierFeatures = extractFeatures(b);
      const hasMatchingFeature = activeFilters.features.some(f => barrierFeatures.includes(f));
      if (!hasMatchingFeature) return false;
    }

    // Supplier Filter
    if (activeFilters.supplier.length > 0) {
      const supplierName = (b.supplier || '').trim();
      const matchesSupplier = activeFilters.supplier.includes(supplierName);
      if (!matchesSupplier) return false;
    }

    // Deflection / Working Width Filters
    if (activeFilters.deflMax !== null) {
      const deflVal = typeof b.defl === 'number' ? b.defl : parseFloat(b.defl);
      if (!Number.isFinite(deflVal) || deflVal > activeFilters.deflMax) return false;
    }

    if (activeFilters.wwMax !== null) {
      const wwVal = typeof b.ww === 'number' ? b.ww : parseFloat(b.ww);
      if (!Number.isFinite(wwVal) || wwVal > activeFilters.wwMax) return false;
    }
    
    // Favorites Filter
    if (activeFilters.favorites) {
        if (!favoriteBarriers.includes(b.id)) return false;
    }

    if (filtersActive) {
        if (widthLimit !== null) {
          const barrierWidth = Number.isFinite(b.width) ? b.width : (parseFloat(b.width) || 0);
          const barrierDefl = Number.isFinite(b.defl) ? b.defl : (parseFloat(b.defl) || 0);
          const totalWidth = barrierWidth + barrierDefl;
          if (totalWidth > widthLimit) return false;
        }
    }
    return true;
  });

  const gridEl = document.getElementById('barrierGrid');
  if (!gridEl) {
    console.error('barrierGrid element not found');
    return;
  }
  
  gridEl.innerHTML = filtered.map(b => {
      const isChecked = compareSelections.includes(b.id);
      const isFav = favoriteBarriers.includes(b.id);
      const tlText = (b.tl || 'N/A').toString();
      const deflVal = Number.isFinite(b.defl) ? b.defl : (parseFloat(b.defl) || null);
      const wwVal = Number.isFinite(b.ww) ? b.ww : (parseFloat(b.ww) || null);
      const hasTest = Number.isFinite(b.testSpeed) && b.testSpeed > 0;
        
      // Determine Badge Color
      let badgeClass = 'badge-tl3'; // default
      if (tlText.includes('TL-2')) badgeClass = 'badge-tl2';
      else if (tlText.includes('TL-4')) badgeClass = 'badge-tl4';
      else if (tlText.includes('TL-5')) badgeClass = 'badge-tl5';
        
      return `
      <div class="barrier-card" onclick="selectBarrier(${b.id}, '${currentStage1Tab}')">
            
        <div class="card-actions">
          <span class="badge ${badgeClass}">${tlText}</span>
          <span class="fav-btn ${isFav ? 'active' : ''}" 
              onclick="event.stopPropagation(); toggleFavorite(${b.id})" 
              title="${isFav ? 'Remove from Favorites' : 'Add to Favorites'}">
            ★
          </span>
        </div>

        <div style="display:flex; align-items:flex-start; gap:16px; margin-bottom:12px;">
          ${b.image ? `<img src="${b.image}" alt="${b.name}" style="width:72px; height:72px; object-fit:contain; flex-shrink:0; border-radius:6px; background:#f8fafc; padding:4px; border:1px solid #e2e8f0;">` : `<div class="thumb-placeholder">No media</div>`}
          <div style="flex:1;">
            <div class="barrier-title">${b.name}</div>
            <div class="barrier-supplier">${b.supplier || ''}</div>
          </div>
        </div>

        <div class="stat-group">
          ${hasTest ? `
          <div class="stat-box">
            <span class="stat-label">Test Speed</span>
            <span class="stat-val">${b.testSpeed} km/h</span>
          </div>
          <div class="stat-box">
            <span class="stat-label">Deflection</span>
            <span class="stat-val">${deflVal !== null ? deflVal : '-'} m</span>
          </div>
          <div class="stat-box">
            <span class="stat-label">Working Width</span>
            <span class="stat-val">${wwVal !== null ? wwVal : '-'} m</span>
          </div>` : '<div class="stat-box" style="justify-content:center; color:#cbd5e1; font-style:italic;">No test data available</div>'}
        </div>

        <div style="margin-top:12px; display:flex; justify-content:flex-end;">
           <label class="compare-checkbox" onclick="event.stopPropagation()">
             <input type="checkbox" id="chk_${b.id}" ${isChecked ? 'checked' : ''} onchange="toggleCompare(${b.id})">
             Compare
           </label>
        </div>
      </div>
    `}).join('');

    renderQuickPicks();
  } catch (error) {
    console.error('Error in filterBarriers:', error);
    const gridEl = document.getElementById('barrierGrid');
    if (gridEl) {
      gridEl.innerHTML = '<div style="padding:40px; text-align:center; color:#dc2626;">Error loading barriers. Please refresh the page.</div>';
    }
  }
}

function selectBarrier(id, type) {
  if (currentUserRole === 'external') {
    alert('External users can only view barrier and end-treatment lists.');
    return;
  }

    if (type === 'terminal') {
        selectedBarrier = END_TREATMENTS.find(b => b.id === id);
        if (selectedBarrier) selectedBarrier.isTerminal = true;
    } else {
        selectedBarrier = barriers.find(b => b.id === id);
        if (selectedBarrier) selectedBarrier.isTerminal = false;
    }

  // Track recents
  touchRecent(id, type);
    
    const isTerminal = selectedBarrier ? selectedBarrier.isTerminal : false;
    
    showOnlyStage('stage3');
    document.getElementById('resetBtn').style.display = 'block';
    
    // Toggle Calc UI elements
    const calcSection = document.getElementById('calcInputSection');
    const resPanel = document.getElementById('resultsPanel');
    const termDetails = document.getElementById('terminalDetailsDisplay');

    if(calcSection) calcSection.style.display = isTerminal ? 'none' : 'block';
    if(resPanel) resPanel.style.display = isTerminal ? 'none' : 'block';
    if(termDetails) {
        termDetails.style.display = isTerminal ? 'block' : 'none';
        if (isTerminal) {
             document.getElementById('termFullType').value = selectedBarrier.fullType || selectedBarrier.type || '-';
             document.getElementById('termTL').value = selectedBarrier.tl || '-';
             document.getElementById('termSpeed').value = selectedBarrier.testSpeed + ' km/h';
             document.getElementById('termDefl').value = selectedBarrier.defl + ' m';
             document.getElementById('termWW').value = selectedBarrier.ww + ' m';
             document.getElementById('termWidth').value = selectedBarrier.width + ' m';
             document.getElementById('termLen').value = selectedBarrier.testLen + ' m';
        }
    }
    
    // Show Next Button
    const nextBtn = document.getElementById('toStage3Btn');
    if (nextBtn) nextBtn.style.display = isTerminal ? 'none' : 'inline-block';

    // Populate Sidebar
    document.getElementById('barrierNameDisplay').innerText = selectedBarrier.name;
    document.getElementById('supplierDisplay').innerText = selectedBarrier.supplier;
    document.getElementById('valTestLength').value = selectedBarrier.testLen;
    const systemWidthField = document.getElementById('valSystemWidth');
    if (systemWidthField) systemWidthField.value = Number.isFinite(selectedBarrier.width) ? selectedBarrier.width.toFixed(3) : (selectedBarrier.width || '-');
    const widthAllowanceField = document.getElementById('valWidthAllowance');
    const baseWidthAllowance = Number.isFinite(selectedBarrier.width) && Number.isFinite(selectedBarrier.defl)
      ? (selectedBarrier.width + selectedBarrier.defl)
      : null;
    if (widthAllowanceField) widthAllowanceField.value = baseWidthAllowance !== null ? baseWidthAllowance.toFixed(3) : '-';
    const rawTestSpeed = selectedBarrier.testSpeed;
    const numericTestSpeed = Number.isFinite(rawTestSpeed) ? rawTestSpeed : parseFloat(rawTestSpeed);
    const testSpeedField = document.getElementById('inSpeed');
    if (testSpeedField) {
      testSpeedField.value = Number.isFinite(numericTestSpeed) ? numericTestSpeed : '';
    }
    const designSpeedField = document.getElementById('designSpeedInput');
    if (designSpeedField) {
      designSpeedField.removeAttribute('data-user-edited');
      const stageSpeedValue = document.getElementById('siteSpeed').value;
      if (stageSpeedValue !== '') {
        designSpeedField.value = stageSpeedValue;
      } else if (Number.isFinite(numericTestSpeed) && numericTestSpeed > 0) {
        designSpeedField.value = numericTestSpeed;
      } else {
        designSpeedField.value = '';
      }
    }

    // Layout optimizer defaults
    const layoutTargetInput = document.getElementById('layoutTargetLength');
    const layoutRunInput = document.getElementById('layoutRunLength');
    const layoutWidthInput = document.getElementById('layoutWidthAvail');
    const designLenField = document.getElementById('inDesignLength');
    if (layoutTargetInput && designLenField) layoutTargetInput.value = designLenField.value || selectedBarrier.testLen || '';
    if (layoutRunInput) layoutRunInput.value = '';
    if (layoutWidthInput) {
      const stageWidthField = document.getElementById('siteWidth');
      layoutWidthInput.value = stageWidthField && stageWidthField.value !== '' ? stageWidthField.value : '';
    }

    // --- Update Unit Specs Inputs ---
    const lenContainer = document.getElementById('containerUnitLength');
    const wtContainer = document.getElementById('containerUnitWeight');
    
    if (lenContainer) {
        if (selectedBarrier.availableLengths && selectedBarrier.availableLengths.length > 1) {
            let opts = selectedBarrier.availableLengths.map(l => `<option value="${l}">${l}</option>`).join('');
            lenContainer.innerHTML = `<label>Length (m)</label><select id="inUnitLength" onchange="updateLinkedSpecs('length')">${opts}</select>`;
        } else {
             // Default if single value or no value
            let val = (selectedBarrier.availableLengths && selectedBarrier.availableLengths.length === 1 && selectedBarrier.availableLengths[0] > 0) 
                      ? selectedBarrier.availableLengths[0] 
                      : 6;
            lenContainer.innerHTML = `<label>Length (m)</label><input type="number" id="inUnitLength" value="${val}" oninput="markCalcDirty()">`;
        }
    }
    
    if (wtContainer) {
         if (selectedBarrier.unitWeight && selectedBarrier.unitWeight.length > 1) {
            let opts = selectedBarrier.unitWeight.map(w => {
                const t = w / 1000; 
                return `<option value="${t}">${w} kg (${t}T)</option>`;
            }).join('');
             wtContainer.innerHTML = `<label>Wt (Tonnes)</label><select id="inUnitWeightT" onchange="updateLinkedSpecs('weight')">${opts}</select>`;
         } else {
            let val = (selectedBarrier.unitWeight && selectedBarrier.unitWeight.length === 1 && selectedBarrier.unitWeight[0] > 0) 
                      ? (selectedBarrier.unitWeight[0] / 1000)
                      : 0.6;
             wtContainer.innerHTML = `<label>Wt (Tonnes)</label><input type="number" id="inUnitWeightT" value="${val}" step="0.1" oninput="markCalcDirty()">`;
         }
    }
    
    // UPDATE: Image Search Link
    const imgBtn = document.getElementById('imgSearchLink');
    const extraSearchBox = document.getElementById('extraImageSearch');
    const extraSearchLink = document.getElementById('extraSearchLink');

    if (imgBtn) {
        console.log('selectedBarrier:', selectedBarrier.name, 'has image:', selectedBarrier.image ? 'YES' : 'NO');
        
        // Prepare search query
        const queryText = selectedBarrier.supplier + " " + selectedBarrier.name + " safety barrier";
        const query = encodeURIComponent(queryText);
        const searchUrl = `https://www.google.com/search?tbm=isch&q=${query}`;
        
        if (extraSearchLink) extraSearchLink.href = searchUrl;

        if (selectedBarrier.image) {
             imgBtn.href = selectedBarrier.image;
             imgBtn.title = "View Full Image";
             imgBtn.target = "_blank";
             imgBtn.style.display = 'flex';
             imgBtn.style.flexDirection = 'column';
             imgBtn.style.alignItems = 'center';
             imgBtn.style.justifyContent = 'center';
             imgBtn.style.padding = '12px';
             imgBtn.style.border = '1px solid var(--border-color)';
             imgBtn.style.backgroundColor = '#f8fafc';
             
             // Create image element with error handling
             const img = new Image();
             img.onload = function() {
                 console.log('Image loaded successfully:', selectedBarrier.name);
                 imgBtn.innerHTML = `<img src="${selectedBarrier.image}" alt="${selectedBarrier.name}" style="width:100%; height:auto; max-height:300px; object-fit:contain; border-radius:6px; display:block;">`;
             };
             img.onerror = function() {
                 console.error('Image failed to load:', selectedBarrier.image);
                 imgBtn.innerHTML = `<div style="text-align:center; color:#ef4444;"><div style="font-size:2rem; margin-bottom:8px;">⚠️</div><div>Image failed to load</div><div style="font-size:0.75rem; color:#64748b; margin-top:4px;">URL: ${selectedBarrier.image}</div></div>`;
             };
             img.src = selectedBarrier.image;

             // Show "Search Google" link below image
             if(extraSearchBox) extraSearchBox.style.display = 'block';
        } else {
            // Restore styling for search mode
            imgBtn.style.padding = '24px'; 
            imgBtn.style.border = '2px dashed var(--border-color)';
            imgBtn.style.backgroundColor = 'transparent';
            imgBtn.style.display = 'flex';
            imgBtn.style.flexDirection = 'column';
            imgBtn.style.alignItems = 'center';

            imgBtn.href = searchUrl;
            imgBtn.title = "Search Google Images";
            imgBtn.innerHTML = `
                <div class="image-icon">📷</div>
                <div class="image-text">Find Images</div>
                <div style="font-size:0.7rem; color:#64748b; margin-top:4px; text-align:center;">
                    Search: <span id="searchQueryDisplay">${selectedBarrier.supplier} ${selectedBarrier.name}</span>
                </div>
            `;
            
            // Hide "Search Google" link below as main box does it
            if(extraSearchBox) extraSearchBox.style.display = 'none';
        }
    }
    
    const linkBtn = document.getElementById('techSheetLink');
    const techFrame = document.getElementById('techSheetFrame');
    const techWrap = document.getElementById('techSheetPreview');
    const techEmpty = document.getElementById('techSheetEmpty');
    if(selectedBarrier.link && selectedBarrier.link !== '') {
      linkBtn.href = selectedBarrier.link;
      linkBtn.style.display = 'flex';

      // Render the inline preview before calculation runs
      if (techWrap && techFrame) {
        techWrap.style.display = 'block';
        techEmpty.style.display = 'none';
        techFrame.src = selectedBarrier.link;
      }
    } else {
      linkBtn.style.display = 'none';
      if (techWrap && techFrame) {
        techWrap.style.display = 'block';
        techEmpty.style.display = 'block';
        techFrame.src = '';
      }
    }

    const specBtn = document.getElementById('manuSpecLink');
    const sLink = selectedBarrier.specLink || selectedBarrier.manufLink;
    if(sLink && sLink !== '') {
      specBtn.href = sLink;
      specBtn.style.display = 'flex';
    } else {
      specBtn.style.display = 'none';
    }

    // Manufacturer Website Link
    const manuSiteBtn = document.getElementById('manuWebsiteLink');
    const manuSite = resolveManufacturerSite(selectedBarrier);
    if (manuSite) {
        manuSiteBtn.href = manuSite;
        manuSiteBtn.style.display = 'flex';
    } else {
        manuSiteBtn.style.display = 'none';
    }

    const linkHealth = document.getElementById('linkHealthNote');
    if (linkHealth) {
      const hasTech = !!selectedBarrier.link;
      const hasSpec = !!(selectedBarrier.specLink || selectedBarrier.manufLink);
      const siteUrl = resolveManufacturerSite(selectedBarrier);
      if (hasTech || hasSpec || siteUrl) {
        const parts = [];
        if (hasTech) parts.push('Austroads tech link');
        if (hasSpec) parts.push('Manufacturer spec');
        if (siteUrl) parts.push('Website');
        linkHealth.textContent = `Links available: ${parts.join(' · ')}`;
        linkHealth.classList.add('ok');
        linkHealth.style.display = 'block';
      } else {
        linkHealth.textContent = 'No tech or manufacturer links provided for this item.';
        linkHealth.classList.remove('ok');
        linkHealth.style.display = 'block';
      }
    }

    // UPDATE: Installation Video Link
    const videoBtn = document.getElementById('installVideoLink');
    if (videoBtn) {
        // Construct a YouTube search query combining Supplier + Name + "installation"
        const vidQuery = encodeURIComponent(selectedBarrier.supplier + " " + selectedBarrier.name + " installation process");
        videoBtn.href = `https://www.youtube.com/results?search_query=${vidQuery}`;
        // Always show the button as it is a search link
        videoBtn.style.display = 'flex';
    }

    calcDirty = false;
    lastCalcInputs = null;
    clearCalcDirty();

    const scenarioToApply = pendingScenarioLoad && pendingScenarioLoad.barrierId === selectedBarrier.id
      ? pendingScenarioLoad
      : null;
    pendingScenarioLoad = null;
    if (scenarioToApply) {
      applyScenarioInputs(scenarioToApply);
    }

    if (!isTerminal) {
       runFullCalc();
    }
    renderValidationHints();
}

function markCalcDirty() {
  if (!selectedBarrier) return;
  calcDirty = true;
  const btn = document.getElementById('applyCalcBtn');
  if (btn) btn.style.display = 'block';

  const energyField = document.getElementById('outEnergy');
  if (energyField) energyField.value = 'Update required';

  const kgField = document.getElementById('outUnitWeightKg');
  if (kgField) kgField.value = 'Update required';

  const pendingText = 'Update required';
  ['resBaseDefl', 'resBaseWW', 'resUnits', 'resDesignDefl', 'resDesignWW'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = pendingText;
  });
}

function reloadTechSheetPreview() {
  if (!selectedBarrier) return;
  const techFrame = document.getElementById('techSheetFrame');
  const techEmpty = document.getElementById('techSheetEmpty');
  if (selectedBarrier.link && techFrame) {
    techFrame.src = selectedBarrier.link;
    if (techEmpty) techEmpty.style.display = 'none';
  } else if (techEmpty) {
    techEmpty.style.display = 'block';
  }
}

function openTechSheetFullscreen() {
  if (!selectedBarrier) return;
  const techFrame = document.getElementById('techSheetFrame');
  const link = selectedBarrier.link;
  if (techFrame && techFrame.requestFullscreen) {
    techFrame.requestFullscreen().catch(() => {
      if (link) window.open(link, '_blank');
    });
  } else if (link) {
    window.open(link, '_blank');
  }
}

function updateLinkedSpecs(source) {
    if (!selectedBarrier) return;
    
    // Check if we have parallel arrays
    const lens = selectedBarrier.availableLengths;
    const wts = selectedBarrier.unitWeight;
    
    if (lens && wts && lens.length > 1 && wts.length > 1 && lens.length === wts.length) {
        const lenEl = document.getElementById('inUnitLength');
        const wtEl = document.getElementById('inUnitWeightT');
        
        if (source === 'length' && lenEl) {
             const selectedLen = parseFloat(lenEl.value);
             const idx = lens.indexOf(selectedLen);
             if (idx !== -1 && wtEl) {
                 const targetWtT = wts[idx] / 1000;
                 wtEl.value = targetWtT;
                 // Visual feedback for select element
                 if(wtEl.tagName === 'SELECT') {
                      // Ensure value exists in options (it should)
                 }
             }
        } else if (source === 'weight' && wtEl) {
             const selectedWtT = parseFloat(wtEl.value);
             // Find matching weight in kg (fuzzy match for float precision?)
             // Or better, match index by value
             const targetWtKg = selectedWtT * 1000;
             // Allow small tolerance? Or exact match since generated from data?
             // Since values are generated as exact divisions or from data, let's try exact first.
             // Best to find index in constructed options or original array
             const idx = wts.findIndex(w => Math.abs((w/1000) - selectedWtT) < 0.001);
             
             if (idx !== -1 && lenEl) {
                 lenEl.value = lens[idx];
             }
        }
    }
    runFullCalc();
}

function applyCalcUpdates() {
  if (!selectedBarrier) return;
  runFullCalc();
}

function clearCalcDirty() {
  calcDirty = false;
  const btn = document.getElementById('applyCalcBtn');
  if (btn) btn.style.display = 'none';
}

function switchTab(tab) {
    currentTab = tab;
    // Update Button States
    const btns = document.querySelectorAll('.tab-nav .tab-btn');
    btns.forEach(b => b.classList.remove('active'));
    if(tab === 'deflection') btns[0].classList.add('active');
    else btns[1].classList.add('active');

  if (calcDirty) {
    if (lastCalcInputs) renderMatrixTables(lastCalcInputs);
  } else {
    runFullCalc();
  }
}

function syncDesignSpeedFromStage() {
  if (!selectedBarrier) return;
  const designSpeedField = document.getElementById('designSpeedInput');
  const stageSpeedField = document.getElementById('siteSpeed');
  if (!designSpeedField || !stageSpeedField) return;
  if (designSpeedField.getAttribute('data-user-edited') === 'true') return;

  const stageValue = stageSpeedField.value;
  if (stageValue === '') {
    designSpeedField.value = '';
    designSpeedField.removeAttribute('data-user-edited');
  } else {
    designSpeedField.value = stageValue;
  }
  runFullCalc();
}

function onDesignSpeedInput() {
  if (!selectedBarrier) return;
  const designSpeedField = document.getElementById('designSpeedInput');
  if (designSpeedField) {
    if (designSpeedField.value === '') {
      designSpeedField.removeAttribute('data-user-edited');
    } else {
      designSpeedField.setAttribute('data-user-edited', 'true');
    }
  }
  runFullCalc();
}

function renderValidationHints() {
  const box = document.getElementById('validationHints');
  if (!box) return;

  const hints = [];

  // Width check against Stage 2 value (barrier selection)
  const siteWidthField = document.getElementById('siteWidth');
  const siteWidthVal = siteWidthField && siteWidthField.value !== '' ? parseFloat(siteWidthField.value) : null;
  const designWW = lastScenarioSnapshot?.summary?.designWorkingWidth;
  if (siteWidthVal !== null && Number.isFinite(designWW)) {
    if (designWW > siteWidthVal) {
      hints.push({
        tone: 'warn',
        text: `Design working width ${designWW.toFixed(3)} m exceeds available width ${siteWidthVal.toFixed(3)} m.`
      });
    } else {
      hints.push({
        tone: 'ok',
        text: `Width check OK: ${designWW.toFixed(3)} m ≤ ${siteWidthVal.toFixed(3)} m.`
      });
    }
  } else {
    hints.push({ tone: 'info', text: 'Set available width to get a width pass/fail check.' });
  }

  // End treatment speed/type checks
  if (selectedEndTreatment) {
    const etSpeed = selectedEndTreatment.testSpeed;
    const stageSpeed = siteWidthField && document.getElementById('siteSpeed')?.value !== ''
      ? parseFloat(document.getElementById('siteSpeed').value)
      : null;
    if (stageSpeed !== null && Number.isFinite(etSpeed)) {
      if (stageSpeed > etSpeed) {
        hints.push({
          tone: 'warn',
          text: `End treatment test speed ${etSpeed} km/h is below site speed ${stageSpeed} km/h.`
        });
      } else {
        hints.push({ tone: 'ok', text: `End treatment speed OK (${etSpeed} km/h meets site ${stageSpeed} km/h).` });
      }
    } else if (Number.isFinite(etSpeed)) {
      hints.push({ tone: 'info', text: `End treatment tested to ${etSpeed} km/h. Set site speed to validate.` });
    }

    const etType = (selectedEndTreatment.fullType || selectedEndTreatment.type || '').toLowerCase();
    if (etType.includes('gating')) {
      hints.push({ tone: 'info', text: 'Selected end treatment is gating; ensure sufficient clear zone beyond terminal.' });
    } else if (etType.includes('redirective')) {
      hints.push({ tone: 'ok', text: 'End treatment is redirective.' });
    }
  } else {
    hints.push({ tone: 'info', text: 'Select an end treatment to check type and speed suitability.' });
  }

  const pills = hints.map(h => {
    const color = h.tone === 'warn' ? '#b45309' : h.tone === 'ok' ? '#15803d' : '#334155';
    return `<div style="display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px; background:${h.tone === 'warn' ? '#fef3c7' : h.tone === 'ok' ? '#ecfdf3' : '#f8fafc'}; color:${color}; border:1px solid ${h.tone === 'warn' ? '#fcd34d' : h.tone === 'ok' ? '#bbf7d0' : '#e2e8f0'};">${h.text}</div>`;
  }).join('');

  box.innerHTML = pills || 'No validation hints available yet.';
}

function computeLayoutPlan(targetLength, lengths) {
  const usable = lengths
    .map(v => parseFloat(v))
    .filter(v => Number.isFinite(v) && v > 0)
    .sort((a, b) => b - a);

  if (!usable.length) return { error: 'No unit lengths available for this barrier.' };
  if (!Number.isFinite(targetLength) || targetLength <= 0) return { error: 'Enter a valid target length.' };

  const mix = [];
  let total = 0;
  let guard = 0;
  while (total + 1e-6 < targetLength && guard < 500) {
    const remaining = targetLength - total;
    let pick = usable.find(v => v <= remaining + 1e-6);
    if (!pick) pick = usable[usable.length - 1];
    mix.push(pick);
    total += pick;
    guard++;
  }
  const overrun = total - targetLength;
  return { mix, total, overrun };
}

function renderLayoutSummary() {
  const summaryEl = document.getElementById('layoutSummary');
  if (!summaryEl) return;

  if (!selectedBarrier || selectedBarrier.isTerminal) {
    summaryEl.textContent = 'Select a longitudinal barrier to optimize layout.';
    return;
  }

  const targetInput = document.getElementById('layoutTargetLength');
  const designLenField = document.getElementById('inDesignLength');
  const targetRaw = targetInput && targetInput.value !== '' ? parseFloat(targetInput.value) : (designLenField ? parseFloat(designLenField.value) : NaN);
  const targetLen = Number.isFinite(targetRaw) && targetRaw > 0 ? targetRaw : null;

  const lengths = (selectedBarrier.availableLengths || []).filter(v => Number.isFinite(v) && v > 0);
  const fallbackLenField = document.getElementById('inUnitLength');
  if (!lengths.length && fallbackLenField) {
    const fb = parseFloat(fallbackLenField.value);
    if (Number.isFinite(fb) && fb > 0) lengths.push(fb);
  }

  if (!targetLen || !lengths.length) {
    summaryEl.textContent = 'Enter a target length and ensure unit lengths are defined.';
    return;
  }

  const plan = computeLayoutPlan(targetLen, lengths);
  if (plan.error) {
    summaryEl.textContent = plan.error;
    return;
  }

  const counts = plan.mix.reduce((acc, len) => {
    const key = len.toFixed(2);
    acc[key] = (acc[key] || 0) + 1;
    return acc;
  }, {});
  const mixText = Object.keys(counts)
    .sort((a, b) => parseFloat(b) - parseFloat(a))
    .map(len => `${counts[len]} × ${parseFloat(len).toFixed(2)} m`)
    .join(' + ');

  const overrunText = plan.overrun >= 0
    ? `${plan.overrun.toFixed(2)} m over target`
    : `${(-plan.overrun).toFixed(2)} m short`;

  const runInput = document.getElementById('layoutRunLength');
  const runValRaw = runInput && runInput.value !== '' ? parseFloat(runInput.value) : NaN;
  let runStatus = 'Corridor length not provided.';
  if (Number.isFinite(runValRaw)) {
    runStatus = plan.total <= runValRaw
      ? `Fits in available corridor (${plan.total.toFixed(2)} ≤ ${runValRaw.toFixed(2)} m)`
      : `Needs ${(plan.total - runValRaw).toFixed(2)} m more corridor`;
  }

  const widthInput = document.getElementById('layoutWidthAvail');
  const widthOverride = widthInput && widthInput.value !== '' ? parseFloat(widthInput.value) : NaN;
  const stageWidthField = document.getElementById('siteWidth');
  const stageWidth = stageWidthField && stageWidthField.value !== '' ? parseFloat(stageWidthField.value) : NaN;
  const widthLimit = Number.isFinite(widthOverride) ? widthOverride : (Number.isFinite(stageWidth) ? stageWidth : null);
  const widthUse = lastScenarioSnapshot?.summary?.designWorkingWidth;
  let widthStatus = 'Width limit not set.';
  if (widthLimit !== null && Number.isFinite(widthUse)) {
    widthStatus = widthUse <= widthLimit
      ? `Width OK (${widthUse.toFixed(3)} m ≤ ${widthLimit.toFixed(3)} m)`
      : `Width exceeds by ${(widthUse - widthLimit).toFixed(3)} m`;
  }

  summaryEl.innerHTML = `
    <div><strong>Mix:</strong> ${mixText}</div>
    <div><strong>Total length:</strong> ${plan.total.toFixed(2)} m (${overrunText})</div>
    <div><strong>Units:</strong> ${plan.mix.length}</div>
    <div><strong>Corridor fit:</strong> ${runStatus}</div>
    <div><strong>Width check:</strong> ${widthStatus}</div>
  `;

  renderWidthVisual();
}

function runFullCalc() {
  if (!selectedBarrier) return;

  const mass = parseFloat(document.getElementById('inMass').value) || 0;
  const testSpeedField = document.getElementById('inSpeed');
  const rawTestSpeed = testSpeedField ? parseFloat(testSpeedField.value) : NaN;
  const designSpeedField = document.getElementById('designSpeedInput');
  const rawDesignSpeed = designSpeedField ? parseFloat(designSpeedField.value) : NaN;
  const hasTestSpeed = Number.isFinite(rawTestSpeed) && rawTestSpeed > 0;
  const hasDesignSpeed = Number.isFinite(rawDesignSpeed) && rawDesignSpeed > 0;
  const effectiveTestSpeed = hasTestSpeed
    ? rawTestSpeed
    : (hasDesignSpeed ? rawDesignSpeed : 0);
  const designSpeed = hasDesignSpeed ? rawDesignSpeed : effectiveTestSpeed;
  const angle = parseFloat(document.getElementById('inAngle').value) || 0;
  const designLenInput = parseFloat(document.getElementById('inDesignLength').value);
  const designLen = !isNaN(designLenInput) && designLenInput > 0 ? designLenInput : selectedBarrier.testLen;
  const unitWtT = parseFloat(document.getElementById('inUnitWeightT').value) || 0;
  const friction = parseFloat(document.getElementById('inFriction').value) || 0;
  const unitLength = parseFloat(document.getElementById('inUnitLength').value) || 0;
  const unitWtKg = unitWtT * 1000;
  document.getElementById('outUnitWeightKg').value = unitWtKg ? unitWtKg.toFixed(0) : '0';

  const energyTestKJ = calculateEnergy(mass, effectiveTestSpeed, angle);
  document.getElementById('outEnergy').value = energyTestKJ.toFixed(2);
  const energyDesignKJ = calculateEnergy(mass, designSpeed, angle);

  const refEnergy = calculateEnergy(2270, selectedBarrier.testSpeed, 25);

  const rawWidth = selectedBarrier.width;
  const parsedWidth = Number.isFinite(rawWidth) ? rawWidth : parseFloat(rawWidth);
  const hasBarrierWidth = Number.isFinite(parsedWidth);
  const barrierWidth = hasBarrierWidth ? parsedWidth : 0;

  let baseDeflTest = 0;
  let baseDeflDesign = 0;
  if (selectedBarrier.isMatrix) {
    baseDeflTest = interpolateHG(effectiveTestSpeed, angle);
    baseDeflDesign = interpolateHG(designSpeed, angle);
  } else if (refEnergy > 0) {
    baseDeflTest = selectedBarrier.defl * (energyTestKJ / refEnergy);
    baseDeflDesign = selectedBarrier.defl * (energyDesignKJ / refEnergy);
  }

  if (!isFinite(baseDeflDesign) || baseDeflDesign <= 0) {
    baseDeflDesign = baseDeflTest;
  }

  const safeBaseDeflTest = isFinite(baseDeflTest) ? baseDeflTest : 0;
  document.getElementById('resBaseDefl').innerText = safeBaseDeflTest.toFixed(3) + ' m';

  const baseWW = safeBaseDeflTest + barrierWidth;
  document.getElementById('resBaseWW').innerText = Number.isFinite(baseWW) ? baseWW.toFixed(3) + ' m' : '-';

  const systemWidthField = document.getElementById('valSystemWidth');
  if (systemWidthField) {
    systemWidthField.value = hasBarrierWidth ? barrierWidth.toFixed(3) : '-';
  }

  const widthAllowanceField = document.getElementById('valWidthAllowance');
  if (widthAllowanceField) {
    if (hasBarrierWidth && Number.isFinite(baseWW)) {
      widthAllowanceField.value = baseWW.toFixed(3);
    } else {
      widthAllowanceField.value = '-';
    }
  }

  const dLen = designLen > 0 ? designLen : 1;
  const safeDesignBase = isFinite(baseDeflDesign) ? baseDeflDesign : safeBaseDeflTest;
  const correctedDesignDefl = safeDesignBase * (selectedBarrier.testLen / dLen);
  const safeDesignDefl = isFinite(correctedDesignDefl) ? correctedDesignDefl : safeDesignBase;
  const designWW = safeDesignDefl + barrierWidth;

  document.getElementById('resDesignDefl').innerText = safeDesignDefl.toFixed(3) + ' m';
  document.getElementById('resDesignWW').innerText = Number.isFinite(designWW) ? designWW.toFixed(3) + ' m' : '-';

  const frictionForce = friction * unitWtKg * 9.81;
  let unitsDisp = 0;
  if (safeBaseDeflTest > 0 && frictionForce > 0) {
    // Formula per Excel approach: kJ / Joules directly (no 1000x conversion) + 2
    // Uses Standard/Base Deflection (before length scaling)
    unitsDisp = Math.ceil((energyTestKJ / (safeBaseDeflTest * frictionForce)) + 2);
  }
  document.getElementById('resUnits').innerText = unitsDisp;

  // Capture simple total length = barrier design length + end treatments (no buffer)
  const etLenForTotal = ['designLen', 'designLength', 'len', 'length', 'testLen', 'overallLength', 'overallLen', 'lengthMeters', 'lengthMetres']
    .map(k => selectedEndTreatment?.[k])
    .find(v => Number.isFinite(v) && v > 0) || 0;
  const etCountForTotal = endTreatmentEndsMode === 'both' ? 2 : 1;
  const totalLen = dLen + (Number.isFinite(etLenForTotal) ? etLenForTotal * etCountForTotal : 0);

  lastCalcInputs = {
    mass,
    designSpeed,
    speed: designSpeed,
    testSpeed: effectiveTestSpeed,
    angle,
    designLen: dLen,
    unitWtKg,
    friction,
    totalLen
  };
  renderMatrixTables(lastCalcInputs);

  const siteSpeedVal = parseFloat(document.getElementById('siteSpeed').value) || 0;
  const siteWidthValRaw = parseFloat(document.getElementById('siteWidth').value);
  const siteWidthVal = isNaN(siteWidthValRaw) ? null : siteWidthValRaw;
  lastScenarioSnapshot = {
    barrierId: selectedBarrier.id,
    barrierName: selectedBarrier.name,
    supplier: selectedBarrier.supplier,
    siteSpeed: siteSpeedVal,
    siteWidth: siteWidthVal,
    mass,
    designSpeed,
    speed: designSpeed,
    testSpeed: effectiveTestSpeed,
    angle,
    designLen: dLen,
    totalLen,
    friction,
    unitLength,
    unitWeightT: unitWtT,
    summary: {
      energy: energyTestKJ,
      baseDeflection: safeBaseDeflTest,
      baseWorkingWidth: baseWW,
      units: unitsDisp,
      designDeflection: safeDesignDefl,
      designWorkingWidth: designWW
    }
  };

  renderLayoutSummary();
  renderValidationHints();
  clearCalcDirty();
  renderWidthVisual();
}

function buildMatrixHTML(inputs, tab, includeTitle = false) {
  if (!selectedBarrier || !inputs) return '';

  const widthField = document.getElementById('siteWidth');
  const widthRaw = widthField ? widthField.value : '';
  const availWidth = widthRaw === '' ? null : parseFloat(widthRaw);
  const speeds = MATRIX_SPEEDS;
  const angles = MATRIX_ANGLES;
  
  // Update refEnergy to use INPUT MASS/ANGLE to match 'test1.html' logic (Formula V3)
  // This ensures that Deflection remains tied to the Test Deflection input regardless of Mass change,
  // matching the legacy Excel behavior where Slope = TestDefl / CalcEnergy(InputMass).
  const refEnergy = calculateEnergy(inputs.mass, selectedBarrier.testSpeed, inputs.angle);
  
  const highlightSpeed = Number.isFinite(inputs.designSpeed) ? inputs.designSpeed : inputs.speed;
  const highlightAngle = Number.isFinite(inputs.angle) ? inputs.angle : null;

  const headerCols = tab === 'deflection'
    ? '<th title="Impact speed used for row energy">Speed (km/h)</th><th title="Impact energy at this speed/angle">EU (kJ)</th><th title="Base test deflection scaled by energy">Deflection (m)</th><th title="Estimated units displaced">Est. Units</th><th title="Energy scaled to design length">Req. Energy (kJ)</th><th title="Deflection using Req. Energy">Est. Deflection (m)</th>'
    : '<th title="Impact speed used for row energy">Speed (km/h)</th><th title="Impact energy at this speed/angle">Energy (kJ)</th><th title="Barrier width + base deflection">Base WW (m)</th><th title="Barrier width + design deflection">Design WW (m)</th>';

  let html = '';
  if (includeTitle) {
    const titleText = tab === 'deflection' ? 'Deflection Table' : 'Working Width Table';
    html += `<h3 class="matrix-section-title">${titleText}</h3>`;
  }

  html += '<div class="matrix-grid-wrapper">';

  angles.forEach(angle => {
    let blockHtml = `
    <div class="angle-block">
      <div class="angle-header" title="Rows below use this impact angle">
        <span>Impact Angle: ${angle}°</span>
      </div>
      <table class="matrix-table">
        <thead><tr>${headerCols}</tr></thead>
        <tbody>
    `;

    speeds.forEach(speed => {
      // C15: EU (Row Energy)
      const energy = calculateEnergy(inputs.mass, speed, angle);

      let baseDefl = 0;
      if (selectedBarrier.isMatrix) {
        baseDefl = interpolateHG(speed, angle);
      } else if (refEnergy > 0) {
        // C7 = selectedBarrier.defl
        // C9 = refEnergy (Now using Input Mass/Angle)
        // Deflection = C15 * C7 / C9
        baseDefl = selectedBarrier.defl * (energy / refEnergy);
      }
      const safeBase = isFinite(baseDefl) ? baseDefl : 0;

      const frictionForce = inputs.friction * inputs.unitWtKg * 9.81;
      let units = 0;
      // Units Displaced: C15 / (D15 * FrictionForce)
      // Note: "Pseudo Energy" (kJ) divided by "Real Work" (J). 
      // Do NOT multiply C15 by 1000 per user formula matching Excel V3.
      if (safeBase > 0 && frictionForce > 0) {
        units = Math.ceil((energy / (safeBase * frictionForce)) + 2);
      }

      const designLen = inputs.designLen > 0 ? inputs.designLen : 1;
      
      // Req Energy (F15) = C15 * P5 / P6 (Energy * TestLen / DesignLen)
      const reqEnergy = energy * (selectedBarrier.testLen / designLen);
      
      // Est Deflection = F15 * C7 / C9
      // = ReqEnergy * (TestDefl / RefEnergy)
      let designDefl = 0;
      if (selectedBarrier.isMatrix) {
         // Fallback for matrix barriers (scale linearly)
         designDefl = safeBase * (selectedBarrier.testLen / designLen);
      } else if (refEnergy > 0) {
         designDefl = reqEnergy * (selectedBarrier.defl / refEnergy);
      }
      
      const safeDesign = isFinite(designDefl) ? designDefl : 0;

      const baseWW = safeBase + selectedBarrier.width;
      const designWW = safeDesign + selectedBarrier.width;

      const isFail = Number.isFinite(availWidth) ? designWW > availWidth : false;
      const isHighlight =
        highlightSpeed !== null && Number.isFinite(highlightSpeed) &&
        Math.abs(speed - highlightSpeed) < 0.51 &&
        (highlightAngle === null || Math.abs(angle - highlightAngle) < 0.51);
      const rowClasses = [];
      if (isHighlight) rowClasses.push('row-highlight');
      if (isFail) rowClasses.push('row-fail');
      const rowClass = rowClasses.join(' ');
      const failClass = isFail ? 'val-fail' : 'val-pass';

      if (tab === 'deflection') {
        blockHtml += `
          <tr class="${rowClass}">
            <td>${speed}</td>
            <td>${energy.toFixed(1)}</td>
            <td>${safeBase.toFixed(3)}</td>
            <td>${units}</td>
            <td>${reqEnergy.toFixed(1)}</td>
            <td class="${failClass}">${safeDesign.toFixed(3)}</td>
          </tr>
        `;
      } else {
        blockHtml += `
          <tr class="${rowClass}">
            <td>${speed}</td>
            <td>${energy.toFixed(1)}</td>
            <td>${baseWW.toFixed(3)}</td>
            <td class="${failClass}">${designWW.toFixed(3)}</td>
          </tr>
        `;
      }
    });

    blockHtml += `</tbody></table></div>`;
    html += blockHtml;
  });

  html += '</div>';

  return html;
}

function renderMatrixTables(inputs) {
  const liveContainer = document.getElementById('matrixContainer');
  const printContainer = document.getElementById('printMatrixContainer');

  if (!selectedBarrier || !inputs) {
    if (liveContainer) liveContainer.innerHTML = '';
    if (printContainer) printContainer.innerHTML = '';
    renderMatrixLegend(null);
    return;
  }

  if (liveContainer) {
    liveContainer.innerHTML = buildMatrixHTML(inputs, currentTab, false);
  }

  if (printContainer) {
    const defHtml = buildMatrixHTML(inputs, 'deflection', true);
    const wwHtml = buildMatrixHTML(inputs, 'ww', true);
    printContainer.innerHTML = defHtml + wwHtml;
  }

  renderMatrixLegend(inputs);
}

function renderMatrixLegend(inputs) {
  const widthEl = document.getElementById('matrixLegendWidth');
  if (widthEl) {
    const widthField = document.getElementById('siteWidth');
    const widthVal = widthField && widthField.value !== '' ? parseFloat(widthField.value) : null;
    widthEl.textContent = Number.isFinite(widthVal)
      ? `Fail threshold: ${widthVal.toFixed(2)} m available width`
      : 'Width limit not set; enter width to see failures';
  }

  renderDataHealth();
}

function renderDataHealth() {
  const summaryEl = document.getElementById('dataHealthSummary');
  if (!summaryEl) return;
  const missingBarrierMedia = barriers.filter(b => !b.image).length;
  const missingBarrierLinks = barriers.filter(b => !b.link && !b.manufLink && !b.specLink).length;
  const missingEtLinks = END_TREATMENTS.filter(et => !et.link && !et.manufLink).length;
  const savedCount = savedScenarios.length;
  const recentCount = recentSelections.length;

  summaryEl.innerHTML = [
    `<span class="status-pill ok">${barriers.length} barriers</span>`,
    `<span class="status-pill ok">${END_TREATMENTS.length} end treatments</span>`,
    `<span class="status-pill warn">${missingBarrierMedia} missing media</span>`,
    `<span class="status-pill warn">${missingBarrierLinks + missingEtLinks} missing tech links</span>`,
    `<span class="status-pill note">${savedCount} saved · ${recentCount} recent</span>`
  ].join(' ');
}

let lastWidthSketchSvg = null;
let lastWidthOverlaySvg = null;
let lastLongitudinalSvg = null;
let endTreatmentEndsMode = 'single';
let endTreatmentSingleSide = 'right';
let bufferLength = 0;

function getSketchWidthInputs() {
  const roadField = document.getElementById('totalRoadWidth');
  const vergeField = document.getElementById('totalVergeWidth');
  const remainingField = document.getElementById('remainingRoadWidth');
  const totalField = document.getElementById('totalConsiderationWidth');
  const workAreaField = document.getElementById('computedWorkArea');

  const roadRaw = roadField && roadField.value !== '' ? parseFloat(roadField.value) : NaN;
  const vergeRaw = vergeField && vergeField.value !== '' ? parseFloat(vergeField.value) : NaN;
  const remainingRaw = remainingField && remainingField.value !== '' ? parseFloat(remainingField.value) : NaN;

  const roadWidth = Number.isFinite(roadRaw) ? roadRaw : null;
  const vergeWidth = Number.isFinite(vergeRaw) ? vergeRaw : null;
  const remainingRoadWidth = Number.isFinite(remainingRaw) ? remainingRaw : null;
  const totalConsidered = Number.isFinite(roadWidth) && Number.isFinite(vergeWidth)
    ? roadWidth + vergeWidth
    : null;

  return {
    roadWidth,
    vergeWidth,
    remainingRoadWidth,
    totalConsidered,
    totalField,
    workAreaField
  };
}

function renderWidthVisual() {
  const container = document.getElementById('widthVisualBody');
  if (!container) return;

  if (!selectedBarrier) {
    container.innerHTML = 'Select a barrier to view widths.';
    return;
  }

  const barrierWidth = Number.isFinite(selectedBarrier.width) ? selectedBarrier.width : null;
  const etWidth = selectedEndTreatment && Number.isFinite(selectedEndTreatment.width) ? selectedEndTreatment.width : null;
  const designDefl = lastScenarioSnapshot?.summary?.designDeflection ?? null;
  const designWW = lastScenarioSnapshot?.summary?.designWorkingWidth ?? null;

  const siteWidthField = document.getElementById('siteWidth');
  const siteWidth = siteWidthField && siteWidthField.value !== '' ? parseFloat(siteWidthField.value) : null;
  const layoutWidthField = document.getElementById('layoutWidthAvail');
  const layoutWidth = layoutWidthField && layoutWidthField.value !== '' ? parseFloat(layoutWidthField.value) : null;
  const sketchInputs = getSketchWidthInputs();
  const totalConsidered = sketchInputs.totalConsidered;
  const availWidth = Number.isFinite(totalConsidered)
    ? totalConsidered
    : (Number.isFinite(layoutWidth) ? layoutWidth : (Number.isFinite(siteWidth) ? siteWidth : null));

  const clearanceM = 0.3;
  const workArea = Number.isFinite(totalConsidered) && Number.isFinite(designWW) && Number.isFinite(sketchInputs.remainingRoadWidth)
    ? totalConsidered - (designWW + clearanceM + sketchInputs.remainingRoadWidth)
    : null;

  if (sketchInputs.totalField) {
    sketchInputs.totalField.value = Number.isFinite(totalConsidered) ? totalConsidered.toFixed(3) : '';
  }
  if (sketchInputs.workAreaField) {
    sketchInputs.workAreaField.value = Number.isFinite(workArea) ? workArea.toFixed(3) : '';
  }

  const values = [barrierWidth, etWidth, designDefl, designWW, availWidth].filter(v => Number.isFinite(v) && v > 0);
  const maxVal = values.length ? Math.max(...values) : 1;
  const scale = (v) => `${Math.max(6, Math.min(100, (v / maxVal) * 100)).toFixed(1)}%`;

  const dimLine = (label, val, color) => {
    const hasVal = Number.isFinite(val) && val > 0;
    const widthPct = hasVal ? scale(val) : '6%';
    const barClasses = ['width-dim-bar'];
    if (!hasVal) barClasses.push('width-dim-placeholder');
    const barColor = hasVal ? color : '#e2e8f0';
    const textClass = hasVal ? 'width-dim-text' : 'width-dim-text muted';
    const textVal = hasVal ? `${val.toFixed(3)} m` : '-';

    return `
      <div class="width-dim-row">
        <div class="width-label">${label}</div>
        <div class="width-dim-track">
          <div class="width-dim-base"></div>
          <span class="width-dim-arrow start"></span>
          <span class="width-dim-arrow end"></span>
          <div class="${barClasses.join(' ')}" style="width:${widthPct}; background:${barColor};">
            <span class="width-dim-mark left"></span>
            <span class="width-dim-mark right"></span>
            <span class="${textClass}">${textVal}</span>
          </div>
        </div>
      </div>`;
  };

  container.innerHTML = [
    dimLine('Barrier width', barrierWidth, 'linear-gradient(90deg, #2563eb, #60a5fa)'),
    dimLine('End treatment width', etWidth, 'linear-gradient(90deg, #0ea5e9, #38bdf8)'),
    dimLine('Design deflection', designDefl, 'linear-gradient(90deg, #f59e0b, #fbbf24)'),
    dimLine('Design working width', designWW, 'linear-gradient(90deg, #10b981, #34d399)'),
    dimLine('Available width', availWidth, 'linear-gradient(90deg, #475569, #94a3b8)')
  ].join('');

  const legend = document.createElement('div');
  legend.className = 'width-legend';

  const remaining = Number.isFinite(availWidth) && Number.isFinite(designWW)
    ? availWidth - designWW
    : null;

  const remainingPill = Number.isFinite(remaining)
    ? `<span class="width-pill ${remaining >= 0 ? 'ok' : 'warn'}">Remaining: ${remaining.toFixed(3)} m</span>`
    : `<span class="width-pill">Remaining: n/a</span>`;

  legend.innerHTML = [
    `<span class="width-pill">Max scale: ${maxVal.toFixed(3)} m</span>`,
    `<span class="width-pill">Source: Stage 3 calc + sketch widths</span>`,
    remainingPill
  ].join(' ');

  container.appendChild(legend);

  renderWidthSketch(barrierWidth, etWidth, designDefl, designWW, availWidth, maxVal);
  renderWidthOverlay(barrierWidth, etWidth, designDefl, designWW, availWidth, maxVal);
  renderLongitudinalView();
}

function renderWidthSketch(barrierWidth, etWidth, designDefl, designWW, availWidth, maxValFromVisual) {
  const holder = document.getElementById('widthSketch');
  const downloadBtn = document.getElementById('widthSketchDownload');
  if (!holder) return;

  const hasCalc = Number.isFinite(designWW) && Number.isFinite(designDefl);
  if (!selectedBarrier || !hasCalc) {
    holder.innerHTML = 'Run Stage 3 calculation and select an end treatment to view the sketch.';
    if (downloadBtn) downloadBtn.disabled = true;
    lastWidthSketchSvg = null;
    return;
  }

  const safeBarrier = Number.isFinite(barrierWidth) && barrierWidth > 0 ? barrierWidth : 0;
  const safeDefl = Number.isFinite(designDefl) && designDefl > 0 ? designDefl : 0;
  const safeWW = Number.isFinite(designWW) && designWW > 0 ? designWW : 0;
  const safeEt = Number.isFinite(etWidth) && etWidth > 0 ? etWidth : null;
  const clearanceM = 0.3;
  const sketchInputs = getSketchWidthInputs();
  const totalRoadWidth = sketchInputs.roadWidth;
  const totalVergeWidth = sketchInputs.vergeWidth;
  const remainingRoadWidth = sketchInputs.remainingRoadWidth;
  const totalConsidered = sketchInputs.totalConsidered;

  if (!Number.isFinite(totalRoadWidth) || !Number.isFinite(totalVergeWidth) || !Number.isFinite(remainingRoadWidth)) {
    holder.innerHTML = 'Enter total road width, total verge/footpath width, and remaining road width to view the sketch.';
    if (downloadBtn) downloadBtn.disabled = true;
    lastWidthSketchSvg = null;
    return;
  }

  const totalLength = Number.isFinite(totalConsidered) ? totalConsidered : 0;
  const workArea = totalLength > 0
    ? totalLength - (safeWW + clearanceM + remainingRoadWidth)
    : null;

  const spanVal = totalLength > 0 ? totalLength : (remainingRoadWidth + clearanceM + safeWW);
  const margin = 40;
  const holderWidth = holder.clientWidth || 960;
  const targetWidth = Math.max(760, holderWidth - margin * 2);
  const pxPerM = spanVal > 0 ? Math.min(targetWidth / spanVal, 28) : 24;
  const baseY = 180;
  const legendSpace = 240; // extra room on the right for the data labels
  const svgW = Math.max(520, margin * 2 + Math.ceil(Math.max(spanVal, 1) * pxPerM) + legendSpace);
  const svgH = 360;
  const x0 = margin;

  const pxBarrier = safeBarrier * pxPerM;
  const pxDefl = Math.max(0, safeDefl * pxPerM);
  const pxWW = safeWW * pxPerM;
  const pxRoad = remainingRoadWidth * pxPerM;
  const pxTotal = totalLength * pxPerM;
  const pxWorkArea = Number.isFinite(workArea) ? Math.max(0, workArea) * pxPerM : 0;
  const pxClear = clearanceM * pxPerM;
  const xClearStart = x0 + pxRoad;
  const xWorkStart = xClearStart + pxClear;
  const xBarrier = xWorkStart;
  const baselineEnd = x0 + pxTotal;

  const dim = (x1, x2, y, label, color = '#0f172a') => {
    if (!Number.isFinite(x1) || !Number.isFinite(x2)) return '';
    const left = Math.min(x1, x2);
    const right = Math.max(x1, x2);
    return `
      <g>
        <line x1="${left}" y1="${y}" x2="${right}" y2="${y}" stroke="${color}" stroke-width="2" />
        <polygon points="${left},${y} ${left + 9},${y - 6} ${left + 9},${y + 6}" fill="${color}" />
        <polygon points="${right},${y} ${right - 9},${y - 6} ${right - 9},${y + 6}" fill="${color}" />
        <text x="${(left + right) / 2}" y="${y - 8}" text-anchor="middle" fill="${color}" font-size="8" font-weight="700">${label}</text>
      </g>`;
  };

  const labelBlock = (x, y, text, color = '#0f172a', weight = '700', size = 8) => {
    return `<text x="${x}" y="${y}" fill="${color}" font-size="${size}" font-weight="${weight}" text-anchor="start">${text}</text>`;
  };

  const labelX = baselineEnd + 24;

  const svg = `
    <svg viewBox="0 0 ${svgW} ${svgH}" role="img" aria-label="Stage 3 width sketch">
      <defs>
        <linearGradient id="deflGrad" x1="0%" x2="100%" y1="0%" y2="0%">
          <stop offset="0%" stop-color="#fef3c7" />
          <stop offset="100%" stop-color="#fde68a" />
        </linearGradient>
        <linearGradient id="wwGrad" x1="0%" x2="100%" y1="0%" y2="0%">
          <stop offset="0%" stop-color="#dbeafe" />
          <stop offset="100%" stop-color="#bfdbfe" />
        </linearGradient>
      </defs>

      <rect x="${x0}" y="${baseY - 10}" width="${pxRoad}" height="20" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1" rx="8" />
      <rect x="${xClearStart}" y="${baseY - 8}" width="${pxClear}" height="16" fill="#e0f2fe" stroke="#0284c7" stroke-width="1" rx="6" />
      <rect x="${xClearStart}" y="${baseY - 18}" width="${pxClear}" height="36" fill="#e5e7eb" stroke="#94a3b8" stroke-width="1" rx="6" />
      <rect x="${xWorkStart}" y="${baseY - 46}" width="${pxWW}" height="28" fill="url(#wwGrad)" stroke="#2563eb" stroke-width="1.5" rx="6" />
      <rect x="${xWorkStart}" y="${baseY - 62}" width="${pxBarrier}" height="20" fill="#2563eb" stroke="#1d4ed8" stroke-width="1.2" rx="5" />
      <rect x="${xWorkStart + pxBarrier}" y="${baseY - 46}" width="${pxDefl}" height="28" fill="url(#deflGrad)" stroke="#f59e0b" stroke-width="1.2" rx="4" />
      ${workArea > 0 ? `<rect x="${xWorkStart + pxWW}" y="${baseY - 8}" width="${pxWorkArea}" height="16" fill="#f0fdf4" stroke="#15803d" stroke-width="1" rx="6" />` : ''}

      <line x1="${x0}" y1="${baseY}" x2="${baselineEnd}" y2="${baseY}" stroke="#0f172a" stroke-width="2" stroke-dasharray="6 4" />

      ${dim(x0, xClearStart, 38, `${remainingRoadWidth.toFixed(3)} m remaining road width (front)`, '#0f172a')}
      ${dim(xClearStart, xWorkStart, 64, `${clearanceM.toFixed(3)} m clearance (front)`, '#334155')}
      ${safeWW > 0 ? dim(xWorkStart, xWorkStart + pxWW, 90, `${safeWW.toFixed(3)} m working width`, '#2563eb') : ''}
      ${safeBarrier > 0 ? dim(xWorkStart, xWorkStart + pxBarrier, 118, `${safeBarrier.toFixed(3)} m barrier`, '#1d4ed8') : ''}
      ${safeDefl > 0 ? dim(xWorkStart + pxBarrier, xWorkStart + pxBarrier + pxDefl, 146, `${safeDefl.toFixed(3)} m deflection`, '#b45309') : ''}
      ${Number.isFinite(workArea) ? dim(xWorkStart + pxWW, xWorkStart + pxWW + pxWorkArea, 174, `${workArea.toFixed(3)} m work area`, workArea >= 0 ? '#15803d' : '#b91c1c') : ''}
      ${totalLength > 0 ? dim(x0, x0 + pxTotal, 202, `${totalLength.toFixed(3)} m total length for consideration`, '#0f172a') : ''}

      ${labelBlock(labelX, baseY + 32, selectedBarrier.name || 'Barrier', '#0f172a')}
      ${safeEt ? labelBlock(labelX, baseY + 52, `End treatment: ${selectedEndTreatment.name} (${safeEt.toFixed(3)} m)`, '#0f172a', '600') : ''}
      ${labelBlock(labelX, baseY + 72, `Total road width (user): ${totalRoadWidth.toFixed(3)} m`, '#0f172a', '600')}
      ${labelBlock(labelX, baseY + 92, `Total verge/footpath width (user): ${totalVergeWidth.toFixed(3)} m`, '#0f172a', '600')}
      ${labelBlock(labelX, baseY + 112, `Remaining road width (user): ${remainingRoadWidth.toFixed(3)} m`, '#0f172a', '600')}
      ${totalLength > 0 ? labelBlock(labelX, baseY + 132, `Total length for consideration: ${totalLength.toFixed(3)} m`, '#0f172a', '700') : ''}
      ${Number.isFinite(workArea) ? labelBlock(labelX, baseY + 152, `Work area: ${workArea.toFixed(3)} m (total - working width - clearance - remaining road)`, workArea >= 0 ? '#15803d' : '#b91c1c', '700') : ''}
      ${labelBlock(labelX, baseY + 172, `Clearance toward road: ${clearanceM.toFixed(3)} m (fixed)`, '#334155', '600')}
    </svg>`;

  holder.innerHTML = svg;
  lastWidthSketchSvg = svg;
  if (downloadBtn) downloadBtn.disabled = false;
}

function downloadSvgAsImage(svgString, filename) {
  // Parse SVG to extract viewBox or width/height
  const parser = new DOMParser();
  const svgDoc = parser.parseFromString(svgString, 'image/svg+xml');
  const svgElement = svgDoc.documentElement;
  
  let width = 1200;
  let height = 800;
  
  // Try to get dimensions from viewBox
  const viewBox = svgElement.getAttribute('viewBox');
  if (viewBox) {
    const parts = viewBox.split(/\s+/);
    if (parts.length === 4) {
      width = parseFloat(parts[2]);
      height = parseFloat(parts[3]);
    }
  } else {
    // Try width/height attributes
    const w = svgElement.getAttribute('width');
    const h = svgElement.getAttribute('height');
    if (w) width = parseFloat(w);
    if (h) height = parseFloat(h);
  }
  
  const canvas = document.createElement('canvas');
  canvas.width = width * 2; // 2x for better quality
  canvas.height = height * 2;
  const ctx = canvas.getContext('2d');
  ctx.scale(2, 2);
  
  // Convert SVG to data URL instead of blob URL
  const svgData = new XMLSerializer().serializeToString(svgElement);
  const svgDataUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgData);
  
  const img = new Image();
  
  img.onload = function() {
    ctx.drawImage(img, 0, 0, width, height);
    
    canvas.toBlob(function(blob) {
      const pngUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = pngUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(pngUrl), 500);
    }, 'image/png');
  };
  
  img.onerror = function(e) {
    console.error('SVG to image conversion failed:', e);
    alert('Failed to convert to image. Downloading as SVG instead.');
    // Fallback to SVG download
    const blob = new Blob([svgString], { type: 'image/svg+xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename.replace('.png', '.svg');
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 500);
  };
  
  img.src = svgDataUrl;
}

function downloadWidthSketch() {
  if (!lastWidthSketchSvg) {
    alert('Render the Stage 3 sketch first.');
    return;
  }
  downloadSvgAsImage(lastWidthSketchSvg, 'stage2-width-sketch.png');
}

function renderWidthOverlay(barrierWidth, etWidth, designDefl, designWW, availWidth, maxValFromVisual) {
  const holder = document.getElementById('widthOverlay');
  const btn = document.getElementById('widthOverlayDownload');
  if (!holder) return;

  const hasCalc = Number.isFinite(designWW) && Number.isFinite(designDefl);
  if (!selectedBarrier || !hasCalc) {
    holder.innerHTML = 'Run Stage 3 calculation and select an end treatment to view the overlay.';
    if (btn) btn.disabled = true;
    lastWidthOverlaySvg = null;
    return;
  }

  const safeBarrier = Number.isFinite(barrierWidth) && barrierWidth > 0 ? barrierWidth : 0;
  const safeDefl = Number.isFinite(designDefl) && designDefl > 0 ? designDefl : 0;
  const safeWW = Number.isFinite(designWW) && designWW > 0 ? designWW : 0;
  const safeEt = Number.isFinite(etWidth) && etWidth > 0 ? etWidth : null;
  const clearanceM = 0.3;
  const sketchInputs = getSketchWidthInputs();
  const totalRoadWidth = sketchInputs.roadWidth;
  const totalVergeWidth = sketchInputs.vergeWidth;
  const remainingRoadWidth = sketchInputs.remainingRoadWidth;
  const totalLength = sketchInputs.totalConsidered;

  if (!Number.isFinite(totalRoadWidth) || !Number.isFinite(totalVergeWidth) || !Number.isFinite(remainingRoadWidth)) {
    holder.innerHTML = 'Enter total road width, total verge/footpath width, and remaining road width to view the overlay.';
    if (btn) btn.disabled = true;
    lastWidthOverlaySvg = null;
    return;
  }

  const workArea = Number.isFinite(totalLength)
    ? totalLength - (safeWW + clearanceM + remainingRoadWidth)
    : null;

  const maxVal = Math.max(
    totalLength || 0,
    safeWW,
    safeBarrier,
    safeDefl,
    remainingRoadWidth,
    1
  );

  const pxPerM = Math.min(920 / maxVal, 240);
  const margin = 60;
  const baseY = 110;
  const svgW = Math.max(420, margin * 2 + Math.ceil(maxVal * pxPerM));
  const svgH = 280;
  const x0 = margin;

  const pxTotal = (totalLength || 0) * pxPerM;
  const pxRoad = remainingRoadWidth * pxPerM;
  const pxClear = clearanceM * pxPerM;
  const pxWW = safeWW * pxPerM;
  const pxBarrier = safeBarrier * pxPerM;
  const pxDefl = safeDefl * pxPerM;
  const pxWorkArea = Number.isFinite(workArea) ? Math.max(0, workArea) * pxPerM : 0;

  const dim = (x1, x2, y, label, color = '#7f1d1d') => {
    if (!Number.isFinite(x1) || !Number.isFinite(x2)) return '';
    const left = Math.min(x1, x2);
    const right = Math.max(x1, x2);
    return `
      <g>
        <line x1="${left}" y1="${y}" x2="${right}" y2="${y}" stroke="${color}" stroke-width="2" />
        <polygon points="${left},${y} ${left + 10},${y - 7} ${left + 10},${y + 7}" fill="${color}" />
        <polygon points="${right},${y} ${right - 10},${y - 7} ${right - 10},${y + 7}" fill="${color}" />
        <text x="${(left + right) / 2}" y="${y - 8}" text-anchor="middle" fill="${color}" font-size="13" font-weight="700">${label}</text>
      </g>`;
  };

  const stripe = (x, width, y1, y2, color) => {
    if (!Number.isFinite(width) || width <= 0) return '';
    return `<rect x="${x}" y="${y1}" width="${width}" height="${y2 - y1}" fill="${color}" />`;
  };

  const guideLine = (x, y1, y2, color = '#991b1b') => {
    return `<line x1="${x}" y1="${y1}" x2="${x}" y2="${y2}" stroke="${color}" stroke-width="2" />`;
  };

  const startX = x0;
  const endTotal = x0 + pxTotal;
  const endRoad = x0 + pxRoad;
  const endClear = endRoad + pxClear;
  const endWW = endClear + pxWW;
  const endBarrier = endClear + pxBarrier;
  const endDefl = endBarrier + pxDefl;
  const endWorkArea = endWW + pxWorkArea;

  const svg = `
    <svg viewBox="0 0 ${svgW} ${svgH}" role="img" aria-label="Width overlay linework">
      <rect x="0" y="0" width="${svgW}" height="${svgH}" fill="white" />

      ${pxTotal > 0 ? stripe(startX, pxTotal, baseY - 36, baseY - 26, '#e2e8f0') : ''}
      ${stripe(startX, pxRoad, baseY - 6, baseY + 6, '#cbd5e1')}
      ${stripe(endRoad, pxClear, baseY - 10, baseY + 10, '#e0f2fe')}
      ${stripe(endClear, pxWW, baseY - 6, baseY + 6, '#22d3ee')}
      ${stripe(endClear, pxBarrier, baseY - 6, baseY + 6, '#0ea5e9')}
      ${stripe(endBarrier, pxDefl, baseY - 16, baseY + 16, '#fde047')}
      ${pxWorkArea > 0 ? stripe(endWW, pxWorkArea, baseY - 20, baseY + 20, '#bbf7d0') : ''}

      ${guideLine(startX, baseY - 46, baseY + 46)}
      ${guideLine(endRoad, baseY - 46, baseY + 46)}
      ${guideLine(endClear, baseY - 46, baseY + 46)}
      ${guideLine(endWW, baseY - 46, baseY + 46)}
      ${guideLine(endBarrier, baseY - 46, baseY + 46)}
      ${guideLine(endDefl, baseY - 46, baseY + 46)}
      ${pxTotal > 0 ? guideLine(endTotal, baseY - 46, baseY + 46) : ''}

      ${dim(startX, endRoad, 34, `${remainingRoadWidth.toFixed(3)} m remaining road`)}
      ${dim(endRoad, endClear, 60, `${clearanceM.toFixed(3)} m clearance`)}
      ${safeWW > 0 ? dim(endClear, endWW, 86, `${safeWW.toFixed(3)} m working width`) : ''}
      ${safeBarrier > 0 ? dim(endClear, endBarrier, 112, `${safeBarrier.toFixed(3)} m barrier`) : ''}
      ${safeDefl > 0 ? dim(endBarrier, endDefl, 138, `${safeDefl.toFixed(3)} m deflection`) : ''}
      ${Number.isFinite(workArea) ? dim(endWW, endWorkArea, 164, `${workArea.toFixed(3)} m work area`, workArea >= 0 ? '#15803d' : '#b91c1c') : ''}
      ${pxTotal > 0 ? dim(startX, endTotal, 190, `${totalLength.toFixed(3)} m total length for consideration`) : ''}

      ${safeEt ? `<text x="${startX}" y="${baseY + 88}" fill="#0f172a" font-size="13" font-weight="600" text-anchor="start">End treatment: ${selectedEndTreatment.name} (${safeEt.toFixed(3)} m)</text>` : ''}
      <text x="${startX}" y="${baseY + 108}" fill="#0f172a" font-size="13" font-weight="700" text-anchor="start">${selectedBarrier.name || 'Barrier'}</text>
    </svg>`;

  holder.innerHTML = svg;
  lastWidthOverlaySvg = svg;
  if (btn) btn.disabled = false;
}

function downloadWidthOverlay() {
  if (!lastWidthOverlaySvg) {
    alert('Render the overlay first.');
    return;
  }
  downloadSvgAsImage(lastWidthOverlaySvg, 'width-overlay.png');
}

function renderLongitudinalView() {
  const holder = document.getElementById('longitudinalView');
  const btn = document.getElementById('longitudinalDownload');
  const endsSelect = document.getElementById('etEndsMode');
  const singleSideSelect = document.getElementById('etSingleSide');
  const singleSideWrap = document.getElementById('etSingleSideWrap');
  if (endsSelect) endTreatmentEndsMode = endsSelect.value || 'single';
  if (singleSideSelect) endTreatmentSingleSide = singleSideSelect.value || 'right';
  if (singleSideWrap) singleSideWrap.style.display = endTreatmentEndsMode === 'single' ? 'flex' : 'none';
  if (!holder) return;

  if (!selectedBarrier || !selectedEndTreatment || !lastScenarioSnapshot) {
    holder.innerHTML = 'Select a barrier, select an end treatment, and run Stage 3 calculation to view the longitudinal line.';
    if (btn) btn.disabled = true;
    lastLongitudinalSvg = null;
    return;
  }

  const designLen = Number.isFinite(lastScenarioSnapshot.designLen) ? lastScenarioSnapshot.designLen : selectedBarrier.testLen || 0;
  const etLen = ['designLen', 'designLength', 'len', 'length', 'testLen', 'overallLength', 'overallLen', 'lengthMeters', 'lengthMetres']
    .map(k => selectedEndTreatment?.[k])
    .find(v => Number.isFinite(v) && v > 0) || 0;
  const buffer = Number.isFinite(bufferLength) && bufferLength > 0 ? bufferLength : 0;
  const hasBoth = endTreatmentEndsMode === 'both';
  const isSingleLeft = !hasBoth && endTreatmentSingleSide === 'left';
  const etCount = hasBoth ? 2 : 1;
  const bufferCount = hasBoth ? 2 : 1;
  const safeBarrierLen = Number.isFinite(designLen) && designLen > 0 ? designLen : 0;
  
  // Calculate units from available lengths
  let unitsCount = null;
  let unitBreakdown = null;
  if (Array.isArray(selectedBarrier.availableLengths) && selectedBarrier.availableLengths.length > 0) {
    const availLengths = selectedBarrier.availableLengths.filter(v => Number.isFinite(v) && v > 0).sort((a, b) => b - a);
    let remaining = safeBarrierLen;
    let totalUnits = 0;
    const breakdown = [];
    for (const len of availLengths) {
      const units = Math.floor(remaining / len);
      if (units > 0) {
        breakdown.push(`${units} × ${len.toFixed(2)}m`);
        totalUnits += units;
        remaining -= units * len;
      }
    }
    unitsCount = totalUnits;
    unitBreakdown = breakdown.length > 0 ? breakdown.join(' + ') : null;
  }

  if (safeBarrierLen <= 0 && etLen <= 0) {
    holder.innerHTML = 'Barrier length not available; enter design length in Stage 3.';
    if (btn) btn.disabled = true;
    lastLongitudinalSvg = null;
    return;
  }

  const totalLen = safeBarrierLen + (hasBoth ? buffer * 2 : buffer) + (hasBoth ? etLen * 2 : etLen);
  const maxVal = Math.max(totalLen, safeBarrierLen, etLen || 0, buffer, 1);
  const margin = 60;
  const pxPerM = Math.min(900 / maxVal, 240);
  const svgW = Math.max(420, margin * 2 + Math.ceil(maxVal * pxPerM));
  const svgH = 220;
  const baseY = 110;
  const x0 = margin;

  const pxEt = etLen * pxPerM;
  const pxBuffer = buffer * pxPerM;
  const pxBarrier = safeBarrierLen * pxPerM;
  const leftEtWidth = hasBoth || isSingleLeft ? pxEt : 0;
  const rightEtWidth = hasBoth || !isSingleLeft ? pxEt : 0;
  const leftBufferWidth = (hasBoth || isSingleLeft) ? pxBuffer : 0;
  const rightBufferWidth = (hasBoth || !isSingleLeft) ? pxBuffer : 0;

  const leftEtStart = x0;
  const leftEtEnd = leftEtStart + leftEtWidth;
  const leftBufferStart = leftEtEnd;
  const leftBufferEnd = leftBufferStart + leftBufferWidth;
  const barrierStart = leftBufferEnd;
  const barrierEnd = barrierStart + pxBarrier;
  const rightBufferStart = barrierEnd;
  const rightBufferEnd = rightBufferStart + rightBufferWidth;
  const rightEtStart = rightBufferEnd;
  const rightEtEnd = rightEtStart + rightEtWidth;
  const totalEnd = rightEtEnd;

  const dim = (x1, x2, y, label, color = '#0f172a') => {
    if (!Number.isFinite(x1) || !Number.isFinite(x2)) return '';
    const left = Math.min(x1, x2);
    const right = Math.max(x1, x2);
    return `
      <g>
        <line x1="${left}" y1="${y}" x2="${right}" y2="${y}" stroke="${color}" stroke-width="2" />
        <polygon points="${left},${y} ${left + 10},${y - 7} ${left + 10},${y + 7}" fill="${color}" />
        <polygon points="${right},${y} ${right - 10},${y - 7} ${right - 10},${y + 7}" fill="${color}" />
        <text x="${(left + right) / 2}" y="${y - 10}" text-anchor="middle" fill="${color}" font-size="10" font-weight="700">${label}</text>
      </g>`;
  };

  const segment = (x, w, label, fill, stroke) => {
    if (w <= 0) return '';
    return `
      <g>
        <rect x="${x}" y="${baseY - 10}" width="${w}" height="20" fill="${fill}" stroke="${stroke}" stroke-width="1.4" rx="6" />
        <text x="${x + w / 2}" y="${baseY + 30}" text-anchor="middle" fill="#0f172a" font-size="10" font-weight="700">${label}</text>
      </g>`;
  };

  const svg = `
    <svg viewBox="0 0 ${svgW} ${svgH}" role="img" aria-label="Longitudinal view">
      <rect x="0" y="0" width="${svgW}" height="${svgH}" fill="white" />
      ${leftEtWidth > 0 && etLen > 0 ? segment(leftEtStart, leftEtWidth, `${selectedEndTreatment.name} (${etLen.toFixed(2)} m)`, '#fde68a', '#f59e0b') : ''}
      ${leftBufferWidth > 0 && buffer > 0 ? segment(leftBufferStart, leftBufferWidth, `Buffer (${buffer.toFixed(2)} m)`, '#fecaca', '#dc2626') : ''}
      ${segment(barrierStart, pxBarrier, `Barrier (${safeBarrierLen.toFixed(2)} m)`, '#bfdbfe', '#2563eb')}
      ${rightBufferWidth > 0 && buffer > 0 ? segment(rightBufferStart, rightBufferWidth, `Buffer (${buffer.toFixed(2)} m)`, '#fecaca', '#dc2626') : ''}
      ${rightEtWidth > 0 && etLen > 0 ? segment(rightEtStart, rightEtWidth, `${selectedEndTreatment.name} (${etLen.toFixed(2)} m)`, '#fde68a', '#f59e0b') : ''}

      ${totalLen > 0 ? dim(leftEtStart, totalEnd, 52, `${totalLen.toFixed(2)} m total length (barrier + ends${buffer > 0 ? ' + buffer' : ''})`, '#0f172a') : ''}
      ${safeBarrierLen > 0 ? dim(barrierStart, barrierEnd, 76, `${safeBarrierLen.toFixed(2)} m barrier (design length)`, '#2563eb') : ''}
      ${leftBufferWidth > 0 && buffer > 0 ? dim(leftBufferStart, leftBufferEnd, 100, `${buffer.toFixed(2)} m buffer`, '#dc2626') : ''}
      ${rightBufferWidth > 0 && buffer > 0 ? dim(rightBufferStart, rightBufferEnd, 100, `${buffer.toFixed(2)} m buffer`, '#dc2626') : ''}
      ${leftEtWidth > 0 && etLen > 0 ? dim(leftEtStart, leftEtEnd, 124, `${etLen.toFixed(2)} m end`, '#b45309') : ''}
      ${rightEtWidth > 0 && etLen > 0 ? dim(rightEtStart, rightEtEnd, 124, `${etLen.toFixed(2)} m end`, '#b45309') : ''}

      <text x="${x0}" y="${svgH - 26}" fill="#334155" font-size="11" font-weight="600" text-anchor="start">End treatments: ${hasBoth ? 'Both ends' : `Single end (${isSingleLeft ? 'left' : 'right'} side)`} | Barrier design length = ${safeBarrierLen.toFixed(2)} m | Total length = ${safeBarrierLen.toFixed(2)} + ${(etLen * etCount).toFixed(2)}${buffer > 0 ? ` + ${(buffer * bufferCount).toFixed(2)}` : ''} = ${totalLen.toFixed(2)} m</text>
      ${unitBreakdown !== null ? `<text x="${x0}" y="${svgH - 8}" fill="#0f172a" font-size="11" font-weight="700" text-anchor="start">Barrier units: ${unitBreakdown} = ${unitsCount} total units</text>` : ''}
    </svg>`;

  holder.innerHTML = svg;
  lastLongitudinalSvg = svg;
  if (btn) btn.disabled = false;
}

function addBufferLength() {
  const currentValue = bufferLength > 0 ? bufferLength : '';
  const promptBuffer = prompt('Enter buffer length (m) to deduct from total barrier length:', currentValue);
  
  if (promptBuffer === null) return; // User cancelled
  
  const parsedBuffer = parseFloat(promptBuffer);
  if (!Number.isFinite(parsedBuffer) || parsedBuffer < 0) {
    alert('Please enter a positive number or 0 for buffer length.');
    return;
  }
  
  bufferLength = parsedBuffer;
  renderLongitudinalView();
}

function downloadLongitudinalView() {
  if (!lastLongitudinalSvg) {
    alert('Render the longitudinal view first.');
    return;
  }
  downloadSvgAsImage(lastLongitudinalSvg, 'longitudinal-view.png');
}

function escapeHTML(value) {
  if (value === null || value === undefined) return '';
  return String(value).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch] || ch));
}

function formatNumber(value, digits = 2) {
  return Number.isFinite(value) ? value.toFixed(digits) : '-';
}

function saveScenarioSnapshot() {
  if (!selectedBarrier || !lastScenarioSnapshot) {
    alert('Run the calculation before saving a scenario.');
    return;
  }
  if (calcDirty) {
    alert('Apply the pending updates before saving this scenario.');
    return;
  }

  const targetSpeed = Number.isFinite(lastScenarioSnapshot.designSpeed)
    ? lastScenarioSnapshot.designSpeed
    : lastScenarioSnapshot.speed;
  const defaultName = `${lastScenarioSnapshot.barrierName} @ ${formatNumber(targetSpeed, 0)} km/h`;
  const nameInput = prompt('Scenario name', defaultName);
  if (nameInput === null) return;
  const trimmed = nameInput.trim() || defaultName;

  const snapshot = JSON.parse(JSON.stringify({
    ...lastScenarioSnapshot,
    id: Date.now(),
    name: trimmed,
    savedAt: new Date().toISOString()
  }));

  savedScenarios.unshift(snapshot);
  if (savedScenarios.length > 20) {
    savedScenarios = savedScenarios.slice(0, 20);
  }
  persistSavedScenarios();
  renderSavedScenarios();
}

function loadSavedScenarios() {
  try {
    const raw = localStorage.getItem(SCENARIO_STORAGE_KEY);
    savedScenarios = raw ? JSON.parse(raw) : [];
  } catch (e) {
    savedScenarios = [];
  }
}

function renderSavedScenarios() {
  const container = document.getElementById('savedScenariosContainer');
  const clearBtn = document.getElementById('clearScenariosBtn');
  const exportBtn = document.getElementById('exportCsvBtn');
  const exportJsonBtn = document.getElementById('exportJsonBtn');
  const importBtn = document.getElementById('importJsonBtn');
  if (!container) return;

  if (!savedScenarios.length) {
    container.innerHTML = '<div class="scenario-empty">No saved scenarios yet. Save a snapshot to compare different setups.</div>';
    if (clearBtn) clearBtn.style.display = 'none';
    if (exportBtn) exportBtn.style.display = 'none';
    if (exportJsonBtn) exportJsonBtn.style.display = 'none';
    if (importBtn) importBtn.style.display = 'none';
    return;
  }

  const cards = savedScenarios.map((scenario, index) => {
    const summary = scenario.summary || {};
    const savedDate = scenario.savedAt ? new Date(scenario.savedAt).toLocaleString() : '';
    const siteWidthText = scenario.siteWidth !== null && scenario.siteWidth !== undefined ? `${formatNumber(scenario.siteWidth, 2)} m` : 'n/a';
    const scenarioDesignSpeed = Number.isFinite(scenario.designSpeed) ? scenario.designSpeed : scenario.speed;
    return `
      <div class="scenario-card">
        <h5>${escapeHTML(scenario.name)}</h5>
        <div class="scenario-meta">${escapeHTML(scenario.barrierName)} • ${escapeHTML(scenario.supplier || '')}</div>
        <div class="scenario-meta">Saved: ${escapeHTML(savedDate)}</div>
        <div class="scenario-metrics">
          Impact: ${formatNumber(scenario.mass, 0)} kg @ ${formatNumber(scenarioDesignSpeed, 0)} km/h, ${formatNumber(scenario.angle, 0)}°<br>
          Design defl: ${formatNumber(summary.designDeflection, 3)} m • WW: ${formatNumber(summary.designWorkingWidth, 3)} m<br>
          Units: ${formatNumber(summary.units, 0)} • Site width: ${siteWidthText}
        </div>
        <div class="scenario-actions">
          <button class="btn btn-auto" onclick="loadScenario(${index})">Load</button>
          <button class="btn btn-outline btn-auto" onclick="cloneScenario(${index})">Clone</button>
          <button class="btn btn-outline btn-auto" onclick="deleteScenario(${index})">Delete</button>
        </div>
      </div>
    `;
  }).join('');

  container.innerHTML = `<div class="scenario-list">${cards}</div>`;
  if (clearBtn) clearBtn.style.display = 'inline-flex';
  if (exportBtn) exportBtn.style.display = 'inline-flex';
  if (exportJsonBtn) exportJsonBtn.style.display = 'inline-flex';
  if (importBtn) importBtn.style.display = 'inline-flex';
  renderDataHealth();
}

function exportScenariosToCSV() {
  if (!savedScenarios.length) {
      alert('No scenarios to export.');
      return;
  }

  // Get Project Info from Stage 7 inputs (if available)
  const pName = document.getElementById('projName') ? document.getElementById('projName').value : '';
  const pJob = document.getElementById('projJobNum') ? document.getElementById('projJobNum').value : '';
  const pLoc = document.getElementById('projLoc') ? document.getElementById('projLoc').value : '';

  // Headers
  const headers = ['Project Name', 'Job Number', 'Location', 'Scenario Name', 'Date', 'Barrier', 'Supplier', 'Mass (kg)', 'Speed (km/h)', 'Angle (deg)', 'Design Deflection (m)', 'Design Working Width (m)', 'Units Displaced', 'Site Width (m)'];
  
  // Rows
  const rows = savedScenarios.map(s => {
      const sum = s.summary || {};
      const speed = Number.isFinite(s.designSpeed) ? s.designSpeed : s.speed;
      return [
          pName,
          pJob,
          pLoc,
          s.name,
          new Date(s.savedAt).toLocaleDateString(),
          s.barrierName,
          s.supplier,
          s.mass,
          speed,
          s.angle,
          formatNumber(sum.designDeflection, 3),
          formatNumber(sum.designWorkingWidth, 3),
          formatNumber(sum.units, 0),
          s.siteWidth
      ].map(field => `"${String(field || '').replace(/"/g, '""')}"`).join(','); // CSV escaping
  });

  const csvContent = [headers.join(','), ...rows].join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.setAttribute('href', url);
  link.setAttribute('download', 'deflection_scenarios.csv');
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function exportScenariosToJSON() {
  if (!savedScenarios.length) {
    alert('No scenarios to export.');
    return;
  }
  const blob = new Blob([JSON.stringify(savedScenarios, null, 2)], { type: 'application/json;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'deflection_scenarios.json';
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function handleScenarioImport(event) {
  const file = event.target.files && event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const parsed = JSON.parse(e.target.result || '[]');
      if (!Array.isArray(parsed)) throw new Error('File must contain an array of scenarios');
      const now = Date.now();
      let imported = 0;
      parsed.forEach((sc, idx) => {
        if (!sc || typeof sc !== 'object') return;
        const clone = { ...sc };
        clone.id = now + idx;
        if (!clone.name) clone.name = `Imported ${imported + 1}`;
        if (!clone.savedAt) clone.savedAt = new Date().toISOString();
        savedScenarios.unshift(clone);
        imported++;
      });
      if (imported) {
        if (savedScenarios.length > 50) savedScenarios = savedScenarios.slice(0, 50);
        persistSavedScenarios();
        renderSavedScenarios();
        alert(`Imported ${imported} scenario(s).`);
      } else {
        alert('No valid scenarios found in file.');
      }
    } catch (err) {
      alert('Could not import scenarios: ' + err.message);
    } finally {
      event.target.value = '';
    }
  };
  reader.readAsText(file);
}

function deleteScenario(index) {
  if (index < 0 || index >= savedScenarios.length) return;
  const scenario = savedScenarios[index];
  const confirmDelete = confirm(`Remove scenario "${scenario.name}"?`);
  if (!confirmDelete) return;
  savedScenarios.splice(index, 1);
  persistSavedScenarios();
  renderSavedScenarios();
}

function cloneScenario(index) {
  const scenario = savedScenarios[index];
  if (!scenario) return;
  const copy = JSON.parse(JSON.stringify(scenario));
  copy.id = Date.now();
  copy.name = `${scenario.name} (copy)`;
  copy.savedAt = new Date().toISOString();
  savedScenarios.unshift(copy);
  if (savedScenarios.length > 50) savedScenarios = savedScenarios.slice(0, 50);
  persistSavedScenarios();
  renderSavedScenarios();
}

function clearSavedScenarios() {
  if (!savedScenarios.length) return;
  const confirmClear = confirm('Clear all saved scenarios?');
  if (!confirmClear) return;
  savedScenarios = [];
  persistSavedScenarios();
  renderSavedScenarios();
}

function applyScenarioInputs(scenario) {
  if (!scenario) return;
  document.getElementById('inMass').value = scenario.mass ?? '';
  document.getElementById('inAngle').value = scenario.angle ?? '';
  document.getElementById('inDesignLength').value = scenario.designLen ?? '';
  document.getElementById('inFriction').value = scenario.friction ?? '';
  document.getElementById('inUnitLength').value = scenario.unitLength ?? '';
  document.getElementById('inUnitWeightT').value = scenario.unitWeightT ?? '';
  const designSpeedField = document.getElementById('designSpeedInput');
  if (designSpeedField) {
    const scenarioDesignSpeed = scenario.designSpeed ?? scenario.speed;
    if (scenarioDesignSpeed === undefined || scenarioDesignSpeed === null || scenarioDesignSpeed === '') {
      designSpeedField.removeAttribute('data-user-edited');
    } else {
      designSpeedField.value = scenarioDesignSpeed;
      designSpeedField.setAttribute('data-user-edited', 'true');
    }
  }
  calcDirty = false;
  clearCalcDirty();
}

function loadScenario(index) {
  const scenario = savedScenarios[index];
  if (!scenario) return;

  const barrierExists = barriers.some(b => b.id === scenario.barrierId);
  if (!barrierExists) {
    alert('The barrier for this scenario is no longer available in the dataset.');
    return;
  }

  const siteSpeedField = document.getElementById('siteSpeed');
  const siteWidthField = document.getElementById('siteWidth');
  if (siteSpeedField) siteSpeedField.value = scenario.siteSpeed || siteSpeedField.value;
  if (siteWidthField) {
    if (scenario.siteWidth === null || scenario.siteWidth === undefined || Number.isNaN(scenario.siteWidth)) {
      siteWidthField.value = '';
    } else {
      siteWidthField.value = scenario.siteWidth;
    }
  }

  pendingScenarioLoad = scenario;
  filterBarriers();
  selectBarrier(scenario.barrierId);
}

function calculateEnergy(m, s, a) {
  const rad = a * (Math.PI / 180);
  const vPerp = s * Math.sin(rad);
  return (0.5 * m * Math.pow(vPerp, 2)) / 1000;
}

function interpolateHG(speed, angle) {
    const data = highwayGuardMatrix;
    let aIdx = data.angles.indexOf(angle);
    if(aIdx === -1) { aIdx = data.angles.findIndex(x => x >= angle); if(aIdx===-1) aIdx=4; }

    let sIdx = data.speeds.findIndex(x => x >= speed);
    if(sIdx === -1) sIdx = data.speeds.length-1;
    if(sIdx === 0) sIdx = 1;

    const s1 = data.speeds[sIdx-1];
    const s2 = data.speeds[sIdx];
    const d1 = data.data[sIdx-1][aIdx];
    const d2 = data.data[sIdx][aIdx];
    
    return d1 + (speed - s1)/(s2 - s1) * (d2 - d1);
}

function backToSelection() {
  showOnlyStage('stage2');
    const nextBtn = document.getElementById('toStage3Btn');
    if (nextBtn) nextBtn.style.display = 'none';
    const nextBtn4 = document.getElementById('toStage4Btn');
    if (nextBtn4) nextBtn4.style.display = 'none';
    document.getElementById('resetBtn').style.display = 'none';
    selectedBarrier = null;
    selectedEndTreatment = null;
    if(document.getElementById('selectedEtDisplay')) document.getElementById('selectedEtDisplay').style.display = 'none';
    
  calcDirty = false;
  lastCalcInputs = null;
  lastScenarioSnapshot = null;
  clearCalcDirty();

  const container = document.getElementById('matrixContainer');
  if (container) container.innerHTML = '';
  const printContainer = document.getElementById('printMatrixContainer');
  if (printContainer) printContainer.innerHTML = '';

  const defaults = {
    resBaseDefl: '-',
    resBaseWW: '-',
    resUnits: '-',
    resDesignDefl: '-',
    resDesignWW: '-'
  };
  Object.entries(defaults).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  });

  const energyField = document.getElementById('outEnergy');
  if (energyField) energyField.value = '';
  const kgField = document.getElementById('outUnitWeightKg');
  if (kgField) kgField.value = '';
  const systemWidthField = document.getElementById('valSystemWidth');
  if (systemWidthField) systemWidthField.value = '';
  const widthAllowanceField = document.getElementById('valWidthAllowance');
  if (widthAllowanceField) widthAllowanceField.value = '';
  const testSpeedField = document.getElementById('inSpeed');
  if (testSpeedField) testSpeedField.value = '';
  const designSpeedField = document.getElementById('designSpeedInput');
  if (designSpeedField) {
    designSpeedField.value = '';
    designSpeedField.removeAttribute('data-user-edited');
  }
  const linkHealth = document.getElementById('linkHealthNote');
  if (linkHealth) {
    linkHealth.style.display = 'none';
    linkHealth.classList.remove('ok');
    linkHealth.textContent = '';
  }
  const widthVisual = document.getElementById('widthVisualBody');
  if (widthVisual) {
    widthVisual.innerHTML = 'Select a barrier and run a calculation to see widths.';
  }
}
function resetTool() { location.reload(); }

// --- STAGE 4 LOGIC ---

function goToStage3() {
  if (!canUserAccessStage('stage4')) {
    alert('External users can only view barrier and end-treatment lists.');
    return;
  }
    if (calcDirty) {
      alert('Please update calculations before proceeding.');
      return;
    }
  showOnlyStage('stage4');
    
    // Manage Buttons
    document.getElementById('toStage3Btn').style.display = 'none';
    document.getElementById('toStage4Btn').style.display = 'inline-block';
    
    // Init list if empty
    renderEndTreatments();
}

function goToStage4() {
  if (!canUserAccessStage('stage5')) {
    alert('External users can only view barrier and end-treatment lists.');
    return;
  }
    if (!selectedEndTreatment) {
        alert("Please select an end treatment first.");
        return;
    }
  showOnlyStage('stage5');
    
    // Manage Buttons
    document.getElementById('toStage4Btn').style.display = 'none';

    // Populate Details
    document.getElementById('etReviewName').innerText = selectedEndTreatment.name;
    document.getElementById('etReviewSupplier').innerText = selectedEndTreatment.supplier;
    document.getElementById('etReviewType').innerText = selectedEndTreatment.fullType || selectedEndTreatment.type;
    document.getElementById('etReviewTL').innerText = selectedEndTreatment.tl || 'N/A';
    document.getElementById('etReviewSpeed').innerText = (selectedEndTreatment.testSpeed || 0) + ' km/h';
    document.getElementById('etReviewWidth').innerText = (selectedEndTreatment.width || 0) + ' m';
    document.getElementById('etReviewLen').innerText = (selectedEndTreatment.testLen || 0) + ' m';
    document.getElementById('etReviewSpacing').innerText = selectedEndTreatment.spacing || '-';
    document.getElementById('etReviewPin').innerText = selectedEndTreatment.pinType || '-';

    renderValidationHints();
  renderWidthVisual();
}

function backToStage3() {
  showOnlyStage('stage4');
    document.getElementById('toStage4Btn').style.display = 'inline-block';
}

function goToStage7() {
  if (!canUserAccessStage('stage7')) {
    alert('External users can only view barrier and end-treatment lists.');
    return;
  }
  showOnlyStage('stage7');
    document.getElementById('actionButtons').style.display = 'none';
    
    // Init Dates if empty
    const today = new Date().toISOString().split('T')[0];
    const d1 = document.getElementById('sigDate1');
    const d2 = document.getElementById('sigDate2');
    if(d1 && !d1.value) d1.value = today;
    if(d2 && !d2.value) d2.value = today;

    renderQuickPicks();
  renderWidthVisual();
}
function backToStage4() {
  showOnlyStage('stage5');
    document.getElementById('actionButtons').style.display = 'block';
}

function handleFileSelect(input, previewId) {
    // Stage Removed
}

function backToStage2() {
  showOnlyStage('stage3');
    
    document.getElementById('toStage4Btn').style.display = 'none';
    const stage3Btn = document.getElementById('toStage3Btn');
    if(stage3Btn) stage3Btn.style.display = 'inline-block';
}

function backToStage1() {
  showOnlyStage('stage1');
    document.getElementById('resetBtn').style.display = 'none';
}

function renderEndTreatments(filterText = '') {
    const grid = document.getElementById('etGrid');
    if (!grid) return;
    grid.innerHTML = '';
    
    const term = (document.getElementById('etSearch').value || filterText).toLowerCase();
    const list = END_TREATMENTS.filter(e => 
        e.name.toLowerCase().includes(term) || 
        e.supplier.toLowerCase().includes(term)
    );
    
    if (list.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1; color:#64748b; text-align:center; padding:20px;">No matching end treatments found.</div>';
        return;
    }
    
    list.forEach(et => {
        const isSel = selectedEndTreatment && selectedEndTreatment.id === et.id;
        const el = document.createElement('div');
        el.className = `barrier-card ${isSel ? 'selected' : ''}`;
        el.style.cursor = 'pointer';
        el.onclick = () => selectEndTreatment(et.id);
        el.innerHTML = `
            <div class="barrier-header">
                <div class="barrier-title">${et.name}</div>
                <div class="barrier-supplier">${et.supplier}</div>
            </div>
            <div class="barrier-stats">
                <div class="stat-box">
                    <div class="stat-label">Type</div>
                    <div class="stat-val">${et.type}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Test Level</div>
                    <div class="stat-val">${et.tl}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Design Length</div>
                    <div class="stat-val">${et.testLen} m</div>
                </div>
            </div>
        `;
        grid.appendChild(el);
    });
}

function selectEndTreatment(id) {
    selectedEndTreatment = END_TREATMENTS.find(e => e.id === id);
    renderEndTreatments();
    
    // Show selection display
    const disp = document.getElementById('selectedEtDisplay');
    if (disp) {
        disp.style.display = 'block';
        document.getElementById('etNameSelect').innerText = selectedEndTreatment.name;
        document.getElementById('etSupplierSelect').innerText = selectedEndTreatment.supplier;

        // Tech Sheet Link
        const techBtn = document.getElementById('etTechSheetLink');
        if (selectedEndTreatment.link) {
            techBtn.href = selectedEndTreatment.link;
            techBtn.style.display = 'inline-flex';
        } else {
            techBtn.style.display = 'none';
        }

        // Manufacturer Link
        const manufBtn = document.getElementById('etManufSheetLink');
        if (selectedEndTreatment.manufLink) {
            manufBtn.href = selectedEndTreatment.manufLink;
            manufBtn.style.display = 'inline-flex';
        } else {
            manufBtn.style.display = 'none';
        }

        // Manufacturer Website
        const manufSiteBtn = document.getElementById('etManufWebsiteLink');
        const etSite = resolveManufacturerSite(selectedEndTreatment);
        if (etSite) {
          manufSiteBtn.href = etSite;
          manufSiteBtn.style.display = 'inline-flex';
        } else {
          manufSiteBtn.style.display = 'none';
        }
    }

    renderValidationHints();
    renderWidthVisual();
}

function printReport() {
  if (currentUserRole === 'planner' || currentUserRole === 'external') {
    alert('Print is available for Admin only.');
    return;
  }
  if (calcDirty) {
    alert('Please update calculations before printing.');
    return;
  }
  if (!lastCalcInputs) {
    alert('Please select a barrier and run a calculation before printing.');
    return;
  }

  const printContainer = document.getElementById('printReportOutput');
  if (!printContainer) {
    alert('Print container not found');
    return;
  }
  printContainer.innerHTML = '';

  // Helpers
  const val = id => document.getElementById(id)?.value || '';
  const text = id => document.getElementById(id)?.textContent || '';
  const num = id => {
    const n = parseFloat(text(id) || val(id));
    return isNaN(n) ? null : n;
  };
  const fmt = (n, unit = '') => (n === null ? '-' : `${n}${unit}`);

  // Gather core context
  const projName = val('projName') || '-';
  const jobNum = val('projJobNum') || '-';
  const loc = val('projLoc') || '-';
  const today = new Date().toLocaleDateString();
  const pageHeader = (title) => `
    <div style="display:flex; justify-content:space-between; align-items:flex-start; border-bottom:1px solid #d9dbe1; padding-bottom:8px; margin-bottom:12px;">
      <div>
        <div style="font-weight:800; color:#0f172a; font-size:1rem;">${title}</div>
        <div style="color:#475569; font-size:0.9rem;">${projName} · ${loc}</div>
      </div>
      <div style="text-align:right; color:#475569; font-size:0.9rem;">
        <div>Job ${jobNum}</div>
        <div>${today}</div>
      </div>
    </div>`;

  const b = selectedBarrier || {};
  const et = selectedEndTreatment || null;

  const designSpeed = val('designSpeedInput') || text('designSpeedInput') || '-';
  const siteSpeed = val('siteSpeed') || '-';
  const siteWidth = val('siteWidth') || '-';
  const mass = val('inMass') || '-';
  const angle = val('inAngle') || '-';
  const designLen = val('inDesignLength') || '-';
  const designLenNum = parseFloat(designLen);
  const etLenNum = ['designLen', 'designLength', 'len', 'length', 'testLen', 'overallLength', 'overallLen', 'lengthMeters', 'lengthMetres']
    .map(k => et?.[k])
    .find(v => Number.isFinite(v) && v > 0) || null;
  const etCount = endTreatmentEndsMode === 'both' ? 2 : 1;
  const totalLenCalc = (Number.isFinite(designLenNum) ? designLenNum : 0) + (Number.isFinite(etLenNum) ? etLenNum * etCount : 0);
  const totalLenText = Number.isFinite(totalLenCalc) && totalLenCalc > 0 ? `${totalLenCalc.toFixed(2)} m` : '-';
  const endLenText = Number.isFinite(etLenNum) ? `${etLenNum.toFixed(2)} m (×${etCount})` : '-';
  const friction = val('inFriction') || '-';

  const baseDefl = text('resBaseDefl') || '-';
  const baseWW = text('resBaseWW') || '-';
  const unitsDisp = text('resUnits') || '-';
  const designDefl = text('resDesignDefl') || '-';
  const designWW = text('resDesignWW') || '-';
  const sysWidth = val('valSystemWidth') || '-';
  const widthAllowance = val('valWidthAllowance') || '-';
  const barrierImage = b.image || resolveImage(b.name);
  const etImage = et ? (et.image || resolveImage(et.name)) : null;

  // Status badge for width check
  const availWidthNum = parseFloat(siteWidth);
  const designWWNum = parseFloat(designWW);
  const widthStatus = (!isNaN(availWidthNum) && !isNaN(designWWNum))
    ? (designWWNum <= availWidthNum ? 'PASS' : 'FAIL')
    : 'N/A';

  // Update signature values into print fields
  const sigContainer = document.getElementById('printSignatureContainer');
  if (sigContainer) {
    const designBy = document.getElementById('sigDesignedBy');
    const reviewBy = document.getElementById('sigReviewedBy');
    const date1 = document.getElementById('sigDate1');
    const date2 = document.getElementById('sigDate2');
    const printDesignBy = document.getElementById('printDesignBy');
    const printReviewBy = document.getElementById('printReviewBy');
    const printDate1 = document.getElementById('printDate1');
    const printDate2 = document.getElementById('printDate2');
    if (printDesignBy) printDesignBy.textContent = designBy ? designBy.value : '';
    if (printReviewBy) printReviewBy.textContent = reviewBy ? reviewBy.value : '';
    if (printDate1) printDate1.textContent = date1 && date1.value ? new Date(date1.value).toLocaleDateString() : '';
    if (printDate2) printDate2.textContent = date2 && date2.value ? new Date(date2.value).toLocaleDateString() : '';
  }

  const badge = (label, value, tone = 'neutral') => {
    const colors = {
      success: '#166534',
      warn: '#b45309',
      danger: '#b91c1c',
      neutral: '#334155'
    };
    const bg = {
      success: '#dcfce7',
      warn: '#fef3c7',
      danger: '#fee2e2',
      neutral: '#e2e8f0'
    };
    return `<span style="display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:0.9rem; font-weight:700; background:${bg[tone]}; color:${colors[tone]}; border:1px solid ${colors[tone]}22;">${label}: ${value}</span>`;
  };

  // COVER / SUMMARY PAGE
  const pCover = document.createElement('div');
  pCover.className = 'print-page page-break';
  pCover.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:18px;">
      <div>
        <div style="font-size:0.9rem; color:#475569; text-transform:uppercase; letter-spacing:0.08em;">Crompton Concepts</div>
        <h1 style="margin:6px 0 4px 0; font-size:1.6rem;">Barrier & End Treatment Report</h1>
        <div style="color:#64748b;">Prepared ${today}</div>
      </div>
      <div style="text-align:right;">
        ${badge('Width Check', widthStatus, widthStatus === 'PASS' ? 'success' : (widthStatus === 'FAIL' ? 'danger' : 'neutral'))}
      </div>
    </div>

    <div style="margin-bottom:16px; padding:12px; border:1px solid #e2e8f0; border-radius:10px; background:#f8fafc;">
      <table style="width:100%; border-collapse:collapse; font-size:11pt;">
        <tr>
          <td style="padding:4px; font-weight:600; color:#475569; width:120px;">Project</td>
          <td style="padding:4px; font-weight:700;">${projName}</td>
          <td style="padding:4px; font-weight:600; color:#475569; width:90px;">Job #</td>
          <td style="padding:4px;">${jobNum}</td>
        </tr>
        <tr>
          <td style="padding:4px; font-weight:600; color:#475569;">Location</td>
          <td style="padding:4px;" colspan="3">${loc}</td>
        </tr>
      </table>
    </div>

    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:10px; margin-bottom:16px;">
      <div style="padding:10px; border:1px solid #e2e8f0; border-radius:10px; background:#fff;">
        <div style="font-weight:700; color:#0f172a;">Barrier</div>
        <div style="color:#475569;">${b.name || '-'}</div>
        <div style="color:#475569; font-size:0.9rem;">${b.supplier || ''}</div>
      </div>
      <div style="padding:10px; border:1px solid #e2e8f0; border-radius:10px; background:#fff;">
        <div style="font-weight:700; color:#0f172a;">End Treatment</div>
        <div style="color:#475569;">${et ? et.name : 'Not selected'}</div>
        <div style="color:#475569; font-size:0.9rem;">${et ? et.supplier : ''}</div>
      </div>
      <div style="padding:10px; border:1px solid #e2e8f0; border-radius:10px; background:#fff;">
        <div style="font-weight:700; color:#0f172a;">Design Speed</div>
        <div style="color:#475569;">${designSpeed || siteSpeed || '-'} km/h</div>
        <div style="font-size:0.9rem; color:#94a3b8;">Test speed input ${siteSpeed || '-'} km/h</div>
      </div>
      <div style="padding:10px; border:1px solid #e2e8f0; border-radius:10px; background:#fff;">
        <div style="font-weight:700; color:#0f172a;">Available Width</div>
        <div style="color:#475569;">${siteWidth || '-'} m</div>
        <div style="font-size:0.9rem; color:#94a3b8;">Design WW ${designWW || '-'} m</div>
      </div>
    </div>
  `;
  printContainer.appendChild(pCover);

  // PAGE 2: Inputs & Results Snapshot
  const pInputs = document.createElement('div');
  pInputs.className = 'print-page page-break';
  pInputs.innerHTML = `
    ${pageHeader('Inputs & Results')}
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:12px; margin:4px 0 18px 0;">
      <div style="border:1px solid #e2e8f0; border-radius:10px; padding:10px;">
        <div style="font-weight:700; color:#0f172a;">Impact Inputs</div>
        <div style="color:#475569;">Mass: ${mass} kg</div>
        <div style="color:#475569;">Angle: ${angle}°</div>
        <div style="color:#475569;">Design Speed: ${designSpeed || siteSpeed || '-'} km/h</div>
      </div>
      <div style="border:1px solid #e2e8f0; border-radius:10px; padding:10px;">
        <div style="font-weight:700; color:#0f172a;">Geometry</div>
        <div style="color:#475569;">Barrier Design Length: ${designLen} m</div>
        <div style="color:#475569;">End Treatment Length: ${endLenText}</div>
        <div style="color:#475569;">Total Length (Barrier + Ends): ${totalLenText}</div>
        <div style="color:#475569;">Available Width: ${siteWidth || '-'} m</div>
        <div style="color:#475569;">Friction: ${friction}</div>
      </div>
      <div style="border:1px solid #e2e8f0; border-radius:10px; padding:10px;">
        <div style="font-weight:700; color:#0f172a;">Barrier Tested</div>
        <div style="color:#475569;">TL: ${b.tl || '-'}</div>
        <div style="color:#475569;">Test Speed: ${b.testSpeed || '-'} km/h</div>
        <div style="color:#475569;">Test Length: ${b.testLen || '-'} m</div>
        <div style="color:#475569;">System Width: ${sysWidth} m</div>
      </div>
      <div style="border:1px solid #e2e8f0; border-radius:10px; padding:10px;">
        <div style="font-weight:700; color:#0f172a;">Links</div>
        <div style="color:#475569;">Austroads: ${b.link ? 'Provided' : 'Missing'}</div>
        <div style="color:#475569;">Manufacturer: ${(b.manufLink || b.specLink) ? 'Provided' : 'Missing'}</div>
      </div>
    </div>

    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:10px;">
      <div style="border:1px solid #e2e8f0; border-radius:10px; padding:12px; background:#fff;">
        <div style="font-weight:700; color:#0f172a;">Base Results</div>
        <div style="color:#475569;">Deflection: ${baseDefl}</div>
        <div style="color:#475569;">Working Width: ${baseWW}</div>
      </div>
      <div style="border:1px solid #e2e8f0; border-radius:10px; padding:12px; background:#fff;">
        <div style="font-weight:700; color:#0f172a;">Design Results</div>
        <div style="color:#475569;">Deflection: ${designDefl}</div>
        <div style="color:#475569;">Working Width: ${designWW}</div>
        <div style="color:#475569;">Units Displaced: ${unitsDisp}</div>
      </div>
      <div style="border:1px solid #e2e8f0; border-radius:10px; padding:12px; background:#fff;">
        <div style="font-weight:700; color:#0f172a;">Width Allowance</div>
        <div style="color:#475569;">System + Defl: ${widthAllowance} m</div>
        <div style="color:#475569;">Available: ${siteWidth || '-'} m</div>
        <div style="color:${widthStatus === 'FAIL' ? '#b91c1c' : '#166534'}; font-weight:700;">${widthStatus}</div>
      </div>
    </div>
  `;
  printContainer.appendChild(pInputs);

  // PAGE 3: Barrier Details & Links
  const pBarrier = document.createElement('div');
  pBarrier.className = 'print-page page-break';
  const bLink = b.link || '';
  const bSpec = b.specLink || b.manufLink || '';
  const bSite = resolveManufacturerSite(b) || '';
  pBarrier.innerHTML = `
    ${pageHeader('Barrier Details')}
    <div style="display:flex; gap:16px; align-items:flex-start; margin:12px 0 18px 0;">
      <div style="width:140px; height:110px; border:1px solid #e2e8f0; border-radius:10px; background:#fff; display:flex; align-items:center; justify-content:center; overflow:hidden;">
        ${barrierImage ? `<img src="${barrierImage}" alt="${b.name || 'Barrier'}" style="max-width:100%; max-height:100%; object-fit:contain;">` : '<div style="color:#94a3b8; font-size:0.85rem; text-align:center; padding:6px;">No image</div>'}
      </div>
      <div style="flex:1;">
        <div style="font-weight:800; font-size:1.1rem; color:#0f172a;">${b.name || '-'}</div>
        <div style="color:#475569; margin-bottom:8px;">${b.supplier || ''}</div>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); gap:8px; font-size:0.95rem; color:#334155;">
          <div><strong>TL:</strong> ${b.tl || '-'}</div>
          <div><strong>Test Speed:</strong> ${b.testSpeed || '-'} km/h</div>
          <div><strong>Deflection:</strong> ${b.defl || '-'} m</div>
          <div><strong>Working Width:</strong> ${b.ww || '-'} m</div>
          <div><strong>System Width:</strong> ${b.width || '-'} m</div>
          <div><strong>Test Length:</strong> ${b.testLen || '-'} m</div>
        </div>
      </div>
    </div>
    ${(bLink || bSpec || bSite) ? `
    <div style="margin-top:12px; padding:14px; border:1px solid #e2e8f0; border-radius:10px; background:#f8fafc;">
      <div style="font-weight:700; color:#0f172a; margin-bottom:6px;">Technical Links</div>
      ${bLink ? `<div style="margin-bottom:6px;"><strong>Austroads / TCU:</strong> <a href="${bLink}" target="_blank" style="color:#0284c7; word-break:break-all;">${bLink}</a></div>` : ''}
      ${bSpec ? `<div style="margin-bottom:6px;"><strong>Manufacturer Spec:</strong> <a href="${bSpec}" target="_blank" style="color:#0284c7; word-break:break-all;">${bSpec}</a></div>` : ''}
      ${bSite ? `<div style="margin-bottom:6px;"><strong>Website:</strong> <a href="${bSite}" target="_blank" style="color:#0284c7; word-break:break-all;">${bSite}</a></div>` : ''}
    </div>
    ` : ''}
  `;
  printContainer.appendChild(pBarrier);

  // PAGE 4: End Treatment (if any)
  const pET = document.createElement('div');
  pET.className = 'print-page page-break';
  if (et) {
    const etLink = et.link || '';
    const etSpec = et.manufLink || '';
    const etSite = resolveManufacturerSite(et) || '';
    pET.innerHTML = `
      ${pageHeader('End Treatment')}
      <div style="display:flex; gap:16px; align-items:flex-start; margin:12px 0 18px 0;">
        <div style="width:140px; height:110px; border:1px solid #e2e8f0; border-radius:10px; background:#fff; display:flex; align-items:center; justify-content:center; overflow:hidden;">
          ${etImage ? `<img src="${etImage}" alt="${et.name}" style="max-width:100%; max-height:100%; object-fit:contain;">` : '<div style="color:#94a3b8; font-size:0.85rem; text-align:center; padding:6px;">No image</div>'}
        </div>
        <div style="flex:1;">
          <div style="font-weight:800; font-size:1.1rem; color:#0f172a;">${et.name}</div>
          <div style="color:#475569; margin-bottom:8px;">${et.supplier || ''}</div>
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); gap:8px; font-size:0.95rem; color:#334155;">
            <div><strong>Type:</strong> ${et.fullType || et.type || '-'}</div>
            <div><strong>MASH TL:</strong> ${et.tl || '-'}</div>
            <div><strong>Test Speed:</strong> ${et.testSpeed || '-'} km/h</div>
            <div><strong>System Width:</strong> ${et.width || '-'} m</div>
            <div><strong>Test Length:</strong> ${et.testLen || '-'} m</div>
          </div>
        </div>
      </div>
      ${(etLink || etSpec || etSite) ? `
      <div style="margin-top:12px; padding:14px; border:1px solid #e2e8f0; border-radius:10px; background:#f8fafc;">
        <div style="font-weight:700; color:#0f172a; margin-bottom:6px;">Technical Links</div>
        ${etLink ? `<div style="margin-bottom:6px;"><strong>Austroads / TCU:</strong> <a href="${etLink}" target="_blank" style="color:#0284c7; word-break:break-all;">${etLink}</a></div>` : ''}
        ${etSpec ? `<div style="margin-bottom:6px;"><strong>Manufacturer Spec:</strong> <a href="${etSpec}" target="_blank" style="color:#0284c7; word-break:break-all;">${etSpec}</a></div>` : ''}
        ${etSite ? `<div style="margin-bottom:6px;"><strong>Website:</strong> <a href="${etSite}" target="_blank" style="color:#0284c7; word-break:break-all;">${etSite}</a></div>` : ''}
      </div>
      ` : ''}
    `;
  } else {
    pET.innerHTML = `<h2 style="border-bottom:2px solid #000; padding-bottom:6px;">End Treatment</h2><div style="padding:30px; color:#64748b; font-style:italic;">No end treatment selected.</div>`;
  }
  printContainer.appendChild(pET);

  // PAGE 5: Matrices (combined)
  if (lastCalcInputs) {
    const pMatrix = document.createElement('div');
    pMatrix.className = 'print-page page-break';
    pMatrix.innerHTML = `
      ${pageHeader('Analysis Matrices')}
      <h3 style="margin:10px 0 6px 0;">Deflection</h3>
      ${buildMatrixHTML(lastCalcInputs, 'deflection', true)}
      <div style="height:12px;"></div>
      <h3 style="margin:10px 0 6px 0;">Working Width</h3>
      ${buildMatrixHTML(lastCalcInputs, 'ww', true)}
    `;
    printContainer.appendChild(pMatrix);
  }

  // PAGE 6: Sign-off
  const pSign = document.createElement('div');
  pSign.className = 'print-page page-break';
  pSign.innerHTML = `${pageHeader('Sign-off')}`;
  const sigSection = sigContainer ? sigContainer.querySelector('.signature-section') : null;
  if (sigSection) {
    const clone = sigSection.cloneNode(true);
    clone.style.marginTop = '24px';
    pSign.appendChild(clone);
  } else {
    pSign.innerHTML += `<div style="padding:20px; color:#64748b; font-style:italic;">Signature section not found.</div>`;
  }
  printContainer.appendChild(pSign);

  window.print();
}

// ============================================
// PDF UPLOAD AND PARSING FUNCTIONS
// ============================================

/**
 * Handle PDF file upload
 */
async function handlePDFUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const statusDiv = document.getElementById('pdfUploadStatus');
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<p style="margin:0; color:var(--primary);"><strong>⏳ Processing PDF...</strong> Please wait while we extract the risk assessment data.</p>';
    
    try {
        // Read file as ArrayBuffer
        const arrayBuffer = await file.arrayBuffer();
        
        // Load PDF
        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
        
      // Extract text from all pages with layout-aware spacing
      const fullText = await extractPdfTextWithLayout(pdf);
        
        // Parse the extracted text
        const parsedData = parseRiskAssessmentText(fullText);
        
        if (parsedData.length > 0) {
            // Clear existing rows
            clearRiskTable();
            
            // Populate table with parsed data
            parsedData.forEach(risk => {
                addRiskRowWithData(
                    risk.hazard,
                    risk.impact,
                    risk.initLikelihood,
                    risk.initConsequence,
                    risk.controls,
                    risk.resLikelihood,
                    risk.resConsequence,
                    risk.owner
                );
            });
            
            statusDiv.innerHTML = `<p style="margin:0; color:var(--success-color);"><strong>✅ Success!</strong> Imported ${parsedData.length} risk factor(s) from the PDF. Check browser console (F12) for detailed parsing information.</p>`;
            
            // Update summary
            updateRiskSummary();
            
            // Hide status after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        } else {
            statusDiv.innerHTML = `
                <p style="margin:0; color:var(--warning-color); margin-bottom:8px;"><strong>⚠️ No data found.</strong> The PDF doesn't appear to contain a standard risk assessment table.</p>
                <details style="font-size:0.85rem; color:var(--text-sub);">
                    <summary style="cursor:pointer; color:var(--primary); font-weight:600;">🔍 View Extracted Text Preview</summary>
                    <div style="margin-top:8px; padding:12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; max-height:200px; overflow-y:auto; font-family:monospace; font-size:0.75rem; white-space:pre-wrap;">${fullText.substring(0, 1000)}${fullText.length > 1000 ? '...\n\n[Text truncated. Check browser console (F12) for full content]' : ''}</div>
                    <p style="margin-top:8px; font-size:0.8rem;">💡 <strong>Tip:</strong> Open browser console (press F12) to see detailed parsing debug information.</p>
                </details>
            `;
            console.log('Full extracted text:', fullText);
        }
        
    } catch (error) {
        console.error('PDF parsing error:', error);
        statusDiv.innerHTML = '<p style="margin:0; color:var(--danger-color);"><strong>❌ Error!</strong> Failed to process the PDF. Please ensure it\'s a valid PDF file and try again.</p>';
    }
    
    // Clear file input
    event.target.value = '';
}

  /**
   * Handle HTML report upload (generated by this tool)
   */
  async function handleReportUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const statusDiv = document.getElementById('pdfUploadStatus');
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<p style="margin:0; color:var(--primary);"><strong>⏳ Processing report...</strong> Please wait while we extract the risk register.</p>';

    try {
      const htmlText = await file.text();
      const parsedData = parseRiskReportHtml(htmlText);

      if (parsedData.length > 0) {
        clearRiskTable();
        parsedData.forEach(risk => {
          addRiskRowWithData(
            risk.hazard,
            risk.impact,
            risk.initLikelihood,
            risk.initConsequence,
            risk.controls,
            risk.resLikelihood,
            risk.resConsequence,
            risk.owner
          );
        });

        statusDiv.innerHTML = `<p style="margin:0; color:var(--success-color);"><strong>✅ Success!</strong> Imported ${parsedData.length} risk factor(s) from the report HTML.</p>`;
        updateRiskSummary();
        setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
      } else {
        statusDiv.innerHTML = `
          <p style="margin:0; color:var(--warning-color); margin-bottom:8px;"><strong>⚠️ No data found.</strong> The report HTML doesn't appear to contain a risk register table.</p>
          <details style="font-size:0.85rem; color:var(--text-sub);">
            <summary style="cursor:pointer; color:var(--primary); font-weight:600;">🔍 View Extracted Text Preview</summary>
            <div style="margin-top:8px; padding:12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; max-height:200px; overflow-y:auto; font-family:monospace; font-size:0.75rem; white-space:pre-wrap;">${htmlText.substring(0, 1000)}${htmlText.length > 1000 ? '...\n\n[Text truncated. Check browser console (F12) for full content]' : ''}</div>
          </details>
        `;
        console.log('Full HTML text:', htmlText);
      }
    } catch (error) {
      console.error('Report parsing error:', error);
      statusDiv.innerHTML = '<p style="margin:0; color:var(--danger-color);"><strong>❌ Error!</strong> Failed to process the report file. Please ensure it\'s a valid HTML file and try again.</p>';
    }

    event.target.value = '';
  }

  /**
   * Export risk register as JSON (round-trip safe)
   */
  function exportRiskRegisterJson() {
    const data = buildRiskRegisterSnapshot();
    const payload = {
      version: 1,
      exportedAt: new Date().toISOString(),
      project: {
        name: document.getElementById('riskProjectName')?.value || '',
        location: document.getElementById('riskLocation')?.value || '',
        date: document.getElementById('riskDate')?.value || '',
        docRef: document.getElementById('riskDocRef')?.value || '',
        refDrawings: document.getElementById('riskRefDrawings')?.value || ''
      },
      notes: document.getElementById('riskNotes')?.value || '',
      notesFormat: document.getElementById('riskNotesFormat')?.value || 'paragraph',
      risks: data
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `risk-register-${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
  }

  /**
   * Import risk register JSON
   */
  async function handleRiskJsonUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const statusDiv = document.getElementById('pdfUploadStatus');
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<p style="margin:0; color:var(--primary);"><strong>⏳ Importing JSON...</strong> Please wait while we load your risk register.</p>';

    try {
      const text = await file.text();
      const payload = JSON.parse(text);

      if (!payload || !Array.isArray(payload.risks)) {
        throw new Error('Invalid JSON format.');
      }

      clearRiskTable();

      // Restore metadata if present
      if (payload.project) {
        const { name, location, date, docRef, refDrawings } = payload.project;
        if (document.getElementById('riskProjectName')) document.getElementById('riskProjectName').value = name || '';
        if (document.getElementById('riskLocation')) document.getElementById('riskLocation').value = location || '';
        if (document.getElementById('riskDate')) document.getElementById('riskDate').value = date || '';
        if (document.getElementById('riskDocRef')) document.getElementById('riskDocRef').value = docRef || '';
        if (document.getElementById('riskRefDrawings')) document.getElementById('riskRefDrawings').value = refDrawings || '';
      }
      if (payload.notes && document.getElementById('riskNotes')) {
        document.getElementById('riskNotes').value = payload.notes;
      }
      if (payload.notesFormat && document.getElementById('riskNotesFormat')) {
        document.getElementById('riskNotesFormat').value = payload.notesFormat;
      }

      payload.risks.forEach(risk => {
        addRiskRowWithData(
          risk.hazard || '',
          risk.impact || '',
          risk.initLikelihood || '',
          risk.initConsequence || '',
          risk.controls || [],
          risk.resLikelihood || '',
          risk.resConsequence || '',
          risk.owner || ''
        );
      });

      statusDiv.innerHTML = `<p style="margin:0; color:var(--success-color);"><strong>✅ Success!</strong> Imported ${payload.risks.length} risk factor(s) from JSON.</p>`;
      updateRiskSummary();
      setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
    } catch (error) {
      console.error('JSON import error:', error);
      statusDiv.innerHTML = '<p style="margin:0; color:var(--danger-color);"><strong>❌ Error!</strong> Failed to import JSON. Please ensure it\'s a valid export from this tool.</p>';
    }

    event.target.value = '';
  }

  /**
   * Build risk register snapshot from current table
   */
  function buildRiskRegisterSnapshot() {
    const tableBody = document.getElementById('riskTableBody');
    if (!tableBody) return [];

    const rows = Array.from(tableBody.querySelectorAll('tr'));
    const controlTypes = ['Elimination', 'Substitution', 'Engineering', 'Administrative', 'PPE'];

    return rows.map(row => {
      const textareas = row.querySelectorAll('textarea');
      const selects = row.querySelectorAll('select');
      const inputs = row.querySelectorAll('input[type="text"]');
      const checkboxes = row.querySelectorAll('input[type="checkbox"]');

      const hazard = textareas[0]?.value || '';
      const impact = textareas[1]?.value || '';
      const owner = inputs[0]?.value || '';

      const initLikelihood = selects[0]?.value || '';
      const initConsequence = selects[1]?.value || '';
      const resLikelihood = selects[3]?.value || '';
      const resConsequence = selects[4]?.value || '';

      const controls = [];
      checkboxes.forEach((cb, idx) => {
        if (cb.checked) {
          const desc = cb.parentElement.querySelector('textarea')?.value || '';
          controls.push({
            type: controlTypes[idx],
            description: desc
          });
        }
      });

      return {
        hazard,
        impact,
        initLikelihood,
        initConsequence,
        controls,
        resLikelihood,
        resConsequence,
        owner
      };
    }).filter(r => r.hazard || r.impact || r.initLikelihood || r.initConsequence || r.owner);
  }

/**
 * Extract PDF text preserving row/column spacing as much as possible
 */
async function extractPdfTextWithLayout(pdf) {
  let fullText = '';

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const pageText = await extractPageTextWithLayout(page);
    fullText += pageText + '\n';
  }

  return fullText;
}

/**
 * Build page text lines from PDF text items using x/y positions
 */
async function extractPageTextWithLayout(page) {
  const textContent = await page.getTextContent();
  const items = textContent.items
    .filter(item => item.str && item.str.trim().length)
    .map(item => ({
      str: item.str.trim(),
      x: item.transform[4],
      y: item.transform[5]
    }));

  items.sort((a, b) => (b.y - a.y) || (a.x - b.x));

  const lineThreshold = 2.5;
  const lines = [];
  let currentLine = [];
  let currentY = null;

  const pushLine = () => {
    if (!currentLine.length) return;
    currentLine.sort((a, b) => a.x - b.x);
    let line = '';
    let lastX = null;
    currentLine.forEach(item => {
      if (lastX !== null) {
        const gap = item.x - lastX;
        line += gap > 18 ? '  ' : ' ';
      }
      line += item.str;
      lastX = item.x;
    });
    if (line.trim()) lines.push(line.trim());
  };

  items.forEach(item => {
    if (currentY === null || Math.abs(item.y - currentY) <= lineThreshold) {
      currentLine.push(item);
      if (currentY === null) currentY = item.y;
    } else {
      pushLine();
      currentLine = [item];
      currentY = item.y;
    }
  });
  pushLine();

  return lines.join('\n');
}

/**
 * Parse extracted text from PDF to identify risk assessment data
 * Smart parser that handles multiple PDF formats and layouts
 */
function parseRiskAssessmentText(text) {
    console.log('=== PDF PARSING DEBUG ===');
    console.log('Total text length:', text.length);
    console.log('First 1000 characters:', text.substring(0, 1000));
    
    const risks = [];
    
  // Normalize text while preserving column spacing
  text = text.replace(/\u00a0/g, ' ');
  text = text.replace(/\t/g, '  ');
  text = text.replace(/\r/g, '\n');
  text = text.replace(/[ ]{3,}/g, '  ');
    
  // Split by newlines
  let lines = text.split(/\n+/);
    
    console.log('Total lines found:', lines.length);

  // First, try to parse the report's Risk Register table format
  const reportRisks = parseRiskRegisterSection(lines);
  if (reportRisks.length > 0) {
    console.log('Parsed risks from Risk Register section:', reportRisks.length);
    return reportRisks;
  }
    
    // Find table header row to understand column structure
    let headerIndex = -1;
    let columnOrder = {};
    
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].toLowerCase();
        
        // Look for header keywords
        if ((line.includes('hazard') || line.includes('risk')) && 
            (line.includes('likelihood') || line.includes('consequence'))) {
            headerIndex = i;
            console.log('Found header at line', i, ':', lines[i]);
            
            // Try to determine column positions
            const headerText = lines[i].toLowerCase();
            columnOrder.hazardPos = headerText.indexOf('hazard') >= 0 || headerText.indexOf('risk') >= 0;
            columnOrder.impactPos = headerText.indexOf('impact') >= 0 || headerText.indexOf('consequence') >= 0;
            
            break;
        }
    }
    
    // If header found, parse data rows
    if (headerIndex >= 0) {
        console.log('Processing rows after header...');
        
        for (let i = headerIndex + 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line || line.length < 5) continue;
            
            // Skip common footer/header text
            if (line.toLowerCase().includes('page ') || 
                line.toLowerCase().includes('total') ||
                line.toLowerCase().includes('risk matrix') ||
                line.toLowerCase().includes('likelihood scale') ||
                line.toLowerCase().includes('consequence scale')) {
                continue;
            }
            
            console.log('Processing line', i, ':', line.substring(0, 100));
            
            // Try multiple splitting strategies
            let fields = [];
            
            // Strategy 1: Split by pipe |
            if (line.includes('|')) {
                fields = line.split('|').map(f => f.trim());
            }
            // Strategy 2: Split by tabs
            else if (line.includes('\t')) {
                fields = line.split('\t').map(f => f.trim());
            }
            // Strategy 3: Split by 2+ spaces
            else if (line.match(/\s{2,}/)) {
                fields = line.split(/\s{2,}/).map(f => f.trim());
            }
            // Strategy 4: Smart split - look for number patterns
            else {
                fields = smartSplitRiskRow(line);
            }
            
            console.log('Fields extracted:', fields.length, fields);
            
            // Need at least hazard and some rating
            if (fields.length >= 3) {
                // Filter out S.N. or row numbers from first field
                let hazardField = fields[0];
                
                // Remove leading numbers like "1.", "2)", "1 ", etc.
                hazardField = hazardField.replace(/^\d+[\.\)\s]+/, '').trim();
                
                // Skip if still just a number or empty
                if (!hazardField || /^\d+$/.test(hazardField) || hazardField.length < 3) {
                    hazardField = fields.length > 1 ? fields[1] : '';
                    fields.shift(); // Remove first field
                }
                
                if (hazardField && hazardField.length >= 3) {
                    const risk = extractRiskFromFields(fields, hazardField);
                    if (risk) {
                        risks.push(risk);
                        console.log('Added risk:', risk.hazard);
                    }
                }
            }
        }
    } else {
        // No clear header found - try aggressive pattern matching
        console.log('No header found, trying pattern matching...');
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line.length < 10) continue;
            
            // Look for lines that might be risk entries (contain numbers and text)
            if (/[a-zA-Z]+.*\d/.test(line) && !line.toLowerCase().includes('page')) {
                const fields = smartSplitRiskRow(line);
                if (fields.length >= 3) {
                    let hazardField = fields[0].replace(/^\d+[\.\)\s]+/, '').trim();
                    if (hazardField.length >= 3) {
                        const risk = extractRiskFromFields(fields, hazardField);
                        if (risk) {
                            risks.push(risk);
                            console.log('Pattern matched risk:', risk.hazard);
                        }
                    }
                }
            }
        }
    }
    
    console.log('Total risks extracted:', risks.length);
    console.log('=== END DEBUG ===');
    
    return risks;
}

/**
 * Parse report HTML generated by this tool (Risk Register table)
 */
function parseRiskReportHtml(htmlText) {
  const risks = [];
  if (!htmlText) return risks;

  const parser = new DOMParser();
  const doc = parser.parseFromString(htmlText, 'text/html');

  const tables = Array.from(doc.querySelectorAll('table'));
  let riskTable = null;

  for (const table of tables) {
    const headerText = table.querySelector('thead')?.innerText || table.innerText || '';
    if (/Hazard\s*\/\s*Risk/i.test(headerText) && /Risk Owner/i.test(headerText)) {
      riskTable = table;
      break;
    }
  }

  if (!riskTable) return risks;

  const rows = Array.from(riskTable.querySelectorAll('tbody tr'));
  rows.forEach(row => {
    const cells = Array.from(row.querySelectorAll('td'));
    if (cells.length < 10) return;

    const hazard = cells[1]?.innerText.trim() || '';
    const impact = cells[2]?.innerText.trim() || '';
    const initLikelihood = extractNumber(cells[3]?.innerText || '');
    const initConsequence = extractNumber(cells[4]?.innerText || '');
    const controlsText = cells[6]?.innerText || '';
    const resLikelihood = extractNumber(cells[7]?.innerText || '');
    const resConsequence = extractNumber(cells[8]?.innerText || '');
    const owner = cells[10]?.innerText.trim() || '';

    const controls = parseControlsFromText(controlsText);

    if (hazard) {
      risks.push({
        hazard,
        impact,
        initLikelihood,
        initConsequence,
        controls,
        resLikelihood,
        resConsequence,
        owner
      });
    }
  });

  return risks;
}

/**
 * Parse controls from formatted report text
 */
function parseControlsFromText(text) {
  const controlTypes = ['Elimination', 'Substitution', 'Engineering', 'Administrative', 'PPE'];
  if (!text || text.trim() === '-' || text.trim().length === 0) return [];

  const normalized = text.replace(/\s+/g, ' ').trim();
  const controls = [];

  controlTypes.forEach((type, idx) => {
    const pattern = new RegExp(`${type}\s*:\\s*`, 'i');
    const match = normalized.match(pattern);
    if (!match) return;

    const start = normalized.toLowerCase().indexOf(type.toLowerCase() + ':');
    if (start === -1) return;
    let end = normalized.length;
    for (let j = idx + 1; j < controlTypes.length; j++) {
      const nextType = controlTypes[j];
      const nextIdx = normalized.toLowerCase().indexOf(nextType.toLowerCase() + ':', start + type.length);
      if (nextIdx !== -1) {
        end = nextIdx;
        break;
      }
    }
    const segment = normalized.substring(start + type.length + 1, end).trim();
    if (segment) {
      controls.push({ type, description: segment });
    }
  });

  if (controls.length > 0) return controls;
  return [{ type: 'Administrative', description: normalized }];
}

  /**
   * Parse the Risk Register table from the generated report PDF
   */
  function parseRiskRegisterSection(lines) {
    const risks = [];
    let headerIndex = -1;

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].toLowerCase();
      if (line.includes('hazard') && line.includes('risk owner') && line.includes('residual risk')) {
        headerIndex = i;
        console.log('Found Risk Register header at line', i, ':', lines[i]);
        break;
      }
    }

    if (headerIndex < 0) return risks;

    for (let i = headerIndex + 1; i < lines.length; i++) {
      const rawLine = lines[i];
      const line = rawLine.trim();
      if (!line) continue;

      if (/risk assessment notes|sign[-\s]?off|rating scales|risk levels|risk matrix/i.test(line)) {
        break;
      }

      if (/^s\.?n\.?/i.test(line)) continue;
      if (!/^\d+\b/.test(line)) continue;

      let risk = null;

      // Attempt column split using double spaces
      const tokens = line.split(/\s{2,}/).map(t => t.trim()).filter(Boolean);
      if (tokens.length >= 11) {
        const endIdx = tokens.length - 1;
        const resRiskToken = tokens[endIdx - 1] || '';
        const resConsequenceToken = tokens[endIdx - 2] || '';
        const resLikelihoodToken = tokens[endIdx - 3] || '';
        const controlsTokens = tokens.slice(6, endIdx - 3);

        risk = {
          hazard: tokens[1] || '',
          impact: tokens[2] || '',
          initLikelihood: extractNumber(tokens[3]),
          initConsequence: extractNumber(tokens[4]),
          controls: controlsTokens.join(' ') ? [controlsTokens.join(' ')] : [],
          resLikelihood: extractNumber(resLikelihoodToken),
          resConsequence: extractNumber(resConsequenceToken),
          owner: tokens.slice(endIdx).join(' ') || ''
        };
      } else {
        risk = tryParseRiskRegisterLine(line);
      }

      if (risk && risk.hazard && (risk.initLikelihood || risk.initConsequence)) {
        risks.push(risk);
      }
    }

    return risks;
  }

  /**
   * Fallback parser for Risk Register lines when columns are not preserved
   */
  function tryParseRiskRegisterLine(line) {
    const likelihoodPattern = '(Rare|Unlikely|Possible|Likely|Almost\\s+Certain|Certain)';
    const consequencePattern = '(Insignificant|Minor|Moderate|Major|Catastrophic|Severe)';
    const riskLevelPattern = '(Low|Medium|High|Critical)';

    const rowRegex = new RegExp(
      '^\\s*(\\d+)\\s+(.*?)\\s+(.*?)\\s+(' + likelihoodPattern + ')\\s+(' + consequencePattern + ')\\s+(' + riskLevelPattern + ')\\s+(.*?)\\s+(' + likelihoodPattern + ')\\s+(' + consequencePattern + ')\\s+(' + riskLevelPattern + ')\\s+(.*)$',
      'i'
    );

    const match = line.match(rowRegex);
    if (!match) return null;

    return {
      hazard: match[2]?.trim() || '',
      impact: match[3]?.trim() || '',
      initLikelihood: extractNumber(match[4]),
      initConsequence: extractNumber(match[5]),
      controls: match[7]?.trim() ? [match[7].trim()] : [],
      resLikelihood: extractNumber(match[8]),
      resConsequence: extractNumber(match[9]),
      owner: match[11]?.trim() || ''
    };
  }

/**
 * Smart split for risk row - identifies fields based on patterns
 */
function smartSplitRiskRow(line) {
    const fields = [];
    
    // Pattern: text followed by numbers
    // Example: "Vehicle collision 4 5 Barriers 2 3 Manager"
    
    // Find all number sequences (1-5 or rating text)
    const numberPattern = /\b([1-5])\b|rare|unlikely|possible|likely|certain|insignificant|minor|moderate|major|catastrophic/gi;
    const matches = [];
    let match;
    
    while ((match = numberPattern.exec(line)) !== null) {
        matches.push({ value: match[0], index: match.index });
    }
    
    if (matches.length >= 2) {
        // Extract hazard (text before first number)
        const hazard = line.substring(0, matches[0].index).trim();
        if (hazard) fields.push(hazard);
        
        // Extract numbers/ratings
        for (let i = 0; i < matches.length; i++) {
            fields.push(matches[i].value);
        }
        
        // Extract text after numbers (controls/owner)
        if (matches.length > 0) {
            const lastMatch = matches[matches.length - 1];
            const remainingText = line.substring(lastMatch.index + lastMatch.value.length).trim();
            if (remainingText) {
                // Split remaining by multiple spaces or other delimiters
                const parts = remainingText.split(/\s{2,}/).filter(p => p.trim());
                fields.push(...parts);
            }
        }
    } else {
        // Fallback: split by multiple spaces
        return line.split(/\s{2,}/).map(f => f.trim()).filter(f => f);
    }
    
    return fields;
}

/**
 * Extract risk object from parsed fields
 */
function extractRiskFromFields(fields, hazardField) {
    if (!hazardField || hazardField.length < 3) return null;
    
    // Expected structure (flexible):
    // [0] = Hazard/Risk
    // [1] = Impact/Consequence (optional)
    // [2] = Initial Likelihood
    // [3] = Initial Consequence
    // [4] = Controls
    // [5] = Residual Likelihood
    // [6] = Residual Consequence
    // [7] = Owner
    
    let fieldIndex = fields.indexOf(hazardField);
    if (fieldIndex === -1) fieldIndex = 0;
    
    const risk = {
        hazard: hazardField,
        impact: '',
        initLikelihood: '',
        initConsequence: '',
        controls: [],
        resLikelihood: '',
        resConsequence: '',
        owner: ''
    };
    
    // Extract remaining fields after hazard
    const remainingFields = fields.slice(fieldIndex + 1);
    
    // Look for numbers and text
    let numberCount = 0;
    let controlsText = '';
    let ownerText = '';
    
    for (let i = 0; i < remainingFields.length; i++) {
        const field = remainingFields[i];
        const extracted = extractNumber(field);
        
        if (extracted && numberCount < 4) {
            // Assign to likelihood/consequence in order
            if (numberCount === 0) risk.initLikelihood = extracted;
            else if (numberCount === 1) risk.initConsequence = extracted;
            else if (numberCount === 2) risk.resLikelihood = extracted;
            else if (numberCount === 3) risk.resConsequence = extracted;
            numberCount++;
        } else if (field && field.length > 2 && !/^\d+$/.test(field)) {
            // Text field - could be impact, controls, or owner
            if (!risk.impact && i === 0 && numberCount === 0) {
                risk.impact = field;
            } else if (numberCount >= 2 && !controlsText) {
                controlsText = field;
            } else if (numberCount >= 4 || (controlsText && numberCount >= 2)) {
                ownerText = field;
                break;
            } else if (numberCount >= 1 && !controlsText) {
                controlsText = field;
            }
        }
    }
    
    if (controlsText) risk.controls = [controlsText];
    if (ownerText) risk.owner = ownerText;
    
    // If we have at least hazard and some likelihood/consequence, it's valid
    if (risk.hazard && (risk.initLikelihood || risk.initConsequence)) {
        return risk;
    }
    
    return null;
}

/**
 * Extract numeric value from text (1-5 for likelihood/consequence)
 */
function extractNumber(text) {
    if (!text) return '';
    
    // Direct number
    const match = text.match(/\d+/);
    if (match) {
        const num = parseInt(match[0]);
        if (num >= 1 && num <= 5) return num.toString();
    }
    
    // Text to number mapping
    const textLower = text.toLowerCase();
    const likelihoodMap = {
        'rare': '1',
        'unlikely': '2',
        'possible': '3',
        'likely': '4',
        'almost certain': '5',
        'certain': '5'
    };
    
    const consequenceMap = {
        'insignificant': '1',
        'minor': '2',
        'moderate': '3',
        'major': '4',
        'catastrophic': '5',
        'severe': '5'
    };
    
    for (const [key, value] of Object.entries(likelihoodMap)) {
        if (textLower.includes(key)) return value;
    }
    
    for (const [key, value] of Object.entries(consequenceMap)) {
        if (textLower.includes(key)) return value;
    }
    
    return '';
}

/**
 * Clear all rows from risk table
 */
function clearRiskTable() {
    const tableBody = document.getElementById('riskTableBody');
    tableBody.innerHTML = '';
    riskRowCounter = 0; // Reset counter to start from 1
    updateRiskSummary();
}

init();
</script>

</body>
</html>
